// Cloudflare Worker Ø¨Ø±Ø§ÛŒ Ø³ÛŒØ³ØªÙ… ÙØ±ÙˆØ´ Ø¢Ø²Ø§Ø¯ÛŒ VPN Ø¨Ø§ Ù¾Ù†Ù„ ÙˆØ¨ Ù…Ø¯ÛŒØ±ÛŒØª
const BOT_TOKEN = '8486172700:AAEHzmXgGE9DHKa0b76mQtR3O8Xp4gX_LuQ'; 
const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;
const ADMIN_ID = 6786448395;
const ADMIN_PASSWORD = 'matin778900';

// Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª
const PAYMENT_INFO = {
  cardNumber: '6037998221156739',
  cardHolder: 'Ù…Ø®ØªØ§Ø±ÛŒ',
  supportUsername: 'mykalikal'
};

// Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶
const DEFAULT_SERVERS = {
  'server_main': {
    id: 'server_main',
    name: 'Ø³Ø±ÙˆØ± Ø§ØµÙ„ÛŒ',
    baseUrl: 'https://pro.x2.goooooooozoooo.sbs',
    username: 'Hesamazadi',
    password: 'Hesamazadi123',
    isDefault: true,
    status: 'active',
    location: 'Ù…ÙˆÙ„ØªÛŒ Ù„ÙˆÚ©ÛŒØ´Ù† (Ø¨ÛŒØ´ Ø§Ø² 7 Ù„ÙˆÚ©ÛŒØ´Ù† Ø¯Ø± ÛŒÚ© Ø³Ø±ÙˆÛŒØ³)',
    description: 'Ø³Ø±ÙˆØ± Ø§ØµÙ„ÛŒ Ø¨Ø§ Ù¾Ø±Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§'
  }
};

// Ø¯Ø± DEFAULT_PLANS Ù‡Ø± Ù¾Ù„Ù† Ø¨Ø§ÛŒØ¯ order Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù‡
const DEFAULT_PLANS = {
  'plan_1m_50gb': {
    id: 'plan_1m_50gb',
    name: '1 Ù…Ø§Ù‡Ù‡ 50 Ú¯ÛŒÚ¯',
    duration: 30,
    dataLimit: 50,
    price: 25000,
    description: 'Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¹Ù…ÙˆÙ…ÛŒ',
    order: 1
  },
  'plan_1m_100gb': {
    id: 'plan_1m_100gb',
    name: '1 Ù…Ø§Ù‡Ù‡ 100 Ú¯ÛŒÚ¯', 
    duration: 30,
    dataLimit: 100,
    price: 45000,
    description: 'Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ØªÙˆØ³Ø·',
    order: 2
  },
  'plan_1m_unlimited': {
    id: 'plan_1m_unlimited',
    name: '1 Ù…Ø§Ù‡Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯',
    duration: 30,
    dataLimit: 0,
    price: 75000,
    description: 'Ø­Ø¬Ù… Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯',
    order: 3
  },
  'plan_3m_unlimited': {
    id: 'plan_3m_unlimited',
    name: '3 Ù…Ø§Ù‡Ù‡ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯',
    duration: 90,
    dataLimit: 0,
    price: 200000,
    description: 'Ø¨Ù‡ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª Ø¨Ø±Ø§ÛŒ 3 Ù…Ø§Ù‡',
    order: 4
  }
};

// Ú©Ù„Ø§Ø³ SafeKV Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ - Ù…Ø´Ú©Ù„ 12 Ø³Ø§Ø¹ØªÙ‡ Ø­Ù„ Ø´Ø¯Ù‡
class SafeKV {
  constructor(kv) {
    this.kv = kv;
    this.memoryStore = new Map();
    this.cache = new Map();
    this.cacheTimeout = 5 * 60 * 1000; // Ú©Ø§Ù‡Ø´ Ø¨Ù‡ 5 Ø¯Ù‚ÛŒÙ‚Ù‡
    this.maxCacheSize = 200; // Ú©Ø§Ù‡Ø´ Ø³Ø§ÛŒØ² cache
    this.maxMemorySize = 100; // Ú©Ø§Ù‡Ø´ memory store
    this.lastCleanup = Date.now();
    this.cleanupInterval = 30 * 60 * 1000; // Ø§ÙØ²Ø§ÛŒØ´ ÙØ§ØµÙ„Ù‡ cleanup Ø¨Ù‡ 30 Ø¯Ù‚ÛŒÙ‚Ù‡
    this.retryCount = 3;
    this.baseDelay = 1000;
  }

  cleanup() {
    const now = Date.now();
    
    // cleanup Ú©Ù…ØªØ± aggressive
    if (this.cache.size > this.maxCacheSize * 1.5) { // threshold Ø¨Ø§Ù„Ø§ØªØ±
      const entries = Array.from(this.cache.entries());
      entries.sort((a, b) => a[1].timestamp - b[1].timestamp);
      // ÙÙ‚Ø· Ù†ØµÙ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒÙ‡Ø§ Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
      const toDelete = Math.floor(entries.length - this.maxCacheSize);
      for (let i = 0; i < toDelete; i++) {
        this.cache.delete(entries[i][0]);
      }
    }
    
    // ÙÙ‚Ø· cache Ù‡Ø§ÛŒ Ø®ÛŒÙ„ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
    for (const [key, item] of this.cache.entries()) {
      if (now - item.timestamp > this.cacheTimeout * 2) { // Ø¯Ùˆ Ø¨Ø±Ø§Ø¨Ø± timeout
        this.cache.delete(key);
      }
    }
    
    this.lastCleanup = now;
  }

  async retryOperation(operation, retries = this.retryCount) {
    for (let i = 0; i < retries; i++) {
      try {
        return await operation();
      } catch (error) {
        console.error(`KV operation failed (attempt ${i + 1}/${retries}):`, error);
        
        if (i === retries - 1) {
          throw error;
        }
        
        // exponential backoff
        const delay = this.baseDelay * Math.pow(2, i);
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }

  async get(key, type = 'text') {
    // cleanup Ú©Ù…ØªØ±
    if (Date.now() - this.lastCleanup > this.cleanupInterval) {
      this.cleanup();
    }
    
    try {
      // Ø¨Ø±Ø§ÛŒ service Ù‡Ø§ cache Ù†Ú©Ù† ÛŒØ§ Ú©Ù…ØªØ± cache Ú©Ù†
      const isServiceKey = key.includes('service_');
      const cacheKey = `${key}_${type}`;
      
      if (!isServiceKey) {
        const cachedItem = this.cache.get(cacheKey);
        if (cachedItem && Date.now() - cachedItem.timestamp < this.cacheTimeout) {
          return type === 'json' ? JSON.parse(cachedItem.value || 'null') : cachedItem.value;
        }
      }

      let value;
      if (this.kv) {
        value = await this.retryOperation(async () => {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 20000); // timeout Ø¨ÛŒØ´ØªØ±
          
          try {
            const result = await this.kv.get(key, type);
            clearTimeout(timeoutId);
            return result;
          } catch (error) {
            clearTimeout(timeoutId);
            throw error;
          }
        });
      } else {
        const stored = this.memoryStore.get(key);
        value = type === 'json' ? JSON.parse(stored || 'null') : stored;
      }

      // ÙÙ‚Ø· ØºÛŒØ± service Ù‡Ø§ Ø±Ùˆ cache Ú©Ù†
      if (!isServiceKey && value !== null && value !== undefined) {
        if (this.cache.size >= this.maxCacheSize) {
          const firstKey = this.cache.keys().next().value;
          this.cache.delete(firstKey);
        }
        
        this.cache.set(cacheKey, {
          value: typeof value === 'string' ? value : JSON.stringify(value),
          timestamp: Date.now()
        });
      }

      return value;
    } catch (error) {
      console.error('KV get error:', error);
      
      // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ cache Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
      const cacheKey = `${key}_${type}`;
      this.cache.delete(cacheKey);
      
      // Ø§Ú¯Ø± service key Ù‡Ø³Øª Ùˆ KV Ú©Ø§Ø± Ù†Ù…ÛŒÚ©Ù†Ù‡ØŒ null Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†
      if (key.includes('service_')) {
        return null;
      }
      
      return null;
    }
  }

  async put(key, value) {
    try {
      const stringValue = typeof value === 'string' ? value : JSON.stringify(value);
      
      // cache Ø±Ùˆ ÙÙˆØ±ÛŒ Ù¾Ø§Ú© Ú©Ù†
      const cacheKeys = Array.from(this.cache.keys()).filter(k => k.startsWith(key));
      cacheKeys.forEach(k => this.cache.delete(k));
      
      if (this.kv) {
        const result = await this.retryOperation(async () => {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 25000); // timeout Ø¨ÛŒØ´ØªØ±
          
          try {
            const result = await this.kv.put(key, stringValue);
            clearTimeout(timeoutId);
            return result;
          } catch (error) {
            clearTimeout(timeoutId);
            throw error;
          }
        });
        return result;
      } else {
        if (this.memoryStore.size >= this.maxMemorySize) {
          const firstKey = this.memoryStore.keys().next().value;
          this.memoryStore.delete(firstKey);
        }
        this.memoryStore.set(key, stringValue);
        return true;
      }
    } catch (error) {
      console.error('KV put error:', error);
      return false;
    }
  }

  async delete(key) {
    try {
      // Ù‡Ù…Ù‡ cache Ù‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† key Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
      const cacheKeys = Array.from(this.cache.keys()).filter(k => k.startsWith(key));
      cacheKeys.forEach(k => this.cache.delete(k));
      
      if (this.kv) {
        return await this.retryOperation(async () => {
          return await this.kv.delete(key);
        });
      } else {
        this.memoryStore.delete(key);
        return true;
      }
    } catch (error) {
      console.error('KV delete error:', error);
      return false;
    }
  }

  async list(prefix, limit = 1000) {
    try {
      if (this.kv) {
        return await this.retryOperation(async () => {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000); // timeout Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ list
          
          try {
            const result = await this.kv.list({ prefix, limit });
            clearTimeout(timeoutId);
            return result;
          } catch (error) {
            clearTimeout(timeoutId);
            throw error;
          }
        });
      } else {
        const keys = Array.from(this.memoryStore.keys())
          .filter(key => key.startsWith(prefix))
          .slice(0, limit);
        return { keys: keys.map(name => ({ name })) };
      }
    } catch (error) {
      console.error('KV list error:', error);
      return { keys: [] };
    }
  }

  clearCache() {
    this.cache.clear();
    console.log('Cache cleared manually');
  }

  clearAll() {
    this.cache.clear();
    this.memoryStore.clear();
    console.log('All caches cleared');
  }

  // Ù…ØªØ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ clear Ú©Ø±Ø¯Ù† ÙÙ‚Ø· service cache Ù‡Ø§
  clearServiceCache() {
    const serviceKeys = Array.from(this.cache.keys()).filter(k => k.includes('service_'));
    serviceKeys.forEach(k => this.cache.delete(k));
    console.log(`Cleared ${serviceKeys.length} service cache entries`);
  }

  // Ù…ØªØ¯ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¢Ù…Ø§Ø±
  getStats() {
    return {
      cacheSize: this.cache.size,
      memoryStoreSize: this.memoryStore.size,
      lastCleanup: new Date(this.lastCleanup).toISOString()
    };
  }
}

// ØªØ§Ø¨Ø¹ Ø¯ÛŒØ¨Ø§Ú¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ KV
async function debugKVServices(chatId, kv) {
  if (!isAdmin(chatId)) return;
  
  try {
    console.log('Starting KV services debug...');
    
    // Ú¯Ø±ÙØªÙ† Ø¢Ù…Ø§Ø± KV
    const stats = kv.getStats();
    
    // ØªØ³Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ù„ÛŒØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    const allServicesResult = await kv.list('service_');
    console.log('All services found:', allServicesResult.keys.length);
    
    // ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ
    const userServicesResult = await kv.list(`service_${chatId}_`);
    console.log(`User ${chatId} services:`, userServicesResult.keys.length);
    
    // Ú†Ú© Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ Ø³Ø±ÙˆÛŒØ³
    const serviceDetails = [];
    for (const key of userServicesResult.keys.slice(0, 5)) {
      try {
        const service = await kv.get(key.name, 'json');
        serviceDetails.push({
          key: key.name,
          exists: !!service,
          serviceId: service?.serviceId,
          username: service?.username
        });
      } catch (e) {
        serviceDetails.push({
          key: key.name,
          exists: false,
          error: e.message
        });
      }
    }
    
    const debugText = `ğŸ” <b>Debug KV Services</b>

ğŸ“Š <b>Ø¢Ù…Ø§Ø± KV:</b>
â€¢ Cache Size: ${stats.cacheSize}
â€¢ Memory Store: ${stats.memoryStoreSize}  
â€¢ Last Cleanup: ${stats.lastCleanup}

ğŸ“‹ <b>Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:</b>
â€¢ Ú©Ù„ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§: ${allServicesResult.keys.length}
â€¢ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§: ${userServicesResult.keys.length}

ğŸ” <b>Ø¬Ø²Ø¦ÛŒØ§Øª Ù†Ù…ÙˆÙ†Ù‡:</b>
${serviceDetails.map(s => `â€¢ ${s.key}: ${s.exists ? 'âœ…' : 'âŒ'} ${s.username || s.error || ''}`).join('\n')}

â° <b>Ø²Ù…Ø§Ù† Ú†Ú©:</b> ${formatDateTime(Date.now())}`;

    const debugKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ—‘ï¸ Clear Service Cache', callback_data: 'debug_clear_service_cache' },
            { text: 'ğŸ”„ Clear All Cache', callback_data: 'debug_clear_all_cache' }
          ],
          [
            { text: 'ğŸ“± Ù†Ù…Ø§ÛŒØ´ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§', callback_data: 'my_services' }
          ],
          [
            { text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
          ]
        ]
      }
    };

    await sendMessage(chatId, debugText, debugKeyboard);
    
  } catch (error) {
    console.error('Debug KV error:', error);
    await sendMessage(chatId, `âŒ Ø®Ø·Ø§ Ø¯Ø± debug: ${error.message}`);
  }
}

// Ú©Ù„Ø§Ø³ API Ù…Ø±Ø²Ø¨Ø§Ù† Ø¨Ø§ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø³Ø±Ø¹Øª
class MarzbanAPI {
  constructor(baseUrl, token = null) {
    this.baseUrl = baseUrl.replace(/\/$/, '');
    this.token = token;
    this.apiPath = '/api';
    this.requestQueue = [];
    this.processing = false;
  }

  async request(endpoint, options = {}) {
    return new Promise((resolve, reject) => {
      this.requestQueue.push({ endpoint, options, resolve, reject });
      this.processQueue();
    });
  }

  async processQueue() {
    if (this.processing || this.requestQueue.length === 0) return;
    
    this.processing = true;
    
    const batch = this.requestQueue.splice(0, 10); // Ø§ÙØ²Ø§ÛŒØ´ Ø¨Ù‡ 10 Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù‡Ù…Ø²Ù…Ø§Ù†
    
    const promises = batch.map(async ({ endpoint, options, resolve, reject }) => {
      try {
        const result = await this.makeRequest(endpoint, options);
        resolve(result);
      } catch (error) {
        reject(error);
      }
    });

    await Promise.allSettled(promises);
    
    this.processing = false;
    
    // Ø§Ø¯Ø§Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
    if (this.requestQueue.length > 0) {
      setTimeout(() => this.processQueue(), 50); // Ú©Ø§Ù‡Ø´ ØªØ§Ø®ÛŒØ±
    }
  }

// ÙÙ‚Ø· Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø±Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†:
async makeRequest(endpoint, options = {}, retryCount = 0) {
  const url = `${this.baseUrl}${endpoint}`;
  const headers = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
    ...options.headers
  };

  if (this.token) {
    headers['Authorization'] = `Bearer ${this.token}`;
  }

  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); // Ø§ÙØ²Ø§ÛŒØ´ timeout

    const response = await fetch(url, {
      ...options,
      headers,
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    let data;
    const contentType = response.headers.get('content-type');
    
    if (contentType && contentType.includes('application/json')) {
      data = await response.json();
    } else {
      const text = await response.text();
      data = { message: text };
    }

    if (!response.ok) {
      let errorMessage = response.statusText;
      if (data.detail) {
        errorMessage = typeof data.detail === 'string' ? data.detail : JSON.stringify(data.detail);
      } else if (data.message) {
        errorMessage = typeof data.message === 'string' ? data.message : JSON.stringify(data.message);
      }
      throw new Error(`HTTP ${response.status}: ${errorMessage}`);
    }

    return { success: true, data };
  } catch (error) {
    console.error('Marzban API Error:', error);
    
    // Retry mechanism
    if (retryCount < 3 && (error.name === 'AbortError' || error.message.includes('timeout'))) {
      console.log(`Retrying request (${retryCount + 1}/3)`);
      await new Promise(resolve => setTimeout(resolve, 1000 * (retryCount + 1)));
      return this.makeRequest(endpoint, options, retryCount + 1);
    }
    
    if (error.name === 'AbortError') {
      return { success: false, error: 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.' };
    }
    return { success: false, error: error.message };
  }
}

  async login(username, password) {
    try {
      const result = await this.makeRequest(`${this.apiPath}/admin/token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ username, password })
      });

      if (result.success && result.data.access_token) {
        this.token = result.data.access_token;
        return { success: true, token: this.token };
      }

      return { success: false, error: result.error || 'Login failed' };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  async getUser(username) {
    return await this.request(`${this.apiPath}/user/${encodeURIComponent(username)}`);
  }

  async createUser(userData) {
    return await this.request(`${this.apiPath}/user`, {
      method: 'POST',
      body: JSON.stringify(userData)
    });
  }

  async modifyUser(username, userData) {
    return await this.request(`${this.apiPath}/user/${encodeURIComponent(username)}`, {
      method: 'PUT',
      body: JSON.stringify(userData)
    });
  }

  async deleteUser(username) {
    return await this.request(`${this.apiPath}/user/${encodeURIComponent(username)}`, {
      method: 'DELETE'
    });
  }

  async getUsers(offset = 0, limit = 100) {
    return await this.request(`${this.apiPath}/users?offset=${offset}&limit=${limit}`);
  }

  async getInbounds() {
    return await this.request(`${this.apiPath}/inbounds`);
  }

  async getSystemStats() {
    return await this.request(`${this.apiPath}/system`);
  }
}

// ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø¨Ø§ Ø²Ù…Ø§Ù† Ø§ÛŒØ±Ø§Ù†
function isAdmin(chatId) {
  return chatId === ADMIN_ID;
}

function formatPrice(price) {
  return new Intl.NumberFormat('fa-IR').format(price) + ' ØªÙˆÙ…Ø§Ù†';
}

function formatBytes(bytes) {
  if (!bytes || bytes === 0) return 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯';
  const gb = bytes / (1024 * 1024 * 1024);
  return gb.toFixed(1) + ' Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª';
}

function formatDate(timestamp) {
  if (!timestamp) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
  const date = new Date(timestamp);
  return date.toLocaleDateString('fa-IR', {
    timeZone: 'Asia/Tehran',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

function formatDateTime(timestamp) {
  if (!timestamp) return 'Ù†Ø§Ù…Ø´Ø®Øµ';
  const date = new Date(timestamp);
  return date.toLocaleString('fa-IR', {
    timeZone: 'Asia/Tehran',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

function generateUsername(chatId, planId) {
  const randomNumber = Math.random().toString().slice(2, 8); // 6 Ø±Ù‚Ù… ØªØµØ§Ø¯ÙÛŒ
  return `ARDISK-${randomNumber}`;
}

function generateOrderId() {
  return 'ORD_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5);
}

function generateServerId() {
  return 'server_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 3);
}

function generatePlanId() {
  return 'plan_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 3);
}

function generateTicketId() {
  return 'TKT_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 3);
}

// ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³
function generateServiceId() {
  return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 6);
}

// ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
function generateChargeId() {
  return 'CHG_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5);
}

// ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ ØªØ±Ø§Ú©Ù†Ø´
function generateTransactionId() {
  return 'TXN_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 5);
}

// Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function getWalletBalance(chatId, kv) {
  try {
    const balance = await kv.get(`wallet_balance_${chatId}`, 'json');
    return balance || 0;
  } catch (error) {
    return 0;
  }
}

// Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function updateWalletBalance(chatId, amount, kv) {
  try {
    const currentBalance = await getWalletBalance(chatId, kv);
    const newBalance = currentBalance + amount;
    await kv.put(`wallet_balance_${chatId}`, JSON.stringify(newBalance));
    return newBalance;
  } catch (error) {
    console.error('Error updating wallet balance:', error);
    return false;
  }
}

// Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function recordWalletTransaction(chatId, amount, type, description, kv) {
  try {
    const transactionId = generateTransactionId();
    const transaction = {
      id: transactionId,
      chatId: chatId,
      amount: amount,
      type: type, // 'charge', 'purchase', 'refund'
      description: description,
      timestamp: Date.now()
    };
    
    await kv.put(`wallet_transaction_${transactionId}`, JSON.stringify(transaction));
    return transactionId;
  } catch (error) {
    console.error('Error recording transaction:', error);
    return false;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙˆØ±Ù‡Ø§
async function getServers(kv) {
  try {
    const servers = await kv.get('system_servers', 'json');
    return servers || DEFAULT_SERVERS;
  } catch (error) {
    return DEFAULT_SERVERS;
  }
}

// Ø°Ø®ÛŒØ±Ù‡ Ø³Ø±ÙˆØ±Ù‡Ø§
async function saveServers(kv, servers) {
  try {
    await kv.put('system_servers', JSON.stringify(servers));
    return true;
  } catch (error) {
    console.error('Error saving servers:', error);
    return false;
  }
}

// Ø¯Ø±ÛŒØ§ÙØª Ø³Ø±ÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
async function getDefaultServer(kv) {
  try {
    const servers = await getServers(kv);
    return Object.values(servers).find(server => server.isDefault) || Object.values(servers)[0];
  } catch (error) {
    return Object.values(DEFAULT_SERVERS)[0];
  }
}

// Ø¯Ø±ÛŒØ§ÙØª Ù¾Ù„Ù†â€ŒÙ‡Ø§
async function getPlans(kv) {
  try {
    const plans = await kv.get('sales_plans', 'json');
    return plans || DEFAULT_PLANS;
  } catch (error) {
    return DEFAULT_PLANS;
  }
}

// Ø°Ø®ÛŒØ±Ù‡ Ù¾Ù„Ù†â€ŒÙ‡Ø§
async function savePlans(kv, plans) {
  try {
    await kv.put('sales_plans', JSON.stringify(plans));
    return true;
  } catch (error) {
    console.error('Error saving plans:', error);
    return false;
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø±ØªØ¨ Ø´Ø¯Ù‡
function getSortedPlans(plans) {
  return Object.values(plans).sort((a, b) => (a.order || 999) - (b.order || 999));
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬Ø¯Ø¯ order Ù¾Ù„Ù†â€ŒÙ‡Ø§
async function reorderPlans(planId, direction, kv) {
  try {
    const plans = await getPlans(kv);
    const sortedPlans = getSortedPlans(plans);
    const currentIndex = sortedPlans.findIndex(p => p.id === planId);
    
    if (currentIndex === -1) {
      return { success: false, error: 'Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯' };
    }
    
    let newIndex;
    if (direction === 'up' && currentIndex > 0) {
      newIndex = currentIndex - 1;
    } else if (direction === 'down' && currentIndex < sortedPlans.length - 1) {
      newIndex = currentIndex + 1;
    } else {
      return { success: false, error: 'Ø§Ù…Ú©Ø§Ù† Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯' };
    }
    
    // ØªØ¹ÙˆÛŒØ¶ order Ø¯Ùˆ Ù¾Ù„Ù†
    const temp = sortedPlans[currentIndex].order;
    sortedPlans[currentIndex].order = sortedPlans[newIndex].order;
    sortedPlans[newIndex].order = temp;
    
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    plans[sortedPlans[currentIndex].id] = sortedPlans[currentIndex];
    plans[sortedPlans[newIndex].id] = sortedPlans[newIndex];
    
    await savePlans(kv, plans);
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ order Ù¾Ù„Ù†â€ŒÙ‡Ø§
async function initializePlanOrders(kv) {
  try {
    const plans = await getPlans(kv);
    let hasChanges = false;
    let orderIndex = 1;
    
    // Ø§Ú¯Ø± Ù¾Ù„Ù†â€ŒÙ‡Ø§ order Ù†Ø¯Ø§Ø±Ù†ØŒ Ø¨Ù‡Ø´ÙˆÙ† order Ø¨Ø¯Ù‡
    Object.values(plans).forEach(plan => {
      if (!plan.order) {
        plan.order = orderIndex++;
        hasChanges = true;
      }
    });
    
    if (hasChanges) {
      await savePlans(kv, plans);
      console.log('Plan orders initialized');
    }
    
    return { success: true };
  } catch (error) {
    console.error('Error initializing plan orders:', error);
    return { success: false, error: error.message };
  }
}

// Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯
async function getInboundSettings(kv) {
  try {
    const settings = await kv.get('inbound_settings', 'json');
    return settings || { referenceUsername: null };
  } catch (error) {
    return { referenceUsername: null };
  }
}

// Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯
async function saveInboundSettings(kv, settings) {
  try {
    await kv.put('inbound_settings', JSON.stringify(settings));
    return true;
  } catch (error) {
    console.error('Error saving inbound settings:', error);
    return false;
  }
}

// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡
async function findServiceById(chatId, serviceId, kv) {
  try {
    console.log('Looking for service:', chatId, serviceId);
    
    // Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ú¯Ø±Ø¯ÛŒÙ…
    const directKey = `service_${chatId}_${serviceId}`;
    let serviceData = await kv.get(directKey, 'json');
    
    if (serviceData) {
      console.log('Found service with direct key:', directKey);
      return { key: directKey, data: serviceData };
    }

    // Ø§Ú¯Ø± Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø¯Ø± Ù‡Ù…Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ú¯Ø±Ø¯ÛŒÙ…
    const userServicesResult = await kv.list(`service_${chatId}_`);
    
    for (const key of userServicesResult.keys) {
      const data = await kv.get(key.name, 'json');
      if (data && data.serviceId === serviceId) {
        console.log('Found service with search:', key.name);
        return { key: key.name, data: data };
      }
    }

    console.log('Service not found');
    return null;
  } catch (error) {
    console.error('Error finding service:', error);
    return null;
  }
}

// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
async function findServiceByUsername(chatId, username, kv) {
  try {
    console.log('Looking for service by username:', chatId, username);
    
    // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ù…Ù‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
    const userServicesResult = await kv.list(`service_${chatId}_`);
    
    for (const key of userServicesResult.keys) {
      const data = await kv.get(key.name, 'json');
      if (data && data.username === username) {
        console.log('Found service by username:', key.name);
        return { key: key.name, data: data };
      }
    }

    console.log('Service not found by username');
    return null;
  } catch (error) {
    console.error('Error finding service by username:', error);
    return null;
  }
}

// Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ - Ù†Ø³Ø®Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡
async function checkExpiringServices(kv) {
  try {
    console.log('Starting advanced service expiry check...');
    const allServicesResult = await kv.list('service_');
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    const oneHourMs = 60 * 60 * 1000;
    
    for (const key of allServicesResult.keys) {
      const serviceData = await kv.get(key.name, 'json');
      if (!serviceData || serviceData.status !== 'active') continue;
      
      const timeUntilExpiry = serviceData.expireTimestamp - now;
      const hoursUntilExpiry = Math.ceil(timeUntilExpiry / oneHourMs);
      const daysUntilExpiry = Math.ceil(timeUntilExpiry / oneDayMs);
      
      // Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø®Ø±ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
      const lastNotificationKey = `notification_${serviceData.chatId}_${serviceData.serviceId}`;
      const lastNotification = await kv.get(lastNotificationKey, 'json') || {};
      
      // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ 1 Ø±ÙˆØ² Ù‚Ø¨Ù„ Ø§Ù†Ù‚Ø¶Ø§
      if (daysUntilExpiry === 1 && hoursUntilExpiry > 12 && !lastNotification.oneDayWarning) {
        await sendExpiryWarning(serviceData, 1, 'time', kv);
        lastNotification.oneDayWarning = now;
        await kv.put(lastNotificationKey, JSON.stringify(lastNotification));
      }
      
      // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ 6 Ø³Ø§Ø¹Øª Ù‚Ø¨Ù„ Ø§Ù†Ù‚Ø¶Ø§
      if (hoursUntilExpiry <= 6 && hoursUntilExpiry > 0 && !lastNotification.sixHourWarning) {
        await sendExpiryWarning(serviceData, 0, 'time_critical', kv);
        lastNotification.sixHourWarning = now;
        await kv.put(lastNotificationKey, JSON.stringify(lastNotification));
      }
      
      // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ù‚Ø¶Ø§
      if (daysUntilExpiry <= 0 && !lastNotification.expiredWarning) {
        await sendExpiryWarning(serviceData, 0, 'expired', kv);
        lastNotification.expiredWarning = now;
        await kv.put(lastNotificationKey, JSON.stringify(lastNotification));
      }

      // Ø¨Ø±Ø±Ø³ÛŒ Ø­Ø¬Ù… ØªØ±Ø§ÙÛŒÚ© Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ø´Ø¯
      if (serviceData.dataLimit && serviceData.dataLimit > 0) {
        await checkTrafficUsage(serviceData, lastNotification, lastNotificationKey, kv);
      }
    }
    
    console.log('Advanced expiry check completed');
  } catch (error) {
    console.error('Error in advanced expiry check:', error);
  }
}

// Ø¨Ø±Ø±Ø³ÛŒ Ù…ØµØ±Ù ØªØ±Ø§ÙÛŒÚ© Ø³Ø±ÙˆÛŒØ³
async function checkTrafficUsage(serviceData, lastNotification, notificationKey, kv) {
  try {
    const servers = await getServers(kv);
    const server = servers[serviceData.serverId];
    
    if (!server) return;

    const api = new MarzbanAPI(server.baseUrl);
    const loginResult = await api.login(server.username, server.password);
    
    if (!loginResult.success) return;

    const userResult = await api.getUser(serviceData.username);
    
    if (userResult.success && userResult.data) {
      const userData = userResult.data;
      const usedTraffic = userData.used_traffic || 0;
      const totalTraffic = userData.data_limit || (serviceData.dataLimit * 1024 * 1024 * 1024);
      
      if (totalTraffic > 0) {
        const usagePercent = (usedTraffic / totalTraffic) * 100;
        const now = Date.now();
        
        // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ 80% Ù…ØµØ±Ù
        if (usagePercent >= 80 && usagePercent < 95 && !lastNotification.traffic80Warning) {
          await sendTrafficWarning(serviceData, usagePercent, usedTraffic, totalTraffic, '80', kv);
          lastNotification.traffic80Warning = now;
          await kv.put(notificationKey, JSON.stringify(lastNotification));
        }
        
        // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ 95% Ù…ØµØ±Ù
        if (usagePercent >= 95 && usagePercent < 100 && !lastNotification.traffic95Warning) {
          await sendTrafficWarning(serviceData, usagePercent, usedTraffic, totalTraffic, '95', kv);
          lastNotification.traffic95Warning = now;
          await kv.put(notificationKey, JSON.stringify(lastNotification));
        }
        
        // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù† Ø­Ø¬Ù…
        if (usagePercent >= 100 && !lastNotification.trafficFinished) {
          await sendTrafficWarning(serviceData, 100, usedTraffic, totalTraffic, '100', kv);
          lastNotification.trafficFinished = now;
          await kv.put(notificationKey, JSON.stringify(lastNotification));
        }
      }
    }
  } catch (error) {
    console.error('Error checking traffic usage:', error);
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø§Ù†Ù‚Ø¶Ø§ - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
async function sendExpiryWarning(serviceData, daysLeft, type, kv) {
  try {
    let warningText;
    let keyboardButtons;
    
    if (type === 'time_critical') {
      warningText = `ğŸš¨ <b>Ù‡Ø´Ø¯Ø§Ø± ÙÙˆØ±ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
â° Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: Ú©Ù…ØªØ± Ø§Ø² 6 Ø³Ø§Ø¹Øª
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}

ğŸ”´ <b>ÙÙˆØ±ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯!</b> Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§ Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.

ğŸ’¡ <b>ØªÙˆØ¬Ù‡:</b> Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†Ù‚Ø¶Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ”¥ ØªÙ…Ø¯ÛŒØ¯ ÙÙˆØ±ÛŒ', callback_data: `renew_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ“± Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
      ];
    } else if (daysLeft === 1) {
      warningText = `âš ï¸ <b>ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
â° Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: 1 Ø±ÙˆØ²
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}

ğŸ”„ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ØŒ Ø³Ø±ÙˆÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.

ğŸ’¡ <b>Ù†Ú©ØªÙ‡:</b> Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†Ù‚Ø¶Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ’ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: `renew_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ“± Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceData.serviceId}` }]
      ];
    } else {
      warningText = `âŒ <b>Ø³Ø±ÙˆÛŒØ³ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}

ğŸš« Ø¯Ø³ØªØ±Ø³ÛŒ Ø´Ù…Ø§ Ù‚Ø·Ø¹ Ø´Ø¯Ù‡ Ø§Ø³Øª.

ğŸ”„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø³ØªØ±Ø³ÛŒØŒ Ø³Ø±ÙˆÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ’ ØªÙ…Ø¯ÛŒØ¯ ÙÙˆØ±ÛŒ', callback_data: `renew_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø¬Ø¯ÛŒØ¯', callback_data: 'buy_service' }],
        [{ text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
      ];
    }

    const keyboard = {
      reply_markup: {
        inline_keyboard: keyboardButtons
      }
    };

    await sendMessage(serviceData.chatId, warningText, keyboard);
    
  } catch (error) {
    console.error('Error sending expiry warning:', error);
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø­Ø¬Ù… ØªØ±Ø§ÙÛŒÚ©
async function sendTrafficWarning(serviceData, usagePercent, usedTraffic, totalTraffic, level, kv) {
  try {
    let warningText;
    let keyboardButtons;
    
    if (level === '80') {
      warningText = `ğŸ“Š <b>Ù‡Ø´Ø¯Ø§Ø± Ù…ØµØ±Ù Ø­Ø¬Ù…</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${formatBytes(usedTraffic)} Ø§Ø² ${formatBytes(totalTraffic)}
ğŸ’¯ Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù: ${usagePercent.toFixed(1)}%

âš ï¸ <b>80% Ø­Ø¬Ù… Ø´Ù…Ø§ Ù…ØµØ±Ù Ø´Ø¯Ù‡!</b>

ğŸ’¡ ØªÙˆØµÛŒÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‚Ø·Ø¹ÛŒØŒ Ø³Ø±ÙˆÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª', callback_data: `traffic_usage_${serviceData.serviceId}` }],
        [{ text: 'ğŸ’ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: `renew_service_${serviceData.serviceId}` }]
      ];
    } else if (level === '95') {
      warningText = `ğŸš¨ <b>Ù‡Ø´Ø¯Ø§Ø± ÙÙˆØ±ÛŒ Ù…ØµØ±Ù Ø­Ø¬Ù…</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${formatBytes(usedTraffic)} Ø§Ø² ${formatBytes(totalTraffic)}
ğŸ’¯ Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù: ${usagePercent.toFixed(1)}%

ğŸ”´ <b>95% Ø­Ø¬Ù… Ø´Ù…Ø§ Ù…ØµØ±Ù Ø´Ø¯Ù‡!</b>

âš ï¸ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‚Ø·Ø¹ÛŒ ÙÙˆØ±ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ”¥ ØªÙ…Ø¯ÛŒØ¯ ÙÙˆØ±ÛŒ', callback_data: `renew_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
      ];
    } else {
      warningText = `âŒ <b>Ø­Ø¬Ù… Ø³Ø±ÙˆÛŒØ³ ØªÙ…Ø§Ù… Ø´Ø¯</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${formatBytes(usedTraffic)}
ğŸ’¯ Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù: 100%

ğŸš« Ø­Ø¬Ù… Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ù‚Ø·Ø¹ Ø´Ø¯Ù‡ Ø§Ø³Øª.

ğŸ”„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø³ØªØ±Ø³ÛŒØŒ Ø³Ø±ÙˆÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯.`;

      keyboardButtons = [
        [{ text: 'ğŸ’ ØªÙ…Ø¯ÛŒØ¯ ÙÙˆØ±ÛŒ', callback_data: `renew_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø­Ø¬Ù… Ø§Ø¶Ø§ÙÛŒ', callback_data: 'buy_service' }],
        [{ text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
      ];
    }

    const keyboard = {
      reply_markup: {
        inline_keyboard: keyboardButtons
      }
    };

    await sendMessage(serviceData.chatId, warningText, keyboard);
    
  } catch (error) {
    console.error('Error sending traffic warning:', error);
  }
}

// Ø¯Ø± main keyboard
const KEYBOARDS = {
  main: {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: 'buy_service' },
          { text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }
        ],
        [
          { text: 'ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_menu' },
          { text: 'ğŸ« Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }
        ],
        [
          { text: 'ğŸ“– Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„', callback_data: 'connection_guide' },
          { text: 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ', callback_data: 'user_account' }
        ],
        [
          { text: 'ğŸŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ØªØ§Ù„ Ù…Ø´ØªØ±ÛŒØ§Ù†', web_app: { url: 'https://ardiskminiapp.matinder.workers.dev/' } }
        ]
      ]
    }
  },

  adminMain: {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: 'buy_service' },
          { text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }
        ],
        [
          { text: 'ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_menu' },
          { text: 'ğŸ« Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }
        ],
        [
          { text: 'ğŸ“– Ù†Ø­ÙˆÙ‡ Ø§ØªØµØ§Ù„', callback_data: 'connection_guide' },
          { text: 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ', callback_data: 'user_account' }
        ],
        [
          { text: 'ğŸŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ø±ØªØ§Ù„ Ù…Ø´ØªØ±ÛŒØ§Ù†', web_app: { url: 'https://ardiskminiapp.matinder.workers.dev/' } }
        ],
        [
          { text: 'âš™ï¸ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
        ]
      ]
    }
  },

  supportMenu: {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ« Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯', callback_data: 'create_ticket' },
          { text: 'ğŸ“‚ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_tickets' }
        ],
        [
          { text: 'â“ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„', callback_data: 'faq' }
        ],
        [
          { text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
        ]
      ]
    }
  },

  walletMenu: {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_charge' },
          { text: 'ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡', callback_data: 'wallet_balance' }
        ],
        [
          { text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
        ]
      ]
    }
  },

  backToMain: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
      ]
    }
  },

  backToSupport: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }]
      ]
    }
  },

  backToWallet: {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”™ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_menu' }]
      ]
    }
  }
};

// Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡
async function sendMessage(chatId, text, options = {}) {
  try {
    const url = `${TELEGRAM_API}/sendMessage`;
    const payload = {
      chat_id: chatId,
      text: text,
      parse_mode: 'HTML',
      ...options
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return await response.json();
  } catch (error) {
    console.error('Send message error:', error);
    return { ok: false, description: error.message };
  }
}

// ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡
async function editMessage(chatId, messageId, text, options = {}) {
  try {
    const url = `${TELEGRAM_API}/editMessageText`;
    const payload = {
      chat_id: chatId,
      message_id: messageId,
      text: text,
      parse_mode: 'HTML',
      ...options
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return await response.json();
  } catch (error) {
    console.error('Edit message error:', error);
    return { ok: false, description: error.message };
  }
}

// Ø­Ø°Ù Ù¾ÛŒØ§Ù…
async function deleteMessage(chatId, messageId) {
  try {
    const url = `${TELEGRAM_API}/deleteMessage`;
    const payload = {
      chat_id: chatId,
      message_id: messageId
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return await response.json();
  } catch (error) {
    console.error('Delete message error:', error);
    return { ok: false, description: error.message };
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³
async function sendPhoto(chatId, photoUrl, caption = '', options = {}) {
  try {
    const url = `${TELEGRAM_API}/sendPhoto`;
    const payload = {
      chat_id: chatId,
      photo: photoUrl,
      caption: caption,
      parse_mode: 'HTML',
      ...options
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return await response.json();
  } catch (error) {
    console.error('Send photo error:', error);
    return { ok: false, description: error.message };
  }
}

// ÙÙˆØ±ÙˆØ§Ø±Ø¯ Ù¾ÛŒØ§Ù…
async function forwardMessage(chatId, fromChatId, messageId) {
  try {
    const url = `${TELEGRAM_API}/forwardMessage`;
    const payload = {
      chat_id: chatId,
      from_chat_id: fromChatId,
      message_id: messageId
    };
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    return await response.json();
  } catch (error) {
    console.error('Forward message error:', error);
    return { ok: false, description: error.message };
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
async function showMainMenu(chatId, messageId = null, kv) {
  const welcomeText = `ğŸ›œ <b>ARDISK VPN
â¬…ï¸ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¢Ø±Ø¯ÛŒØ³Ú© ÙˆÛŒ Ù¾ÛŒ Ø§Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</b>

ğŸ’ Ø§Ø±Ø§Ø¦Ù‡ ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ù…ÙˆÙ„ØªÛŒ Ù„ÙˆÚ©ÛŒØ´Ù†(Ø¨ÛŒØ´ Ø§Ø² 7 Ù„ÙˆÚ©ÛŒØ´Ù†) Ù¾Ø±Ø³Ø±Ø¹Øª
ğŸ”’ Ø§Ù…Ù†ÛŒØª Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ Ùˆ ÙØ¶Ø§ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡
ğŸŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹ Ùˆ Ø¨Ø¯ÙˆÙ† Ù‚Ø·Ø¹ÛŒ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¢Ø²Ø§Ø¯
ğŸ‘¨â€ğŸ’»Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @mykalikal

ğŸ¯ <b>Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯:</b>`;
  
  const keyboard = isAdmin(chatId) ? KEYBOARDS.adminMain : KEYBOARDS.main;
  
  if (messageId) {
    await editMessage(chatId, messageId, welcomeText, keyboard);
  } else {
    await sendMessage(chatId, welcomeText, keyboard);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function showWalletMenu(chatId, messageId, kv) {
  try {
    const balance = await getWalletBalance(chatId, kv);
    
    const walletText = `ğŸ’° <b>Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ù†</b>

ğŸ’³ <b>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ:</b> ${formatPrice(balance)}

ğŸ”§ <b>Ø¹Ù…Ù„ÛŒØ§Øª:</b>`;

    await editMessage(chatId, messageId, walletText, KEYBOARDS.walletMenu);

  } catch (error) {
    console.error('Error showing wallet menu:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ú©ÛŒÙ Ù¾ÙˆÙ„.', KEYBOARDS.backToMain);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function showWalletBalance(chatId, messageId, kv) {
  try {
    const balance = await getWalletBalance(chatId, kv);
    
    // Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§
    const transactionsResult = await kv.list('wallet_transaction_');
    const userTransactions = [];
    
    for (const key of transactionsResult.keys) {
      const transaction = await kv.get(key.name, 'json');
      if (transaction && transaction.chatId === chatId) {
        userTransactions.push(transaction);
      }
    }
    
    userTransactions.sort((a, b) => b.timestamp - a.timestamp);
    const recentTransactions = userTransactions.slice(0, 10);
    
    let balanceText = `ğŸ’° <b>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„</b>

ğŸ’³ <b>Ù…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ:</b> ${formatPrice(balance)}

ğŸ“Š <b>Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:</b>

`;

    if (recentTransactions.length === 0) {
      balanceText += 'âŒ Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯';
    } else {
      recentTransactions.forEach((transaction, index) => {
        const typeEmoji = transaction.type === 'charge' ? 'ğŸ“ˆ' : 
                         transaction.type === 'purchase' ? 'ğŸ“‰' : 'ğŸ”„';
        const typeText = transaction.type === 'charge' ? 'Ø´Ø§Ø±Ú˜' :
                        transaction.type === 'purchase' ? 'Ø®Ø±ÛŒØ¯' : 'Ø¨Ø§Ø²Ú¯Ø´Øª';
        
        balanceText += `${index + 1}ï¸âƒ£ ${typeEmoji} ${typeText}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(Math.abs(transaction.amount))}
ğŸ“ ØªÙˆØ¶ÛŒØ­: ${transaction.description}
ğŸ“… ØªØ§Ø±ÛŒØ®: ${formatDateTime(transaction.timestamp)}

`;
      });
    }

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_charge' }],
          [{ text: 'ğŸ”™ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_menu' }]
        ]
      }
    };

    await editMessage(chatId, messageId, balanceText, keyboard);

  } catch (error) {
    console.error('Error showing wallet balance:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ.', KEYBOARDS.backToWallet);
  }
}

// Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function showWalletCharge(chatId, messageId, kv) {
  const chargeText = `ğŸ’³ <b>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„</b>

Ù„Ø·ÙØ§Ù‹ Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:

ğŸ’¡ <b>Ø±Ø§Ù‡Ù†Ù…Ø§:</b>
â€¢ Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø§Ø±Ú˜: 10,000 ØªÙˆÙ…Ø§Ù†
â€¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø´Ø§Ø±Ú˜: 5,000,000 ØªÙˆÙ…Ø§Ù†
â€¢ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ (Ù…Ø«Ø§Ù„: 50000)

ğŸ“¤ <b>Ù…Ù†ØªØ¸Ø± Ù…Ø¨Ù„Øº Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...</b>`;

  // Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¨Ù„Øº
  await kv.put(`waiting_charge_amount_${chatId}`, JSON.stringify({
    chatId: chatId,
    messageId: messageId,
    timestamp: Date.now()
  }));

  await editMessage(chatId, messageId, chargeText, KEYBOARDS.backToWallet);
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜
async function processChargeAmount(chatId, messageText, kv) {
  const waitingData = await kv.get(`waiting_charge_amount_${chatId}`, 'json');
  
  if (!waitingData) {
    return; // Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜
  }

  const amount = parseInt(messageText.replace(/[,\s]/g, ''));
  
  if (isNaN(amount)) {
    await sendMessage(chatId, 'âŒ Ù„Ø·ÙØ§Ù‹ ÙÙ‚Ø· Ø¹Ø¯Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!\n\nÙ…Ø«Ø§Ù„: 50000');
    return;
  }

  if (amount < 10000) {
    await sendMessage(chatId, 'âŒ Ø­Ø¯Ø§Ù‚Ù„ Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ 10,000 ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª!');
    return;
  }

  if (amount > 5000000) {
    await sendMessage(chatId, 'âŒ Ø­Ø¯Ø§Ú©Ø«Ø± Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜ 5,000,000 ØªÙˆÙ…Ø§Ù† Ø§Ø³Øª!');
    return;
  }

  // Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜
  const chargeId = generateChargeId();
  const chargeData = {
    id: chargeId,
    chatId: chatId,
    amount: amount,
    status: 'waiting_payment',
    createdAt: Date.now(),
    expiresAt: Date.now() + (30 * 60 * 1000) // 30 Ø¯Ù‚ÛŒÙ‚Ù‡
  };

  await kv.put(`wallet_charge_${chargeId}`, JSON.stringify(chargeData));
  await kv.put(`user_charge_${chatId}`, chargeId);
  await kv.delete(`waiting_charge_amount_${chatId}`);

  const paymentText = `ğŸ’³ <b>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„</b>

ğŸ’° Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜: ${formatPrice(amount)}
ğŸ†” Ú©Ø¯ Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>

ğŸ’³ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±ÛŒØ²:</b>
ğŸ¦ Ú©Ø§Ø±Øª: <code>${PAYMENT_INFO.cardNumber}</code>
ğŸ‘¤ Ù†Ø§Ù…: ${PAYMENT_INFO.cardHolder}

ğŸ“‹ <b>Ù…Ø±Ø§Ø­Ù„:</b>
1ï¸âƒ£ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯
2ï¸âƒ£ "Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…" Ø¨Ø²Ù†ÛŒØ¯  
3ï¸âƒ£ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
4ï¸âƒ£ ØªØ§ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø´ÛŒØ¯

âš ï¸ Ø¯Ø±Ø®ÙˆØ§Ø³Øª 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±Ø¯`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…', callback_data: 'upload_charge_receipt' }],
        [{ text: 'âŒ Ø§Ù†ØµØ±Ø§Ù', callback_data: 'cancel_charge' }]
      ]
    }
  };

  await sendMessage(chatId, paymentText, keyboard);
}

// Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜
async function handleUploadChargeReceipt(chatId, messageId, kv) {
  const userCharge = await kv.get(`user_charge_${chatId}`);
  
  if (!userCharge) {
    await editMessage(chatId, messageId, 'âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToWallet);
    return;
  }

  const chargeData = await kv.get(`wallet_charge_${userCharge}`, 'json');
  if (!chargeData || chargeData.expiresAt < Date.now()) {
    await kv.delete(`user_charge_${chatId}`);
    await editMessage(chatId, messageId, 
      'âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ù‡ÛŒØ¯.',
      KEYBOARDS.backToWallet
    );
    return;
  }

  const uploadText = `ğŸ“„ <b>Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${userCharge}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ“± <b>Ù†Ø­ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„:</b>
â€¢ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ø¨Ø§Ù†Ú©ÛŒ Ø¨ÙØ±Ø³ØªÛŒØ¯
â€¢ ÛŒØ§ ÙØ§ÛŒÙ„ PDF Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
â€¢ Ø±Ø³ÛŒØ¯ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø¶Ø­ Ø¨Ø§Ø´Ø¯

â±ï¸ Ø¨Ø±Ø±Ø³ÛŒ: Ø­Ø¯Ø§Ú©Ø«Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
ğŸ“¤ <b>Ù…Ù†ØªØ¸Ø± Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...</b>`;

  await editMessage(chatId, messageId, uploadText, KEYBOARDS.backToWallet);
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜
async function processChargeReceiptUpload(chatId, messageData, kv) {
  const userCharge = await kv.get(`user_charge_${chatId}`);
  
  if (!userCharge) {
    await sendMessage(chatId, 
      'âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!\n\nØ§Ø¨ØªØ¯Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ú©Ù†ÛŒØ¯.',
      KEYBOARDS.backToWallet
    );
    return;
  }

  const chargeData = await kv.get(`wallet_charge_${userCharge}`, 'json');
  
  if (!chargeData) {
    await sendMessage(chatId, 'âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø§Ø±Ú˜ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToWallet);
    return;
  }

  if (chargeData.expiresAt < Date.now()) {
    await kv.delete(`user_charge_${chatId}`);
    await sendMessage(chatId, 
      'âŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ø§Ø±Ú˜ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ù‡ÛŒØ¯.',
      KEYBOARDS.backToWallet
    );
    return;
  }

  chargeData.status = 'payment_submitted';
  chargeData.paymentSubmittedAt = Date.now();
  chargeData.receiptData = messageData;
  await kv.put(`wallet_charge_${userCharge}`, JSON.stringify(chargeData));

  await notifyAdminNewChargePayment(chargeData, messageData);

  const confirmText = `âœ… <b>Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${userCharge}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ” Ø±Ø³ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯
â±ï¸ Ø²Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ: Ø­Ø¯Ø§Ú©Ø«Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

  await sendMessage(chatId, confirmText, KEYBOARDS.backToWallet);
}

// Ù†Ù…Ø§ÛŒØ´ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ
// Ù†Ù…Ø§ÛŒØ´ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ - Ù†Ø³Ø®Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡
async function showUserAccount(chatId, messageId, kv) {
  try {
    // Ù†Ù…Ø§ÛŒØ´ loading
    await editMessage(chatId, messageId, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...', {});

    const balance = await getWalletBalance(chatId, kv);
    
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙˆØ§Ø²ÛŒ
    const [servicesResult, ordersResult, ticketsResult] = await Promise.all([
      kv.list(`service_${chatId}_`),
      kv.list('order_ORD_'),
      kv.list(`ticket_${chatId}_`)
    ]);
    
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    
    // Ø¢Ù…Ø§Ø± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    let activeServices = 0;
    let expiredServices = 0;
    let nearExpiry = 0;
    
    // ÙÙ‚Ø· Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†
    const servicePromises = servicesResult.keys.slice(0, 20).map(async (key) => {
      try {
        const service = await kv.get(key.name, 'json');
        if (service) {
          if (service.expireTimestamp > now) {
            activeServices++;
            const daysLeft = Math.ceil((service.expireTimestamp - now) / oneDayMs);
            if (daysLeft <= 7) nearExpiry++;
          } else {
            expiredServices++;
          }
        }
      } catch (e) {
        console.error('Error processing service:', e);
      }
    });
    
    await Promise.allSettled(servicePromises);
    
    // Ø¢Ù…Ø§Ø± Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ - ÙÙ‚Ø· 50 ØªØ§ÛŒ Ø¢Ø®Ø±
    let totalOrders = 0;
    let completedOrders = 0;
    let totalSpent = 0;
    
    const orderPromises = ordersResult.keys.slice(0, 50).map(async (key) => {
      try {
        const order = await kv.get(key.name, 'json');
        if (order && order.chatId === chatId) {
          totalOrders++;
          if (order.status === 'completed') {
            completedOrders++;
            totalSpent += order.plan.price;
          }
        }
      } catch (e) {
        console.error('Error processing order:', e);
      }
    });
    
    await Promise.allSettled(orderPromises);
    
    // Ø¢Ù…Ø§Ø± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
    let totalTickets = 0;
    let openTickets = 0;
    
    const ticketPromises = ticketsResult.keys.map(async (key) => {
      try {
        const ticket = await kv.get(key.name, 'json');
        if (ticket) {
          totalTickets++;
          if (ticket.status === 'open') openTickets++;
        }
      } catch (e) {
        console.error('Error processing ticket:', e);
      }
    });
    
    await Promise.allSettled(ticketPromises);
    
    const accountText = `ğŸ‘¤ <b>Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ</b>

ğŸ†” <b>Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ:</b> <code>${chatId}</code>

ğŸ’° <b>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:</b> ${formatPrice(balance)}

ğŸ“Š <b>Ø®Ù„Ø§ØµÙ‡ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:</b>
â€¢ ÙØ¹Ø§Ù„: ${activeServices} Ø¹Ø¯Ø¯
â€¢ Ù…Ù†Ù‚Ø¶ÛŒ: ${expiredServices} Ø¹Ø¯Ø¯
â€¢ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø§Ù†Ù‚Ø¶Ø§: ${nearExpiry} Ø¹Ø¯Ø¯

ğŸ’° <b>Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ:</b>
â€¢ Ú©Ù„ Ø®Ø±ÛŒØ¯: ${formatPrice(totalSpent)}
â€¢ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: ${completedOrders} Ø§Ø² ${totalOrders}

ğŸ« <b>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b>
â€¢ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²: ${openTickets} Ø¹Ø¯Ø¯
â€¢ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: ${totalTickets} Ø¹Ø¯Ø¯

ğŸ“… <b>Ø¹Ø¶ÙˆÛŒØª:</b> ÙØ¹Ø§Ù„`;

    const accountKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§', callback_data: 'my_services' },
            { text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø¬Ø¯ÛŒØ¯', callback_data: 'buy_service' }
          ],
          [
            { text: 'ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_menu' },
            { text: 'ğŸ« Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }
          ],
          [
            { text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
          ]
        ]
      }
    };

    await editMessage(chatId, messageId, accountText, accountKeyboard);

  } catch (error) {
    console.error('Error showing user account:', error);
    await editMessage(chatId, messageId, 
      'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ.\n\nØ¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 
      KEYBOARDS.backToMain
    );
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ
async function showSupportMenu(chatId, messageId, kv) {
  const supportText = `ğŸ« <b>Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</b>

ğŸ’¬ <b>Ø±Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b>

ğŸ“± ØªÙ„Ú¯Ø±Ø§Ù…: @${PAYMENT_INFO.supportUsername}

ğŸ”§ <b>Ø®Ø¯Ù…Ø§Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b>
â€¢ Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª ÙÙ†ÛŒ
â€¢ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒÛŒ Ù†ØµØ¨ Ùˆ Ø§ØªØµØ§Ù„
â€¢ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡

ğŸ¯ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</b>`;

  await editMessage(chatId, messageId, supportText, KEYBOARDS.supportMenu);
}

// Ù†Ù…Ø§ÛŒØ´ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„
async function showFAQ(chatId, messageId) {
  const faqText = `â“ <b>Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„</b>

ğŸ”µ <b>Ø¢ÛŒØ§ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø§Ø±Ù…ØŸ</b>
âœ… Ø¨Ù„Ù‡ØŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø§Ø±ÛŒØ¯ ØªØ§ Ù„Ø­Ø¸Ù‡ Ø¢Ø®Ø±. ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø§ 24 Ø³Ø§Ø¹ØªÙ‡ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§Ø³Øª.

ğŸ”µ <b>Ø¢ÛŒ Ù¾ÛŒ Ø«Ø§Ø¨Øª Ø§Ø³ØªØŸ</b>
âœ… Ø¨Ù„Ù‡ØŒ Ù‡Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯Ø§Ø±Ø§ÛŒ Ø¢ÛŒ Ù¾ÛŒ Ø«Ø§Ø¨Øª Ùˆ Ø§Ø®ØªØµØ§ØµÛŒ Ø§Ø³Øª Ú©Ù‡ ØªØ§ Ù¾Ø§ÛŒØ§Ù† Ù…Ø¯Øª Ø§Ø´ØªØ±Ø§Ú© ØªØºÛŒÛŒØ± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.

ğŸ”µ <b>Ø¢ÛŒØ§ ÙˆØ§Ù‚Ø¹Ø§ ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø§Ø³ØªØŸ</b>
âœ… Ø¨Ù„Ù‡ØŒ Ø³Ø±ÙˆÛŒØ³ Ù…Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø¶Ø¯ÙÛŒÙ„ØªØ± Ùˆ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¢Ø²Ø§Ø¯ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.

ğŸ”µ <b>Ø³Ø±Ø¹Øª Ø§ØªØµØ§Ù„ Ú†Ø·ÙˆØ± Ø§Ø³ØªØŸ</b>
âœ… Ø³Ø±Ø¹Øª Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§ Ø¨Ø§ Ú©Ù…ØªØ±ÛŒÙ† ØªØ§Ø®ÛŒØ±. Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø§ Ø¯Ø± Ø¨Ù‡ØªØ±ÛŒÙ† Ù…Ø±Ø§Ú©Ø² Ø¯Ø§Ø¯Ù‡ Ø¬Ù‡Ø§Ù† Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ù†Ø¯.

ğŸ”µ <b>Ø±ÙˆÛŒ Ú†Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ</b>
âœ… Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ØŒ Ø¢ÛŒÙÙˆÙ†ØŒ ÙˆÛŒÙ†Ø¯ÙˆØ²ØŒ Ù…Ú© Ùˆ Ù‡Ù…Ù‡ Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

ğŸ”µ <b>Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ù‡Ù…Ø²Ù…Ø§Ù† Ø¯Ø§Ø±Ø¯ØŸ</b>
âœ… Ù‡Ø± Ø§Ø´ØªØ±Ø§Ú© Ø±ÙˆÛŒ Ø¨ÛŒØ´ Ø§Ø² 2 ØªØ§ 10 Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù‡Ù…Ø²Ù…Ø§Ù† Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª.

ğŸ”µ <b>Ø¯Ø± ØµÙˆØ±Øª Ù‚Ø·Ø¹ÛŒ Ú†Ù‡ Ú©Ù†Ù…ØŸ</b>
âœ… Ø³Ø±ÙˆÛŒØ³ Ù…Ø§ 99.9% Ø¢Ù¾ØªØ§ÛŒÙ… Ø¯Ø§Ø±Ø¯. Ø¯Ø± Ù…ÙˆØ§Ø±Ø¯ Ù†Ø§Ø¯Ø±ØŒ ÙÙˆØ±Ø§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.

ğŸ”µ <b>Ø¢ÛŒØ§ Ù„Ø§Ú¯ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ</b>
âœ… Ø®ÛŒØ±ØŒ Ù‡ÛŒÚ† Ù„Ø§Ú¯ Ùˆ Ø±Ø¯ÛŒ Ø§Ø² ÙØ¹Ø§Ù„ÛŒØª Ø´Ù…Ø§ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ø´Ù…Ø§ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª.

ğŸ’¬ <b>Ø³ÙˆØ§Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ</b>
Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§Ø´ÛŒØ¯: @${PAYMENT_INFO.supportUsername}`;

  const faqKeyboard = {
    reply_markup: {
      inline_keyboard: [
        [
          { text: 'ğŸ« Ø«Ø¨Øª ØªÛŒÚ©Øª', callback_data: 'create_ticket' },
          { text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }
        ],
        [
          { text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }
        ]
      ]
    }
  };

  await editMessage(chatId, messageId, faqText, faqKeyboard);
}

// Ù†Ù…Ø§ÛŒØ´ Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯
async function showBuyService(chatId, messageId, kv) {
  const plans = await getPlans(kv);
  
  let plansText = `ğŸ›’ <b>Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯</b>

âœ¨ <b>Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø¹Ø§Ù„ÛŒ Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±</b>
ğŸŒ <b>Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ÛŒÙ†Ù‡ Ø¯Ø± Ø´Ø±Ø§ÛŒØ· Ø§ÛŒÙ†ØªØ±Ù†Øª Ù…Ù„ÛŒ</b>
ğŸ‘¥ <b>Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±</b>
ğŸ”’ <b>Ø§Ù…Ù†ÛŒØª Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø¨Ø§Ù„Ø§</b>

ğŸ’ <b>Ù¾Ù„Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</b>

`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: []
    }
  };

  // ğŸ‘‡ Ø§ÛŒÙ† Ø®Ø· Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡ ğŸ‘‡
  getSortedPlans(plans).forEach((plan) => {
    keyboard.reply_markup.inline_keyboard.push([{
      text: `${plan.name}`,
      callback_data: `select_plan_${plan.id}`
    }]);
  });
  
  keyboard.reply_markup.inline_keyboard.push([{
    text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ',
    callback_data: 'start'
  }]);

  await editMessage(chatId, messageId, plansText, keyboard);
}

// Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ù„Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
async function showPlanDetails(chatId, messageId, planId, kv) {
  const plans = await getPlans(kv);
  const plan = plans[planId];
  
  if (!plan) {
    await editMessage(chatId, messageId, 'âŒ Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
    return;
  }

  const defaultServer = await getDefaultServer(kv);
  
  await kv.put(`selected_plan_${chatId}`, JSON.stringify({
    planId: planId,
    plan: plan,
    serverId: defaultServer.id,
    serverName: defaultServer.name,
    selectedAt: Date.now(),
    expiresAt: Date.now() + (30 * 60 * 1000)
  }));

  const detailsText = `ğŸ“¦ <b>${plan.name}</b>

ğŸ’° Ù‚ÛŒÙ…Øª: ${formatPrice(plan.price)}
ğŸ“Š Ø­Ø¬Ù…: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
â° Ù…Ø¯Øª: ${plan.duration} Ø±ÙˆØ²
ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${defaultServer.name}

ğŸ’¡ ${plan.description}`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ’³ Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯', callback_data: 'proceed_payment' }],
        [{ text: 'ğŸ”™ Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±', callback_data: 'buy_service' }],
        [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
      ]
    }
  };

  await editMessage(chatId, messageId, detailsText, keyboard);
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª
async function showPaymentMethod(chatId, messageId, kv) {
  const selectedPlanData = await kv.get(`selected_plan_${chatId}`, 'json');
  
  if (!selectedPlanData || !selectedPlanData.expiresAt || selectedPlanData.expiresAt < Date.now()) {
    await editMessage(chatId, messageId, 
      'âŒ Ù¾Ù„Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ›’ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù„Ù†', callback_data: 'buy_service' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
          ]
        }
      }
    );
    return;
  }

  const balance = await getWalletBalance(chatId, kv);
  const planPrice = selectedPlanData.plan.price;

  const paymentText = `ğŸ’³ <b>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª</b>

ğŸ“¦ Ù¾Ù„Ù†: ${selectedPlanData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(planPrice)}

ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: ${formatPrice(balance)}

ğŸ¯ <b>Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</b>`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: []
    }
  };

  // Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ø¯Ø§Ø±Ø¯ØŒ Ú¯Ø²ÛŒÙ†Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
  if (balance >= planPrice) {
    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„',
      callback_data: 'pay_with_wallet'
    }]);
  }

  keyboard.reply_markup.inline_keyboard.push([{
    text: 'ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª',
    callback_data: 'pay_with_card'
  }]);

  keyboard.reply_markup.inline_keyboard.push([{
    text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª',
    callback_data: `select_plan_${selectedPlanData.planId}`
  }]);

  await editMessage(chatId, messageId, paymentText, keyboard);
}

// Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function payWithWallet(chatId, messageId, kv) {
  const selectedPlanData = await kv.get(`selected_plan_${chatId}`, 'json');
  
  if (!selectedPlanData || selectedPlanData.expiresAt < Date.now()) {
    await editMessage(chatId, messageId, 'âŒ Ù¾Ù„Ù† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!', KEYBOARDS.backToMain);
    return;
  }

  const balance = await getWalletBalance(chatId, kv);
  const planPrice = selectedPlanData.plan.price;

  if (balance < planPrice) {
    await editMessage(chatId, messageId, 
      `âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!\n\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ${formatPrice(balance)}\nÙ…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${formatPrice(planPrice)}`,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_charge' }],
            [{ text: 'ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª', callback_data: 'pay_with_card' }],
            [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: 'proceed_payment' }]
          ]
        }
      }
    );
    return;
  }

  // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª
  const creatingMessage = await sendMessage(chatId, 'â³ <b>Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ø³Ø±ÙˆÛŒØ³...</b>\n\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...');

  // Ú©Ø³Ø± Ù…Ø¨Ù„Øº Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
  const newBalance = await updateWalletBalance(chatId, -planPrice, kv);
  if (newBalance === false) {
    await deleteMessage(chatId, creatingMessage.result.message_id);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ!', KEYBOARDS.backToMain);
    return;
  }

  // Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
  await recordWalletTransaction(chatId, -planPrice, 'purchase', `Ø®Ø±ÛŒØ¯ ${selectedPlanData.plan.name}`, kv);

  // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´
  const orderId = generateOrderId();
  const orderData = {
    id: orderId,
    chatId: chatId,
    planId: selectedPlanData.planId,
    plan: selectedPlanData.plan,
    serverId: selectedPlanData.serverId,
    serverName: selectedPlanData.serverName,
    status: 'completed',
    paymentMethod: 'wallet',
    createdAt: Date.now(),
    completedAt: Date.now()
  };

  await kv.put(`order_${orderId}`, JSON.stringify(orderData));

  // Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³
  const serviceResult = await createServerService(orderData, kv);
  
  if (!serviceResult.success) {
    // Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ø¨Ù„Øº Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
    await updateWalletBalance(chatId, planPrice, kv);
    await recordWalletTransaction(chatId, planPrice, 'refund', `Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ Ø®Ø±ÛŒØ¯ ${selectedPlanData.plan.name}`, kv);
    
    await deleteMessage(chatId, creatingMessage.result.message_id);
    await editMessage(chatId, messageId, 
      `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³: ${serviceResult.error}\n\nÙ…Ø¨Ù„Øº Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯.`,
      KEYBOARDS.backToMain
    );
    return;
  }

  orderData.serviceData = serviceResult.serviceData;
  await kv.put(`order_${orderId}`, JSON.stringify(orderData));

  await kv.delete(`selected_plan_${chatId}`);

  // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª
  await deleteMessage(chatId, creatingMessage.result.message_id);

  // Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø¯ÙˆÙ† Ø¯Ú©Ù…Ù‡
  await notifyUserServiceReady(orderData, serviceResult.serviceData);

  // Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
  const successText = `âœ… <b>Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!</b>

ğŸ“¦ Ù¾Ù„Ù†: ${selectedPlanData.plan.name}
ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceResult.serviceData.username}</code>
ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceResult.serviceData.expireTimestamp)}
â° Ø²Ù…Ø§Ù† Ø³Ø§Ø®Øª: ${formatDateTime(Date.now())}

ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: ${formatPrice(planPrice)}
ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: Ú©ÛŒÙ Ù¾ÙˆÙ„
ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${formatPrice(newBalance)}

ğŸ‰ Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª!`;

  await editMessage(chatId, messageId, successText, {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }],
        [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
      ]
    }
  });
}

// Ù…Ø±Ø­Ù„Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª
async function showCardPaymentStep(chatId, messageId, kv) {
  const selectedPlanData = await kv.get(`selected_plan_${chatId}`, 'json');
  
  if (!selectedPlanData || !selectedPlanData.expiresAt || selectedPlanData.expiresAt < Date.now()) {
    await editMessage(chatId, messageId, 
      'âŒ Ù¾Ù„Ù† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', 
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ›’ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ù„Ù†', callback_data: 'buy_service' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
          ]
        }
      }
    );
    return;
  }

  const orderId = generateOrderId();
  
  const orderData = {
    id: orderId,
    chatId: chatId,
    planId: selectedPlanData.planId,
    plan: selectedPlanData.plan,
    serverId: selectedPlanData.serverId,
    serverName: selectedPlanData.serverName,
    status: 'waiting_payment',
    paymentMethod: 'card',
    createdAt: Date.now(),
    expiresAt: Date.now() + (30 * 60 * 1000)
  };
  
  await kv.put(`order_${orderId}`, JSON.stringify(orderData));
  await kv.put(`user_order_${chatId}`, orderId);

  const paymentText = `ğŸ’³ <b>Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</b>

ğŸ“¦ Ù¾Ù„Ù†: ${selectedPlanData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(selectedPlanData.plan.price)}
ğŸ†” Ú©Ø¯ Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>

ğŸ’³ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±ÛŒØ²:</b>
ğŸ¦ Ú©Ø§Ø±Øª: <code>${PAYMENT_INFO.cardNumber}</code>
ğŸ‘¤ Ù†Ø§Ù…: ${PAYMENT_INFO.cardHolder}

ğŸ“‹ <b>Ù…Ø±Ø§Ø­Ù„:</b>
1ï¸âƒ£ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯
2ï¸âƒ£ "Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…" Ø¨Ø²Ù†ÛŒØ¯  
3ï¸âƒ£ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
4ï¸âƒ£ ØªØ§ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø´ÛŒØ¯

âš ï¸ Ø³ÙØ§Ø±Ø´ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±Ø¯`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…', callback_data: 'upload_receipt' }],
        [{ text: 'âŒ Ø§Ù†ØµØ±Ø§Ù', callback_data: 'cancel_order' }]
      ]
    }
  };

  await editMessage(chatId, messageId, paymentText, keyboard);
}

// Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯
async function handleUploadReceipt(chatId, messageId, kv) {
  const userOrder = await kv.get(`user_order_${chatId}`);
  
  if (!userOrder) {
    await editMessage(chatId, messageId, 'âŒ Ø³ÙØ§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
    return;
  }

  const orderData = await kv.get(`order_${userOrder}`, 'json');
  if (!orderData || orderData.expiresAt < Date.now()) {
    await kv.delete(`user_order_${chatId}`);
    await editMessage(chatId, messageId, 
      'âŒ Ø³ÙØ§Ø±Ø´ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø®Ø±ÛŒØ¯ Ú©Ù†ÛŒØ¯.',
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯', callback_data: 'buy_service' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
          ]
        }
      }
    );
    return;
  }

  const uploadText = `ğŸ“„ <b>Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${userOrder}</code>

ğŸ“± <b>Ù†Ø­ÙˆÙ‡ Ø§Ø±Ø³Ø§Ù„:</b>
â€¢ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ø¨Ø§Ù†Ú©ÛŒ Ø¨ÙØ±Ø³ØªÛŒØ¯
â€¢ ÛŒØ§ ÙØ§ÛŒÙ„ PDF Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
â€¢ Ø±Ø³ÛŒØ¯ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø¶Ø­ Ø¨Ø§Ø´Ø¯

â±ï¸ Ø¨Ø±Ø±Ø³ÛŒ: Ø­Ø¯Ø§Ú©Ø«Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡
ğŸ“¤ <b>Ù…Ù†ØªØ¸Ø± Ø±Ø³ÛŒØ¯ Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...</b>`;

  await editMessage(chatId, messageId, uploadText, KEYBOARDS.backToMain);
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù¾Ù„ÙˆØ¯ Ø±Ø³ÛŒØ¯
async function processReceiptUpload(chatId, messageData, kv) {
  const userOrder = await kv.get(`user_order_${chatId}`);
  
  if (!userOrder) {
    await sendMessage(chatId, 
      'âŒ Ø³ÙØ§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!\n\nØ§Ø¨ØªØ¯Ø§ ÛŒÚ© Ù¾Ù„Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.',
      KEYBOARDS.backToMain
    );
    return;
  }

  const orderData = await kv.get(`order_${userOrder}`, 'json');
  
  if (!orderData) {
    await sendMessage(chatId, 'âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
    return;
  }

  if (orderData.expiresAt < Date.now()) {
    await kv.delete(`user_order_${chatId}`);
    await sendMessage(chatId, 
      'âŒ Ø³ÙØ§Ø±Ø´ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø®Ø±ÛŒØ¯ Ú©Ù†ÛŒØ¯.',
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯', callback_data: 'buy_service' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
          ]
        }
      }
    );
    return;
  }

  orderData.status = 'payment_submitted';
  orderData.paymentSubmittedAt = Date.now();
  orderData.receiptData = messageData;
  await kv.put(`order_${userOrder}`, JSON.stringify(orderData));

  await notifyAdminNewPayment(orderData, messageData);

  const confirmText = `âœ… <b>Ø±Ø³ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${userOrder}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}

ğŸ” Ø±Ø³ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯
â±ï¸ Ø²Ù…Ø§Ù† Ø¨Ø±Ø±Ø³ÛŒ: Ø­Ø¯Ø§Ú©Ø«Ø± 30 Ø¯Ù‚ÛŒÙ‚Ù‡

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

  await sendMessage(chatId, confirmText, KEYBOARDS.backToMain);
}

// Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± - Ø¨Ø§ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
async function showMyServices(chatId, messageId, kv, page = 1) {
  try {
    const userServicesResult = await kv.list(`service_${chatId}_`);
    const servicesPerPage = 10;
    
    let servicesText = `ğŸ“± <b>Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†</b>\n\n`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    if (!userServicesResult.keys || userServicesResult.keys.length === 0) {
      servicesText += 'âŒ Ù‡ÛŒÚ† Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!';
    } else {
      // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ ØªÙ…Ø§Ù… Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
      const services = [];
      for (const key of userServicesResult.keys) {
        const serviceData = await kv.get(key.name, 'json');
        if (serviceData && serviceData.serviceId) {
          services.push(serviceData);
        }
      }

      if (services.length === 0) {
        servicesText += 'âŒ Ù‡ÛŒÚ† Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ø§Ù„ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯!';
      } else {
        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† Ø®Ø±ÛŒØ¯ - Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„
        services.sort((a, b) => {
          const timeA = a.createdAt || 0;
          const timeB = b.createdAt || 0;
          return timeB - timeA; // Ù†Ø²ÙˆÙ„ÛŒ (Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù‚Ø¯ÛŒÙ…)
        });

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
        const totalServices = services.length;
        const totalPages = Math.ceil(totalServices / servicesPerPage);
        const startIndex = (page - 1) * servicesPerPage;
        const endIndex = Math.min(startIndex + servicesPerPage, totalServices);
        const currentPageServices = services.slice(startIndex, endIndex);

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
        if (totalPages > 1) {
          servicesText += `ğŸ“„ ØµÙØ­Ù‡ ${page} Ø§Ø² ${totalPages} (${totalServices} Ø³Ø±ÙˆÛŒØ³)\n\n`;
        } else {
          servicesText += `ğŸ“Š ${totalServices} Ø³Ø±ÙˆÛŒØ³\n\n`;
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
        currentPageServices.forEach((serviceData, index) => {
          const serviceNumber = startIndex + index + 1;
          keyboard.reply_markup.inline_keyboard.push([{
            text: `${serviceNumber}. ğŸ“‹ ${serviceData.username}`,
            callback_data: `manage_service_${serviceData.serviceId}`
          }]);
        });

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ
        if (totalPages > 1) {
          const navigationRow = [];
          
          // Ø¯Ú©Ù…Ù‡ ØµÙØ­Ù‡ Ù‚Ø¨Ù„
          if (page > 1) {
            navigationRow.push({
              text: 'â—€ï¸ Ù‚Ø¨Ù„ÛŒ',
              callback_data: `services_page_${page - 1}`
            });
          }
          
          // Ù†Ù…Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù‡ ØµÙØ­Ù‡ ÙØ¹Ù„ÛŒ
          navigationRow.push({
            text: `${page}/${totalPages}`,
            callback_data: 'current_page'
          });
          
          // Ø¯Ú©Ù…Ù‡ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯
          if (page < totalPages) {
            navigationRow.push({
              text: 'Ø¨Ø¹Ø¯ÛŒ â–¶ï¸',
              callback_data: `services_page_${page + 1}`
            });
          }
          
          keyboard.reply_markup.inline_keyboard.push(navigationRow);
        }
      }
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ” Ø³Ø±ÙˆÛŒØ³ Ù…Ù† ØªÙˆÛŒ Ù„ÛŒØ³Øª Ù†ÛŒØ³Øª',
      callback_data: 'find_my_service'
    }]);

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø¬Ø¯ÛŒØ¯',
      callback_data: 'buy_service'
    }]);

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ',
      callback_data: 'start'
    }]);

    await editMessage(chatId, messageId, servicesText, keyboard);

  } catch (error) {
    console.error('Error showing services:', error);
    await editMessage(chatId, messageId, 
      'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§.',
      KEYBOARDS.backToMain
    );
  }
}

// Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³
async function showFindMyService(chatId, messageId, kv) {
  const findText = `ğŸ” <b>Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ Ù…ÙˆÙ‚Ø¹ Ø®Ø±ÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:

ğŸ’¡ <b>Ø±Ø§Ù‡Ù†Ù…Ø§:</b>
â€¢ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ùˆ Ø§Ø¹Ø¯Ø§Ø¯ Ø§Ø³Øª
â€¢ Ù…Ø«Ø§Ù„: user_123456_789
â€¢ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† Ù†Ø§Ù…ÛŒ Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯

ğŸ“¤ <b>Ù…Ù†ØªØ¸Ø± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...</b>`;

  // Ø°Ø®ÛŒØ±Ù‡ Ø­Ø§Ù„Øª Ø§Ù†ØªØ¸Ø§Ø± Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
  await kv.put(`waiting_username_${chatId}`, JSON.stringify({
    chatId: chatId,
    messageId: messageId,
    timestamp: Date.now()
  }));

  await editMessage(chatId, messageId, findText, {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”™ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }]
      ]
    }
  });
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø³ØªØ¬Ùˆ
async function processUsernameSearch(chatId, messageText, kv) {
  const waitingData = await kv.get(`waiting_username_${chatId}`, 'json');
  
  if (!waitingData) {
    return; // Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø³ØªØ¬Ùˆ
  }

  const username = messageText.trim();
  
  if (!username || username.length < 3) {
    await sendMessage(chatId, 'âŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª!\n\nÙ„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØµØ­ÛŒØ­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    return;
  }

  await kv.delete(`waiting_username_${chatId}`);

  // Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  const serviceResult = await findServiceByUsername(chatId, username, kv);
  
  if (!serviceResult) {
    const notFoundText = `âŒ <b>Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!</b>

ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${username}</code>

ğŸ” <b>Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:</b>
â€¢ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
â€¢ Ø³Ø±ÙˆÛŒØ³ Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø´Ù…Ø§ Ù†ÛŒØ³Øª
â€¢ Ø³Ø±ÙˆÛŒØ³ Ø­Ø°Ù Ø´Ø¯Ù‡ Ø§Ø³Øª

ğŸ’¬ Ø¯Ø± ØµÙˆØ±Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØµØ­Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒØŒ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯: @${PAYMENT_INFO.supportUsername}`;

    await sendMessage(chatId, notFoundText, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¬Ø¯Ø¯', callback_data: 'find_my_service' }],
          [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }]
        ]
      }
    });
    return;
  }

  const serviceData = serviceResult.data;
  const remainingDays = Math.ceil((serviceData.expireTimestamp - Date.now()) / (1000 * 60 * 60 * 24));
  const isExpiring = remainingDays <= 3;
  const isExpired = remainingDays <= 0;

  const foundText = `âœ… <b>Ø³Ø±ÙˆÛŒØ³ Ù¾ÛŒØ¯Ø§ Ø´Ø¯!</b>

ğŸ“‹ <b>${serviceData.planName}</b>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ø­Ø¬Ù…: ${serviceData.dataLimit ? serviceData.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}
â° Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${remainingDays} Ø±ÙˆØ² ${isExpired ? 'âŒ' : isExpiring ? 'âš ï¸' : 'âœ…'}
ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${serviceData.serverName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ${serviceData.status === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}

ğŸ¯ <b>Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø®ÙˆØ¯ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†ÛŒØ¯:</b>`;

  await sendMessage(chatId, foundText, {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ“± Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceData.serviceId}` }],
        [{ text: 'ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¬Ø¯Ø¯', callback_data: 'find_my_service' }],
        [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }]
      ]
    }
  });
}

// Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³ - Ù†Ø³Ø®Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡
// Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³ - Ù†Ø³Ø®Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ Ø´Ø¯Ù‡
async function showServiceManagement(chatId, messageId, serviceId, kv, sendConfig = false) {
  try {
    console.log('Managing service:', chatId, serviceId);
    
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;

    const remainingDays = Math.ceil((serviceData.expireTimestamp - Date.now()) / (1000 * 60 * 60 * 24));
    const isExpiring = remainingDays <= 3;
    const isExpired = remainingDays <= 0;
    
    // Ø§Ø¨ØªØ¯Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    const managementText = `ğŸ“± <b>Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ <b>${serviceData.planName}</b>
ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ø­Ø¬Ù…: ${serviceData.dataLimit ? serviceData.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}
â° Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${remainingDays} Ø±ÙˆØ² ${isExpired ? 'âŒ' : isExpiring ? 'âš ï¸' : 'âœ…'}
ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${serviceData.serverName || 'Ù†Ø§Ù…Ø´Ø®Øµ'}
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ${serviceData.status === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}

ğŸ”§ <b>Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª:</b>`;

const managementKeyboard = {
  reply_markup: {
    inline_keyboard: [
      [
        { text: 'ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: `renew_service_${serviceId}` },
        { text: 'âš¡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³', callback_data: `service_status_${serviceId}` }
      ],
      [
        { text: 'ğŸ“Š Ù…ØµØ±Ù ØªØ±Ø§ÙÛŒÚ©', callback_data: `traffic_usage_${serviceId}` },
        { text: serviceData.status === 'active' ? 'â¸ï¸ ØªÙˆÙ‚Ù Ø³Ø±ÙˆÛŒØ³' : 'â–¶ï¸ ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ', 
          callback_data: `toggle_service_${serviceId}` }
      ],
      [
        { text: 'ğŸ”— Ø¯Ø±ÛŒØ§ÙØª Ú©Ø§Ù†ÙÛŒÚ¯', callback_data: `get_config_${serviceId}` },
        { text: 'ğŸ”„ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©', callback_data: `reset_link_${serviceId}` }
      ],
      [
        { text: 'ğŸ’ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…', 
          url: `https://t.me/${PAYMENT_INFO.supportUsername}?start=service_${serviceId}` }
      ],
      [{ text: 'ğŸ”™ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }],
      [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
    ]
  }
};

    await editMessage(chatId, messageId, managementText, managementKeyboard);

    // ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªØŒ QR Ú©Ø¯ Ùˆ Ù„ÛŒÙ†Ú© Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
    if (sendConfig && serviceData.configUrl) {
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&format=png&data=${encodeURIComponent(serviceData.configUrl)}`;
      
      const qrCaption = `ğŸ”— <b>Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>

ğŸ”— <b>Ù„ÛŒÙ†Ú©:</b>
<code>${serviceData.configUrl}</code>

ğŸ’¡ <b>Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>
â€¢ QR Ú©Ø¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯
â€¢ Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† VPN ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯

ğŸ“± <b>Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:</b>
ğŸ¤– Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯: V2rayNG
ğŸ Ø¢ÛŒÙÙˆÙ†: Fair VPN ÛŒØ§ Shadowrocket
ğŸ’» ÙˆÛŒÙ†Ø¯ÙˆØ²: V2rayN
ğŸ–¥ï¸ Ù…Ú©: ClashX
ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ: /start`;

      await sendPhoto(chatId, qrUrl, qrCaption);
    }

  } catch (error) {
    console.error('Error showing service management:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø³Ø±ÙˆÛŒØ³.', KEYBOARDS.backToMain);
  }
}

async function showServiceRenewal(chatId, messageId, serviceId, kv) {
  try {
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;
    const plans = await getPlans(kv);
    const remainingDays = Math.ceil((serviceData.expireTimestamp - Date.now()) / (1000 * 60 * 60 * 24));
    
    let renewalText = `ğŸ”„ <b>ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ <b>Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ù„ÛŒ:</b> ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}
â° Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${remainingDays} Ø±ÙˆØ²

âš ï¸ <b>Ù‡Ø´Ø¯Ø§Ø± Ù…Ù‡Ù…:</b>
Ù¾Ø³ Ø§Ø² ØªÙ…Ø¯ÛŒØ¯ØŒ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø¬Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø¬Ù… Ù‚Ø¨Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
Ø³Ø±ÙˆÛŒØ³ Ù‚Ø¨Ù„ÛŒ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ù„Ú©Ù‡ ØªÙ…Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯.

ğŸ”¸ <b>Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ…Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</b>`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    getSortedPlans(plans).forEach((plan) => {
      keyboard.reply_markup.inline_keyboard.push([{
        text: `ğŸ”„ ${plan.name}`,
        callback_data: `renew_with_plan|${serviceId}|${plan.id}`
      }]);
    });

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³',
      callback_data: `manage_service_${serviceId}`
    }]);

    await editMessage(chatId, messageId, renewalText, keyboard);

  } catch (error) {
    console.error('Error showing service renewal:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø¯ÛŒØ¯.', KEYBOARDS.backToMain);
  }
}

async function processRenewalWithPlan(chatId, messageId, serviceId, planId, kv) {
  try {
    const plans = await getPlans(kv);
    const plan = plans[planId];
    
    if (!plan) {
      await editMessage(chatId, messageId, 'âŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceResult = await findServiceById(chatId, serviceId, kv);
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;
    const balance = await getWalletBalance(chatId, kv);

    // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø¯ÛŒØ¯
    await kv.put(`renewal_plan_${chatId}`, JSON.stringify({
      planId: planId,
      plan: plan,
      serviceId: serviceId,
      serviceData: serviceData,
      selectedAt: Date.now(),
      expiresAt: Date.now() + (30 * 60 * 1000)
    }));

    const renewalPaymentText = `ğŸ’³ <b>ØªØ£ÛŒÛŒØ¯ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ <b>Ø³Ø±ÙˆÛŒØ³ ÙØ¹Ù„ÛŒ:</b> ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>

ğŸ”„ <b>ØªÙ…Ø¯ÛŒØ¯ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ:</b> ${plan.name}
ğŸ’° Ù‚ÛŒÙ…Øª: ${formatPrice(plan.price)}
ğŸ“Š Ø­Ø¬Ù… Ø§Ø¶Ø§ÙÛŒ: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
â° Ø²Ù…Ø§Ù† Ø§Ø¶Ø§ÙÛŒ: ${plan.duration} Ø±ÙˆØ²
ğŸ’¡ ${plan.description}

âš ï¸ <b>Ù†Ú©ØªÙ‡:</b> 
â€¢ Ø²Ù…Ø§Ù†: ${plan.duration} Ø±ÙˆØ² Ø¨Ù‡ Ø§Ù†Ù‚Ø¶Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
â€¢ Ø­Ø¬Ù…: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ø­Ø¬Ù… Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'} Ø¨Ù‡ Ø­Ø¬Ù… ÙØ¹Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: ${formatPrice(balance)}

ğŸ¯ <b>Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</b>`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    if (balance >= plan.price) {
      keyboard.reply_markup.inline_keyboard.push([{
        text: 'ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„',
        callback_data: `renew_wallet|${serviceId}|${planId}`
      }]);
    }

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª',
      callback_data: `renew_card|${serviceId}|${planId}`
    }]);

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª',
      callback_data: `renew_service_${serviceId}`
    }]);

    await editMessage(chatId, messageId, renewalPaymentText, keyboard);

  } catch (error) {
    console.error('Error processing renewal:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙ…Ø¯ÛŒØ¯.', KEYBOARDS.backToMain);
  }
}

// ØªÙ…Ø¯ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ - Ú©Ø¯ Ú©Ø§Ù…Ù„ Ùˆ Ø§ØµÙ„Ø§Ø­â€ŒØ´Ø¯Ù‡ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ |
async function renewWithWallet(chatId, messageId, serviceId, planId, kv) {
  try {
    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡
    const renewalData = await kv.get(`renewal_plan_${chatId}`, 'json');
    
    if (!renewalData || renewalData.expiresAt < Date.now()) {
      await editMessage(chatId, messageId, 
        'âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø¯ÛŒØ¯ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.', {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: `renew_service_${serviceId}` }],
              [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
            ]
          }
        }
      );
      return;
    }

    const plan = renewalData.plan;
    const serviceData = renewalData.serviceData;
    const balance = await getWalletBalance(chatId, kv);

    if (balance < plan.price) {
      await editMessage(chatId, messageId, 
        `âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!\n\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: ${formatPrice(balance)}\nÙ…Ø¨Ù„Øº Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²: ${formatPrice(plan.price)}`, {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„', callback_data: 'wallet_charge' }],
              [{ text: 'ğŸ’³ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª', callback_data: `renew_card|${serviceId}|${planId}` }],
              [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: `renew_with_plan|${serviceId}|${planId}` }]
            ]
          }
        }
      );
      return;
    }

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø¯ÛŒØ¯
    const renewingMessage = await sendMessage(chatId, 'â³ <b>Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³...</b>\n\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...');

    // Ú©Ø³Ø± Ù…Ø¨Ù„Øº Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
    const newBalance = await updateWalletBalance(chatId, -plan.price, kv);
    if (newBalance === false) {
      await deleteMessage(chatId, renewingMessage.result.message_id);
      await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ø³Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ!', KEYBOARDS.backToMain);
      return;
    }

    // Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
    await recordWalletTransaction(chatId, -plan.price, 'purchase', `ØªÙ…Ø¯ÛŒØ¯ ${serviceData.planName} Ø¨Ø§ ${plan.name}`, kv);

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´ ØªÙ…Ø¯ÛŒØ¯
    const orderId = generateOrderId();
    const orderData = {
      id: orderId,
      chatId: chatId,
      planId: renewalData.planId,
      plan: plan,
      serviceId: serviceId,
      serviceData: serviceData,
      type: 'renewal',
      status: 'completed',
      paymentMethod: 'wallet',
      createdAt: Date.now(),
      completedAt: Date.now()
    };

    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    // ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø³Ø±ÙˆØ±
    const renewalResult = await renewExistingService(orderData, kv);
    
    if (!renewalResult.success) {
      // Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ø¨Ù„Øº Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§
      await updateWalletBalance(chatId, plan.price, kv);
      await recordWalletTransaction(chatId, plan.price, 'refund', `Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡ ØªÙ…Ø¯ÛŒØ¯ ${serviceData.planName}`, kv);
      
      await deleteMessage(chatId, renewingMessage.result.message_id);
      await editMessage(chatId, messageId, 
        `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³: ${renewalResult.error}\n\nÙ…Ø¨Ù„Øº Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù‡ Ø´Ø¯.`,
        KEYBOARDS.backToMain
      );
      return;
    }

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³
    orderData.serviceData = renewalResult.serviceData;
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª ØªÙ…Ø¯ÛŒØ¯
    await kv.delete(`renewal_plan_${chatId}`);

    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ ØªÙ…Ø¯ÛŒØ¯"
    await deleteMessage(chatId, renewingMessage.result.message_id);

    // Ø§Ø±Ø³Ø§Ù„ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    // Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
// Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
const successText = `âœ… <b>Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯!</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ”„ ØªÙ…Ø¯ÛŒØ¯: ${plan.name}
â° Ø²Ù…Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ${plan.duration} Ø±ÙˆØ²
ğŸ“Š Ø­Ø¬Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: ${formatDate(renewalResult.serviceData.expireTimestamp)}

ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ: ${formatPrice(plan.price)}
ğŸ’³ Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: Ú©ÛŒÙ Ù¾ÙˆÙ„
ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡: ${formatPrice(newBalance)}

ğŸ‰ Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§ ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯!`;

    await editMessage(chatId, messageId, successText, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }],
          [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
        ]
      }
    });

  } catch (error) {
    console.error('Error renewing with wallet:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³.', KEYBOARDS.backToMain);
  }
}

// ØªÙ…Ø¯ÛŒØ¯ Ø¨Ø§ Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª
async function renewWithCard(chatId, messageId, serviceId, planId, kv) {
  try {
    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
    const renewalData = await kv.get(`renewal_plan_${chatId}`, 'json');
    
    if (!renewalData || renewalData.expiresAt < Date.now()) {
      await editMessage(chatId, messageId, 
        'âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÙ…Ø¯ÛŒØ¯ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡!\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.',
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”„ ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³', callback_data: `renew_service_${serviceId}` }],
              [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
            ]
          }
        }
      );
      return;
    }

    const plan = renewalData.plan;
    const serviceData = renewalData.serviceData;

    // Ø§ÛŒØ¬Ø§Ø¯ Ø³ÙØ§Ø±Ø´ ØªÙ…Ø¯ÛŒØ¯
    const orderId = generateOrderId();
    const orderData = {
      id: orderId,
      chatId: chatId,
      planId: renewalData.planId,
      plan: plan,
      serviceId: serviceId,
      serviceData: serviceData,
      type: 'renewal',
      status: 'waiting_payment',
      paymentMethod: 'card',
      createdAt: Date.now(),
      expiresAt: Date.now() + (30 * 60 * 1000)
    };
    
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));
    await kv.put(`user_order_${chatId}`, orderId);

    const paymentText = `ğŸ’³ <b>Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙ…Ø¯ÛŒØ¯</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ”„ Ù¾Ù„Ù† ØªÙ…Ø¯ÛŒØ¯: ${plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(plan.price)}
ğŸ†” Ú©Ø¯ Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>

ğŸ’³ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ§Ø±ÛŒØ²:</b>
ğŸ¦ Ú©Ø§Ø±Øª: <code>${PAYMENT_INFO.cardNumber}</code>
ğŸ‘¤ Ù†Ø§Ù…: ${PAYMENT_INFO.cardHolder}

ğŸ“‹ <b>Ù…Ø±Ø§Ø­Ù„:</b>
1ï¸âƒ£ Ù…Ø¨Ù„Øº Ø±Ø§ ÙˆØ§Ø±ÛŒØ² Ú©Ù†ÛŒØ¯
2ï¸âƒ£ "Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…" Ø¨Ø²Ù†ÛŒØ¯  
3ï¸âƒ£ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯
4ï¸âƒ£ ØªØ§ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø´ÛŒØ¯

âš ï¸ Ø³ÙØ§Ø±Ø´ 30 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø±Ø¯`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'âœ… Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ø±Ø¯Ù…', callback_data: 'upload_receipt' }],
          [{ text: 'âŒ Ø§Ù†ØµØ±Ø§Ù', callback_data: 'cancel_order' }]
        ]
      }
    };

    await editMessage(chatId, messageId, paymentText, keyboard);

  } catch (error) {
    console.error('Error processing card renewal:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙ…Ø¯ÛŒØ¯.', KEYBOARDS.backToMain);
  }
}

// ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ Ùˆ ØªØ±Ø§ÙÛŒÚ©
async function showServiceStatus(chatId, messageId, serviceId, kv) {
  try {
    console.log('Showing status for service:', chatId, serviceId);
    
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;

    // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù¾Ø¯ÛŒØª
    const servers = await getServers(kv);
    const server = servers[serviceData.serverId];
    
    let statusText = `âš¡ <b>ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ Ù†Ø§Ù…: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ${serviceData.status === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}
ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${serviceData.serverName}

`;

    if (server) {
      try {
        const api = new MarzbanAPI(server.baseUrl);
        const loginResult = await api.login(server.username, server.password);
        
        if (loginResult.success) {
          const userResult = await api.getUser(serviceData.username);
          
          if (userResult.success) {
            const userData = userResult.data;
            const usedTraffic = userData.used_traffic || 0;
            const totalTraffic = userData.data_limit || 0;
            
            statusText += `ğŸ“ˆ <b>Ù…ØµØ±Ù ØªØ±Ø§ÙÛŒÚ©:</b>
ğŸ“Š Ù…ØµØ±Ù Ø´Ø¯Ù‡: ${formatBytes(usedTraffic)}
ğŸ“‹ Ú©Ù„ Ø­Ø¬Ù…: ${totalTraffic ? formatBytes(totalTraffic) : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
ğŸ’¯ Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù: ${totalTraffic ? ((usedTraffic / totalTraffic) * 100).toFixed(1) + '%' : '0%'}

ğŸ“… <b>Ø²Ù…Ø§Ù†:</b>
ğŸ• Ø¢Ø®Ø±ÛŒÙ† Ø§ØªØµØ§Ù„: ${userData.last_connected ? formatDateTime(new Date(userData.last_connected).getTime()) : 'Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª'}
â° Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}

ğŸ”— <b>Ø§ØªØµØ§Ù„Ø§Øª ÙØ¹Ø§Ù„:</b> ${userData.connections?.length || 0}`;
          } else {
            statusText += 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø³Ø±ÙˆØ±';
          }
        } else {
          statusText += 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±';
        }
      } catch (error) {
        statusText += 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
      }
    } else {
      statusText += 'âŒ Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯';
    }

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', callback_data: `service_status_${serviceId}` }],
          [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }]
        ]
      }
    };

    await editMessage(chatId, messageId, statusText, keyboard);

  } catch (error) {
    console.error('Error showing service status:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª.', KEYBOARDS.backToMain);
  }
}

// ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ (ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„)
async function toggleServiceStatus(chatId, messageId, serviceId, kv) {
  try {
    console.log('Toggling service status:', chatId, serviceId);
    
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;
    const servers = await getServers(kv);
    const server = servers[serviceData.serverId];
    
    if (!server) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    try {
      const api = new MarzbanAPI(server.baseUrl);
      const loginResult = await api.login(server.username, server.password);
      
      if (!loginResult.success) {
        await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±!', KEYBOARDS.backToMain);
        return;
      }

      const newStatus = serviceData.status === 'active' ? 'disabled' : 'active';
      
      const updateResult = await api.modifyUser(serviceData.username, {
        status: newStatus
      });

      if (updateResult.success) {
        serviceData.status = newStatus;
        await kv.put(serviceResult.key, JSON.stringify(serviceData));
        
        // Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        const successText = `âœ… ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯: ${newStatus === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}`;

        const keyboard = {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }]
            ]
          }
        };

        await editMessage(chatId, messageId, successText, keyboard);
        
      } else {
        await editMessage(chatId, messageId, 
          `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª: ${updateResult.error}`,
          {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }]
              ]
            }
          }
        );
      }

    } catch (error) {
      await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±!', KEYBOARDS.backToMain);
    }

  } catch (error) {
    console.error('Error toggling service status:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª.', KEYBOARDS.backToMain);
  }
}

// Ù†Ù…Ø§ÛŒØ´ ØªØ£ÛŒÛŒØ¯ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©
async function showResetLinkConfirmation(chatId, messageId, serviceId, kv) {
  try {
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;

    const confirmText = `âš ï¸ <b>ØªØ£ÛŒÛŒØ¯ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú© Ø³Ø±ÙˆÛŒØ³</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>

ğŸš¨ <b>Ù‡Ø´Ø¯Ø§Ø± Ù…Ù‡Ù…:</b>
â€¢ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ú©Ø§Ù…Ù„Ø§Ù‹ ØªØºÛŒÛŒØ± Ø®ÙˆØ§Ù‡Ø¯ Ú©Ø±Ø¯
â€¢ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ØªØµÙ„ Ù‚Ø·Ø¹ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯
â€¢ Ø¨Ø§ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
â€¢ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª

â“ <b>Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ</b>`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'âœ… Ø¨Ù„Ù‡ØŒ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡', callback_data: `confirm_reset_${serviceId}` }
          ],
          [
            { text: 'âŒ Ø§Ù†ØµØ±Ø§Ù', callback_data: `manage_service_${serviceId}` }
          ]
        ]
      }
    };

    await editMessage(chatId, messageId, confirmText, keyboard);

  } catch (error) {
    console.error('Error showing reset confirmation:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªØ£ÛŒÛŒØ¯.', KEYBOARDS.backToMain);
  }
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©
async function processResetLink(chatId, messageId, serviceId, kv) {
  try {
    const serviceResult = await findServiceById(chatId, serviceId, kv);
    
    if (!serviceResult) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    const serviceData = serviceResult.data;
    const servers = await getServers(kv);
    const server = servers[serviceData.serverId];
    
    if (!server) {
      await editMessage(chatId, messageId, 'âŒ Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToMain);
      return;
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
    await editMessage(chatId, messageId, 'â³ <b>Ø¯Ø± Ø­Ø§Ù„ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©...</b>\n\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...', {});

    try {
      const api = new MarzbanAPI(server.baseUrl);
      const loginResult = await api.login(server.username, server.password);
      
      if (!loginResult.success) {
        await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±!', KEYBOARDS.backToMain);
        return;
      }

      // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† secret Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©
      const resetResult = await api.request(`${api.apiPath}/user/${encodeURIComponent(serviceData.username)}/reset`, {
        method: 'POST'
      });

      if (!resetResult.success) {
        await editMessage(chatId, messageId, 
          `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©: ${resetResult.error}`,
          {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }]
              ]
            }
          }
        );
        return;
      }

      // Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒÙ… ØªØ§ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¢Ù…Ø§Ø¯Ù‡ Ø´ÙˆØ¯
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯
      const userResult = await api.getUser(serviceData.username);
      let newConfigUrl = null;
      
      if (userResult.success && userResult.data.subscription_url) {
        newConfigUrl = userResult.data.subscription_url.startsWith('http') ? 
                      userResult.data.subscription_url : 
                      `${api.baseUrl}${userResult.data.subscription_url}`;
      }

      if (newConfigUrl) {
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù„ÛŒÙ†Ú© Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
        serviceData.configUrl = newConfigUrl;
        serviceData.linkResetAt = Date.now();
        await kv.put(serviceResult.key, JSON.stringify(serviceData));

        // Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&format=png&data=${encodeURIComponent(newConfigUrl)}`;
        
        const configText = `ğŸ”— <b>Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³</b>

ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>

ğŸ”— <b>Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯:</b>
<code>${newConfigUrl}</code>

ğŸ’¡ <b>Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:</b>
â€¢ Ù„ÛŒÙ†Ú© Ù‚Ø¨Ù„ÛŒ Ø¯ÛŒÚ¯Ø± Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯
â€¢ Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¯Ø± Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
â€¢ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ù‚Ø·Ø¹ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯

ğŸ“± <b>Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>
â€¢ QR Ú©Ø¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯
â€¢ Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† VPN ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯`;

        await sendPhoto(chatId, qrUrl, configText);

        // Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
        const successText = `âœ… <b>Ù„ÛŒÙ†Ú© Ø³Ø±ÙˆÛŒØ³ ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!</b>

ğŸ“‹ Ø³Ø±ÙˆÛŒØ³: ${serviceData.planName}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ• Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ±: ${formatDateTime(Date.now())}

ğŸ‰ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!

âš ï¸ <b>ÛŒØ§Ø¯Ø¢ÙˆØ±ÛŒ:</b>
â€¢ Ù„ÛŒÙ†Ú© Ù‚Ø¨Ù„ÛŒ Ø¯ÛŒÚ¯Ø± Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯
â€¢ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ù‚Ø·Ø¹ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
â€¢ Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø± Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯`;

        const keyboard = {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ“± Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }],
              [{ text: 'ğŸ”— Ø¯Ø±ÛŒØ§ÙØª Ù…Ø¬Ø¯Ø¯ Ù„ÛŒÙ†Ú©', callback_data: `get_config_${serviceId}` }],
              [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
            ]
          }
        };

        await editMessage(chatId, messageId, successText, keyboard);

      } else {
        await editMessage(chatId, messageId, 
          'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯!\n\nÙ„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.',
          {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }],
                [{ text: 'ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
              ]
            }
          }
        );
      }

    } catch (error) {
      await editMessage(chatId, messageId, 
        'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±!\n\nÙ„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.',
        {
          reply_markup: {
            inline_keyboard: [
              [{ text: 'ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯', callback_data: `reset_link_${serviceId}` }],
              [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³', callback_data: `manage_service_${serviceId}` }]
            ]
          }
        }
      );
    }

  } catch (error) {
    console.error('Error processing reset link:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ù„ÛŒÙ†Ú©.', KEYBOARDS.backToMain);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ØªØµØ§Ù„
async function showConnectionGuide(chatId, messageId) {
  const guideText = `ğŸ“– <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ØªØµØ§Ù„</b>

ğŸ“± <b>Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯:</b>
â€¢ V2rayNG Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
â€¢ Ø±ÙˆÛŒ + Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Subscription Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
â€¢ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯

ğŸ <b>Ø¢ÛŒÙÙˆÙ†:</b>
â€¢ Fair VPN ÛŒØ§ Shadowrocket Ù†ØµØ¨ Ú©Ù†ÛŒØ¯  
â€¢ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯

ğŸ’» <b>ÙˆÛŒÙ†Ø¯ÙˆØ²:</b>
â€¢ V2rayN Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
â€¢ Subscription â†’ Add Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯
â€¢ Ù„ÛŒÙ†Ú© Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯

ğŸ–¥ï¸ <b>Ù…Ú©:</b>
â€¢ ClashX Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
â€¢ Config â†’ Remote Config â†’ Manage
â€¢ Ù„ÛŒÙ†Ú© Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯

ğŸ’¡ <b>Ù†Ú©ØªÙ‡:</b> Ø¨Ø¹Ø¯ Ø§Ø² Ø®Ø±ÛŒØ¯ØŒ Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.

ğŸ’¬ <b>Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b> @${PAYMENT_INFO.supportUsername}`;

  await editMessage(chatId, messageId, guideText, KEYBOARDS.backToMain);
}

// Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯
async function showCreateTicket(chatId, messageId, kv) {
  // Ø¨Ø±Ø±Ø³ÛŒ ØªÛŒÚ©Øª Ø¨Ø§Ø²
  const openTickets = await kv.list(`ticket_${chatId}_`);
  let hasOpenTicket = false;
  
  for (const key of openTickets.keys) {
    const ticket = await kv.get(key.name, 'json');
    if (ticket && ticket.status === 'open') {
      hasOpenTicket = true;
      break;
    }
  }

  if (hasOpenTicket) {
    await editMessage(chatId, messageId, 
      'âš ï¸ Ø´Ù…Ø§ ÛŒÚ© ØªÛŒÚ©Øª Ø¨Ø§Ø² Ø¯Ø§Ø±ÛŒØ¯!\n\nØ§Ø¨ØªØ¯Ø§ ØªÛŒÚ©Øª Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯.', 
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ« Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', callback_data: 'my_tickets' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }]
          ]
        }
      }
    );
    return;
  }

  const createText = `ğŸ« <b>Ø«Ø¨Øª ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</b>

ğŸ“ Ù…ÙˆØ¶ÙˆØ¹ ØªÛŒÚ©Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:`;

  const keyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'â“ Ø³ÙˆØ§Ù„ ÙÙ†ÛŒ', callback_data: 'ticket_type_technical' }],
        [{ text: 'ğŸ’° Ù…Ø´Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª', callback_data: 'ticket_type_payment' }],
        [{ text: 'ğŸ”§ Ù…Ø´Ú©Ù„ Ø§ØªØµØ§Ù„', callback_data: 'ticket_type_connection' }],
        [{ text: 'ğŸ“‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆÛŒÚ˜Ù‡', callback_data: 'ticket_type_request' }],
        [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }]
      ]
    }
  };

  await editMessage(chatId, messageId, createText, keyboard);
}

// Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªÛŒÚ©Øª
async function selectTicketType(chatId, messageId, ticketType, kv) {
  const typeNames = {
    'technical': 'Ø³ÙˆØ§Ù„ ÙÙ†ÛŒ',
    'payment': 'Ù…Ø´Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª', 
    'connection': 'Ù…Ø´Ú©Ù„ Ø§ØªØµØ§Ù„',
    'request': 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆÛŒÚ˜Ù‡'
  };

  // Ø°Ø®ÛŒØ±Ù‡ Ù†ÙˆØ¹ ØªÛŒÚ©Øª
  await kv.put(`pending_ticket_${chatId}`, JSON.stringify({
    type: ticketType,
    typeName: typeNames[ticketType],
    chatId: chatId,
    createdAt: Date.now()
  }));

  const waitText = `ğŸ“ <b>Ø«Ø¨Øª ØªÛŒÚ©Øª: ${typeNames[ticketType]}</b>

Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:

ğŸ’¡ <b>Ù†Ú©Ø§Øª:</b>
â€¢ ÙˆØ§Ø¶Ø­ Ùˆ Ù…ÙØµÙ„ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯
â€¢ Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ ÙÙ†ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø¯Ù‡ÛŒØ¯
â€¢ ØªØ§ 500 Ú©Ø§Ø±Ø§Ú©ØªØ±

ğŸ“¤ <b>Ù…Ù†ØªØ¸Ø± Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...</b>`;

  await editMessage(chatId, messageId, waitText, KEYBOARDS.backToSupport);
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… ØªÛŒÚ©Øª
async function processTicketMessage(chatId, messageText, kv) {
  const pendingTicket = await kv.get(`pending_ticket_${chatId}`, 'json');
  
  if (!pendingTicket) {
    await sendMessage(chatId, 'âŒ ØªÛŒÚ©Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToSupport);
    return;
  }

  if (messageText.length > 500) {
    await sendMessage(chatId, 'âŒ Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¨ÛŒØ´ Ø§Ø² 500 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø³Øª!\n\nÙ„Ø·ÙØ§Ù‹ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.');
    return;
  }

  const ticketId = generateTicketId();
  const ticketData = {
    id: ticketId,
    chatId: chatId,
    type: pendingTicket.type,
    typeName: pendingTicket.typeName,
    subject: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''),
    message: messageText,
    status: 'open',
    createdAt: Date.now(),
    messages: [
      {
        from: 'user',
        message: messageText,
        timestamp: Date.now()
      }
    ]
  };

  await kv.put(`ticket_${chatId}_${ticketId}`, JSON.stringify(ticketData));
  await kv.delete(`pending_ticket_${chatId}`);

  // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø¯ÛŒØ±
  await notifyAdminNewTicket(ticketData);

  const successText = `âœ… <b>ØªÛŒÚ©Øª Ø«Ø¨Øª Ø´Ø¯!</b>

ğŸ†” Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª: <code>${ticketId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${pendingTicket.typeName}
ğŸ“… ØªØ§Ø±ÛŒØ®: ${formatDate(Date.now())}

â±ï¸ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯`;

  await sendMessage(chatId, successText, KEYBOARDS.backToSupport);
}

// Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
async function showMyTickets(chatId, messageId, kv) {
  try {
    const userTicketsResult = await kv.list(`ticket_${chatId}_`);
    
    if (!userTicketsResult.keys || userTicketsResult.keys.length === 0) {
      const noTicketsText = `ğŸ“‚ <b>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</b>

âŒ Ù‡ÛŒÚ† ØªÛŒÚ©ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!

ğŸ« Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.`;

      const keyboard = {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ« Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯', callback_data: 'create_ticket' }],
            [{ text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', callback_data: 'support_menu' }]
          ]
        }
      };

      await editMessage(chatId, messageId, noTicketsText, keyboard);
      return;
    }

    let ticketsText = `ğŸ“‚ <b>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</b>\n\n`;
    const keyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    const tickets = [];
    for (const key of userTicketsResult.keys) {
      const ticket = await kv.get(key.name, 'json');
      if (ticket) {
        tickets.push(ticket);
      }
    }

    // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ§Ø±ÛŒØ®
    tickets.sort((a, b) => b.createdAt - a.createdAt);

    tickets.forEach((ticket, index) => {
      const statusEmoji = ticket.status === 'open' ? 'ğŸŸ¢' : 'ğŸ”´';
      const statusText = ticket.status === 'open' ? 'Ø¨Ø§Ø²' : 'Ø¨Ø³ØªÙ‡';
      
      ticketsText += `${index + 1}ï¸âƒ£ ${statusEmoji} <b>${ticket.typeName}</b>
ğŸ†” ${ticket.id}
ğŸ“ ${ticket.subject}
ğŸ“… ${formatDate(ticket.createdAt)}
ğŸ”¸ ÙˆØ¶Ø¹ÛŒØª: ${statusText}

`;

      keyboard.reply_markup.inline_keyboard.push([{
        text: `ğŸ’¬ ${ticket.typeName} (${statusText})`,
        callback_data: `view_ticket_${ticket.id}`
      }]);
    });

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ« Ø«Ø¨Øª ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯',
      callback_data: 'create_ticket'
    }]);

    keyboard.reply_markup.inline_keyboard.push([{
      text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ',
      callback_data: 'support_menu'
    }]);

    await editMessage(chatId, messageId, ticketsText, keyboard);

  } catch (error) {
    console.error('Error showing tickets:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§.', KEYBOARDS.backToSupport);
  }
}

// Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª
async function showTicketDetails(chatId, messageId, ticketId, kv) {
  try {
    const ticketKey = `ticket_${chatId}_${ticketId}`;
    const ticket = await kv.get(ticketKey, 'json');
    
    if (!ticket) {
      await editMessage(chatId, messageId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToSupport);
      return;
    }

    const statusEmoji = ticket.status === 'open' ? 'ğŸŸ¢' : 'ğŸ”´';
    const statusText = ticket.status === 'open' ? 'Ø¨Ø§Ø²' : 'Ø¨Ø³ØªÙ‡';

    let ticketText = `ğŸ’¬ <b>ØªÛŒÚ©Øª ${ticket.typeName}</b>

ğŸ†” Ø´Ù…Ø§Ø±Ù‡: <code>${ticket.id}</code>
ğŸ“… ØªØ§Ø±ÛŒØ®: ${formatDate(ticket.createdAt)}
ğŸ”¸ ÙˆØ¶Ø¹ÛŒØª: ${statusEmoji} ${statusText}

ğŸ“ <b>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:</b>

`;

    // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    ticket.messages.forEach((msg, index) => {
      const fromEmoji = msg.from === 'user' ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ’¼';
      const fromText = msg.from === 'user' ? 'Ø´Ù…Ø§' : 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ';
      const time = formatDateTime(msg.timestamp);
      
      ticketText += `${fromEmoji} <b>${fromText}</b> - ${time}
${msg.message}

`;
    });

    const keyboardButtons = [];
    
    if (ticket.status === 'open') {
      keyboardButtons.push([
        { text: 'ğŸ’¬ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†', callback_data: `reply_ticket_user_${ticket.id}` },
        { text: 'ğŸ”’ Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª', callback_data: `close_ticket_user_${ticket.id}` }
      ]);
    }
    
    keyboardButtons.push([{ text: 'ğŸ”™ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_tickets' }]);

    const keyboard = {
      reply_markup: {
        inline_keyboard: keyboardButtons
      }
    };

    await editMessage(chatId, messageId, ticketText, keyboard);

  } catch (error) {
    console.error('Error showing ticket details:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ©Øª.', KEYBOARDS.backToSupport);
  }
}

// Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ ØªÛŒÚ©Øª
async function userReplyTicket(chatId, messageId, ticketId, kv) {
  const ticketKey = `ticket_${chatId}_${ticketId}`;
  const ticket = await kv.get(ticketKey, 'json');
  
  if (!ticket || ticket.status !== 'open') {
    await editMessage(chatId, messageId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø¨Ø³ØªÙ‡ Ø§Ø³Øª!', KEYBOARDS.backToSupport);
    return;
  }

  // Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÚ©Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±
  await kv.put(`pending_user_reply_${chatId}`, JSON.stringify({
    ticketId: ticketId,
    ticketKey: ticketKey,
    userChatId: chatId,
    userMessageId: messageId,
    createdAt: Date.now()
  }));

  const replyText = `ğŸ’¬ <b>Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÛŒÚ©Øª</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticket.typeName}

ğŸ“ Ù¾ÛŒØ§Ù… Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:

ğŸ’¡ Ø­Ø¯Ø§Ú©Ø«Ø± 500 Ú©Ø§Ø±Ø§Ú©ØªØ±
ğŸ“¤ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...`;

  await editMessage(chatId, messageId, replyText, KEYBOARDS.backToSupport);
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ú©Ø§Ø±Ø¨Ø±
async function processUserTicketReply(chatId, messageText, kv) {
  const pendingReply = await kv.get(`pending_user_reply_${chatId}`, 'json');
  
  if (!pendingReply) {
    return; // Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª
  }

  if (messageText.length > 500) {
    await sendMessage(chatId, 'âŒ Ù¾ÛŒØ§Ù… Ø¨ÛŒØ´ Ø§Ø² 500 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø³Øª!');
    return;
  }

  const ticket = await kv.get(pendingReply.ticketKey, 'json');
  
  if (!ticket || ticket.status !== 'open') {
    await sendMessage(chatId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ø¨Ø³ØªÙ‡ Ø§Ø³Øª!');
    await kv.delete(`pending_user_reply_${chatId}`);
    return;
  }

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø®
  ticket.messages.push({
    from: 'user',
    message: messageText,
    timestamp: Date.now()
  });

  await kv.put(pendingReply.ticketKey, JSON.stringify(ticket));
  await kv.delete(`pending_user_reply_${chatId}`);

  // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø¯ÛŒØ±
  const adminNotification = `ğŸ’¬ <b>Ù¾Ø§Ø³Ø® Ø¬Ø¯ÛŒØ¯ Ø¯Ø± ØªÛŒÚ©Øª</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticket.id}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${ticket.chatId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticket.typeName}

ğŸ’¬ <b>Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯:</b>
${messageText}

ğŸ“… ${formatDateTime(Date.now())}`;

  const adminKeyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ’¬ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†', callback_data: `reply_ticket_${ticket.id}` }],
        [{ text: 'ğŸ”’ Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª', callback_data: `close_ticket_${ticket.id}` }]
      ]
    }
  };

  await sendMessage(ADMIN_ID, adminNotification, adminKeyboard);

  // ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
  await sendMessage(chatId, `âœ… Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª ${ticket.id} Ø«Ø¨Øª Ø´Ø¯!

â° Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø§Ø´ÛŒØ¯.`, KEYBOARDS.backToSupport);
}

// Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
async function closeTicketByUser(chatId, messageId, ticketId, kv) {
  try {
    const ticketKey = `ticket_${chatId}_${ticketId}`;
    const ticket = await kv.get(ticketKey, 'json');
    
    if (!ticket) {
      await editMessage(chatId, messageId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!', KEYBOARDS.backToSupport);
      return;
    }

    if (ticket.status !== 'open') {
      await editMessage(chatId, messageId, 'âŒ Ø§ÛŒÙ† ØªÛŒÚ©Øª Ù‚Ø¨Ù„Ø§Ù‹ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª!', KEYBOARDS.backToSupport);
      return;
    }

    // Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª
    ticket.status = 'closed';
    ticket.closedAt = Date.now();
    ticket.closedBy = 'user';

    await kv.put(ticketKey, JSON.stringify(ticket));

    // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ù…Ø¯ÛŒØ±
    const adminNotification = `ğŸ”’ <b>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticket.id}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${ticket.chatId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticket.typeName}

âœ… ØªÛŒÚ©Øª ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ø¨Ø³ØªÙ‡ Ø´Ø¯
ğŸ“… ${formatDateTime(Date.now())}`;

    await sendMessage(ADMIN_ID, adminNotification);

    // ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
    const confirmText = `ğŸ”’ <b>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticket.typeName}

âœ… ØªÛŒÚ©Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø³ØªÙ‡ Ø´Ø¯
ğŸ“… ${formatDateTime(Date.now())}

ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯`;

    await editMessage(chatId, messageId, confirmText, KEYBOARDS.backToSupport);

  } catch (error) {
    console.error('Error closing ticket by user:', error);
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª.', KEYBOARDS.backToSupport);
  }
}

// Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ù…Ø¯ÛŒØ±
async function notifyAdminNewTicket(ticketData) {
  try {
    const adminText = `ğŸ« <b>ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!</b>

ğŸ†” Ø´Ù…Ø§Ø±Ù‡ ØªÛŒÚ©Øª: <code>${ticketData.id}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${ticketData.chatId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticketData.typeName}
ğŸ“… ØªØ§Ø±ÛŒØ®: ${formatDateTime(ticketData.createdAt)}

ğŸ’¬ <b>Ù¾ÛŒØ§Ù…:</b>
${ticketData.message}

ğŸŒ <b>Ù¾Ù†Ù„ ÙˆØ¨:</b> Ø¢Ø¯Ø±Ø³ ÙˆØ±Ú©Ø± + /admin`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ’¬ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†', callback_data: `reply_ticket_${ticketData.id}` }],
          [{ text: 'ğŸ”’ Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª', callback_data: `close_ticket_${ticketData.id}` }]
        ]
      }
    };

    await sendMessage(ADMIN_ID, adminText, keyboard);

  } catch (error) {
    console.error('Error notifying admin about new ticket:', error);
  }
}

// Ù¾Ø§Ø³Ø® Ù…Ø¯ÛŒØ± Ø¨Ù‡ ØªÛŒÚ©Øª
async function adminReplyTicket(chatId, messageId, ticketId, kv) {
  if (!isAdmin(chatId)) return;

  // Ø°Ø®ÛŒØ±Ù‡ ØªÛŒÚ©Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø§Ø³Ø®
  await kv.put(`pending_reply_${chatId}`, JSON.stringify({
    ticketId: ticketId,
    adminChatId: chatId,
    adminMessageId: messageId,
    createdAt: Date.now()
  }));

  const replyText = `ğŸ’¬ <b>Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÛŒÚ©Øª</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketId}</code>

ğŸ“ Ù¾ÛŒØ§Ù… Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:

ğŸ’¡ Ø­Ø¯Ø§Ú©Ø«Ø± 1000 Ú©Ø§Ø±Ø§Ú©ØªØ±
ğŸ“¤ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ù‡Ø³ØªÛŒÙ…...`;

  await editMessage(chatId, messageId, replyText, {});
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ù…Ø¯ÛŒØ±
async function processAdminReply(chatId, messageText, kv) {
  const pendingReply = await kv.get(`pending_reply_${chatId}`, 'json');
  
  if (!pendingReply) {
    return; // Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª
  }

  if (messageText.length > 1000) {
    await sendMessage(chatId, 'âŒ Ù¾ÛŒØ§Ù… Ø¨ÛŒØ´ Ø§Ø² 1000 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø§Ø³Øª!');
    return;
  }

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÛŒÚ©Øª
  const allTickets = await kv.list('ticket_');
  let ticketData = null;
  let ticketKey = null;

  for (const key of allTickets.keys) {
    const ticket = await kv.get(key.name, 'json');
    if (ticket && ticket.id === pendingReply.ticketId) {
      ticketData = ticket;
      ticketKey = key.name;
      break;
    }
  }

  if (!ticketData) {
    await sendMessage(chatId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!');
    await kv.delete(`pending_reply_${chatId}`);
    return;
  }

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø®
  ticketData.messages.push({
    from: 'admin',
    message: messageText,
    timestamp: Date.now()
  });

  await kv.put(ticketKey, JSON.stringify(ticketData));
  await kv.delete(`pending_reply_${chatId}`);

  // Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
  const userNotification = `ğŸ’¬ <b>Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketData.id}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticketData.typeName}

ğŸ‘¨â€ğŸ’¼ <b>Ù¾Ø§Ø³Ø® Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ:</b>
${messageText}

ğŸ“… ${formatDateTime(Date.now())}`;

  const userKeyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ’¬ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øª', callback_data: `view_ticket_${ticketData.id}` }],
        [{ text: 'ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_tickets' }]
      ]
    }
  };

  await sendMessage(ticketData.chatId, userNotification, userKeyboard);

  // ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±
  await sendMessage(chatId, `âœ… Ù¾Ø§Ø³Ø® Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ ØªÛŒÚ©Øª ${ticketData.id} Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!`);
}

// Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±
async function closeTicketByAdmin(chatId, messageId, ticketId, kv) {
  if (!isAdmin(chatId)) return;

  // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÛŒÚ©Øª
  const allTickets = await kv.list('ticket_');
  let ticketData = null;
  let ticketKey = null;

  for (const key of allTickets.keys) {
    const ticket = await kv.get(key.name, 'json');
    if (ticket && ticket.id === ticketId) {
      ticketData = ticket;
      ticketKey = key.name;
      break;
    }
  }

  if (!ticketData) {
    await editMessage(chatId, messageId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!', {});
    return;
  }

  // Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª
  ticketData.status = 'closed';
  ticketData.closedAt = Date.now();
  ticketData.closedBy = 'admin';

  await kv.put(ticketKey, JSON.stringify(ticketData));

  // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
  const userNotification = `ğŸ”’ <b>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketData.id}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticketData.typeName}

âœ… ØªÛŒÚ©Øª Ø´Ù…Ø§ ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯
ğŸ“… ${formatDateTime(Date.now())}

ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯`;

  await sendMessage(ticketData.chatId, userNotification, KEYBOARDS.backToSupport);

  // ØªØ£ÛŒÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±
  const adminConfirm = `âœ… <b>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticketId}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${ticketData.chatId}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticketData.typeName}`;

  await editMessage(chatId, messageId, adminConfirm, {});
}

// Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
async function sendReceiptToAdmin(messageData, referenceId, type) {
  try {
    const caption = `ğŸ“„ <b>Ø±Ø³ÛŒØ¯ ${type}</b>\n\nğŸ†” Ø´Ù†Ø§Ø³Ù‡: <code>${referenceId}</code>\nğŸ“… Ø²Ù…Ø§Ù†: ${formatDateTime(Date.now())}`;
    
    if (messageData.photo && messageData.photo.length > 0) {
      // Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ Ø±Ø³ÛŒØ¯
      const photo = messageData.photo[messageData.photo.length - 1]; // Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø³Ø§ÛŒØ²
      await sendPhoto(ADMIN_ID, photo.file_id, caption);
    } else if (messageData.document) {
      // Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ø±Ø³ÛŒØ¯
      const url = `${TELEGRAM_API}/sendDocument`;
      const payload = {
        chat_id: ADMIN_ID,
        document: messageData.document.file_id,
        caption: caption,
        parse_mode: 'HTML'
      };
      
      await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
    } else if (messageData.text) {
      // Ø§Ú¯Ø± Ù…ØªÙ† Ø¨Ø§Ø´Ù‡ (Ø´Ø§ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ ØªØ±Ø§Ú©Ù†Ø´)
      await sendMessage(ADMIN_ID, `${caption}\n\nğŸ“ Ù…ØªÙ† Ø±Ø³ÛŒØ¯:\n${messageData.text}`);
    } else {
      await sendMessage(ADMIN_ID, `${caption}\n\nâš ï¸ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„ Ø±Ø³ÛŒØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯`);
    }
    
    return true;
  } catch (error) {
    console.error('Error sending receipt to admin:', error);
    return false;
  }
}
// Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
async function notifyAdminNewPayment(orderData, receiptData = null) {
  try {
    const adminText = `ğŸ”” <b>Ø±Ø³ÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¬Ø¯ÛŒØ¯!</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderData.id}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${orderData.chatId}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}
${orderData.type === 'renewal' ? `ğŸ”„ Ù†ÙˆØ¹: ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³\nğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: ${orderData.serviceData.username}\n` : `ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${orderData.serverName}\n`}

ğŸ• Ø²Ù…Ø§Ù†: ${formatDateTime(orderData.paymentSubmittedAt)}`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'âœ… ØªØ£ÛŒÛŒØ¯', callback_data: `approve_payment_${orderData.id}` },
            { text: 'âŒ Ø±Ø¯', callback_data: `reject_payment_${orderData.id}` }
          ]
        ]
      }
    };

    // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø§ÙˆÙ„ÛŒÙ‡
    const sentMessage = await sendMessage(ADMIN_ID, adminText, keyboard);
    if (!sentMessage.ok) throw new Error('Failed to send message to admin');

    // Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯
    if (receiptData) {
      await sendReceiptToAdmin(receiptData, orderData.id, "Ø³ÙØ§Ø±Ø´");
    }

    return true;
  } catch (error) {
    console.error('Error notifying admin about payment:', error);
    return false;
  }
}

// Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† - Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡
async function notifyAdminNewChargePayment(chargeData, receiptData = null) {
  try {
    const adminText = `ğŸ’° <b>Ø±Ø³ÛŒØ¯ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¬Ø¯ÛŒØ¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeData.id}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${chargeData.chatId}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ• Ø²Ù…Ø§Ù†: ${formatDateTime(chargeData.paymentSubmittedAt)}`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'âœ… ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜', callback_data: `approve_charge_${chargeData.id}` },
            { text: 'âŒ Ø±Ø¯ Ø´Ø§Ø±Ú˜', callback_data: `reject_charge_${chargeData.id}` }
          ]
        ]
      }
    };

    // Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ø§ÙˆÙ„ÛŒÙ‡
    const sentMessage = await sendMessage(ADMIN_ID, adminText, keyboard);
    if (!sentMessage.ok) throw new Error('Failed to send message to admin');

    // Ø§Ø±Ø³Ø§Ù„ Ø±Ø³ÛŒØ¯
    if (receiptData) {
      await sendReceiptToAdmin(receiptData, chargeData.id, "Ø´Ø§Ø±Ú˜");
    }

    return true;
  } catch (error) {
    console.error('Error notifying admin about charge:', error);
    return false;
  }
}

// Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø³Ø±ÙˆØ± Ø¨Ø§ Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ù…Ø±Ø¬Ø¹
async function createServerService(orderData, kv) {
  try {
    const servers = await getServers(kv);
    const server = servers[orderData.serverId];
    
    if (!server) {
      return { success: false, error: 'Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯' };
    }

    const api = new MarzbanAPI(server.baseUrl);
    const loginResult = await api.login(server.username, server.password);
    
    if (!loginResult.success) {
      return { success: false, error: `Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${loginResult.error}` };
    }

    // Ø¯Ø±ÛŒØ§ÙØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯
    const inboundSettings = await getInboundSettings(kv);
    let inbounds = {};

    if (inboundSettings.referenceUsername) {
      const refUserResult = await api.getUser(inboundSettings.referenceUsername);
      if (refUserResult.success && refUserResult.data.inbounds) {
        inbounds = refUserResult.data.inbounds;
      } else {
        const inboundsResult = await api.getInbounds();
        if (inboundsResult.success) {
          inboundsResult.data.forEach(inbound => {
            if (inbound.type && inbound.tag) {
              const protocol = inbound.type.toLowerCase();
              if (!inbounds[protocol]) {
                inbounds[protocol] = [];
              }
              inbounds[protocol].push(inbound.tag);
            }
          });
        }
      }
    } else {
      const inboundsResult = await api.getInbounds();
      if (!inboundsResult.success) {
        return { success: false, error: 'Ù†ØªÙˆØ§Ù†Ø³Øª Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯Ù‡Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯' };
      }

      inboundsResult.data.forEach(inbound => {
        if (inbound.type && inbound.tag) {
          const protocol = inbound.type.toLowerCase();
          if (!inbounds[protocol]) {
            inbounds[protocol] = [];
          }
          inbounds[protocol].push(inbound.tag);
        }
      });
    }

    const username = generateUsername(orderData.chatId, orderData.plan.id);
    const expireTimestamp = Math.floor(Date.now() / 1000) + (orderData.plan.duration * 24 * 60 * 60);
    
    const userData = {
      username: username,
      data_limit: orderData.plan.dataLimit ? orderData.plan.dataLimit * 1024 * 1024 * 1024 : 0,
      expire: expireTimestamp,
      status: 'active',
      inbounds: inbounds,
      proxies: {}
    };

    Object.keys(inbounds).forEach(protocol => {
      userData.proxies[protocol] = {};
    });

    const createResult = await api.createUser(userData);
    
    if (!createResult.success) {
      return { success: false, error: createResult.error };
    }

    await new Promise(resolve => setTimeout(resolve, 2000)); // Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø±
    
    const userResult = await api.getUser(username);
    let configUrl = null;
    
    if (userResult.success && userResult.data.subscription_url) {
      configUrl = userResult.data.subscription_url.startsWith('http') ? 
                 userResult.data.subscription_url : 
                 `${api.baseUrl}${userResult.data.subscription_url}`;
    }

    const serviceId = generateServiceId();
    const serviceData = {
      serviceId: serviceId,
      chatId: orderData.chatId,
      username: username,
      planName: orderData.plan.name,
      planId: orderData.plan.id,
      dataLimit: orderData.plan.dataLimit,
      duration: orderData.plan.duration,
      expireTimestamp: expireTimestamp * 1000,
      configUrl: configUrl,
      status: 'active',
      createdAt: Date.now(),
      orderId: orderData.id,
      serverId: orderData.serverId,
      serverName: orderData.serverName
    };

    await kv.put(`service_${orderData.chatId}_${serviceId}`, JSON.stringify(serviceData));

    return { 
      success: true, 
      serviceData: serviceData 
    };

  } catch (error) {
    console.error('Error creating server service:', error);
    return { success: false, error: error.message };
  }
}

// ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ù…ÙˆØ¬ÙˆØ¯
async function renewExistingService(orderData, kv) {
  try {
    const servers = await getServers(kv);
    const server = servers[orderData.serviceData.serverId];
    
    if (!server) {
      return { success: false, error: 'Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯' };
    }

    const api = new MarzbanAPI(server.baseUrl);
    const loginResult = await api.login(server.username, server.password);
    
    if (!loginResult.success) {
      return { success: false, error: `Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ${loginResult.error}` };
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
    const currentExpire = Math.max(
      Math.floor(orderData.serviceData.expireTimestamp / 1000),
      Math.floor(Date.now() / 1000)
    );
    const newExpire = currentExpire + (orderData.plan.duration * 24 * 60 * 60);
    
    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ø¬Ù… Ø¬Ø¯ÛŒØ¯
    let newDataLimit = 0;
    if (orderData.plan.dataLimit > 0) {
      const currentLimit = orderData.serviceData.dataLimit || 0;
      newDataLimit = (currentLimit + orderData.plan.dataLimit) * 1024 * 1024 * 1024;
    }

    const updateData = {
      expire: newExpire,
      data_limit: newDataLimit,
      status: 'active'
    };

    const updateResult = await api.modifyUser(orderData.serviceData.username, updateData);
    
    if (!updateResult.success) {
      return { success: false, error: updateResult.error };
    }

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³
    const serviceResult = await findServiceById(orderData.chatId, orderData.serviceId, kv);
    if (serviceResult) {
      const updatedServiceData = {
        ...orderData.serviceData,
        expireTimestamp: newExpire * 1000,
        dataLimit: orderData.serviceData.dataLimit + (orderData.plan.dataLimit || 0),
        renewedAt: Date.now(),
        lastRenewalPlan: orderData.plan.name
      };

      await kv.put(serviceResult.key, JSON.stringify(updatedServiceData));

      return { 
        success: true, 
        serviceData: updatedServiceData 
      };
    }

    return { success: false, error: 'Ø³Ø±ÙˆÛŒØ³ ÛŒØ§ÙØª Ù†Ø´Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ' };

  } catch (error) {
    console.error('Error renewing service:', error);
    return { success: false, error: error.message };
  }
}

// ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±
async function approvePayment(chatId, messageId, orderId, kv) {
  if (!isAdmin(chatId)) return;

  try {
    const orderData = await kv.get(`order_${orderId}`, 'json');
    
    if (!orderData) {
      await editMessage(chatId, messageId, 'âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯!', {});
      return;
    }

    if (orderData.status !== 'payment_submitted') {
      await editMessage(chatId, messageId, 'âŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ù‚Ø§Ø¨Ù„ ØªØ£ÛŒÛŒØ¯ Ù†ÛŒØ³Øª!', {});
      return;
    }

    // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
    const processingMessage = await sendMessage(ADMIN_ID, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³ÙØ§Ø±Ø´...');

    let serviceResult;
    
    if (orderData.type === 'renewal') {
      serviceResult = await renewExistingService(orderData, kv);
    } else {
      serviceResult = await createServerService(orderData, kv);
    }
    
    // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ù¾Ø±Ø¯Ø§Ø²Ø´
    await deleteMessage(ADMIN_ID, processingMessage.result.message_id);
    
    if (!serviceResult.success) {
      await editMessage(chatId, messageId, 
        `âŒ Ø®Ø·Ø§ Ø¯Ø± ${orderData.type === 'renewal' ? 'ØªÙ…Ø¯ÛŒØ¯' : 'Ø§ÛŒØ¬Ø§Ø¯'} Ø³Ø±ÙˆÛŒØ³: ${serviceResult.error}`,
        {}
      );
      return;
    }

    orderData.status = 'completed';
    orderData.completedAt = Date.now();
    orderData.serviceData = serviceResult.serviceData;
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    await kv.delete(`user_order_${orderData.chatId}`);
    await kv.delete(`selected_plan_${orderData.chatId}`);

    if (orderData.type === 'renewal') {
      await notifyUserRenewalComplete(orderData, serviceResult.serviceData);
    } else {
      await notifyUserServiceReady(orderData, serviceResult.serviceData);
    }

    const successText = `âœ… <b>Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${orderData.chatId}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}
ğŸ”§ Ù†ÙˆØ¹: ${orderData.type === 'renewal' ? 'ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³' : 'Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³ Ø¬Ø¯ÛŒØ¯'}

ğŸ”§ ${orderData.type === 'renewal' ? 'Ø³Ø±ÙˆÛŒØ³ ØªÙ…Ø¯ÛŒØ¯ Ø´Ø¯' : 'Ø³Ø±ÙˆÛŒØ³ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯'} Ùˆ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`;

    await editMessage(chatId, messageId, successText, {});

  } catch (error) {
    console.error('Error approving payment:', error);
    await editMessage(chatId, messageId, 
      `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª: ${error.message}`,
      {}
    );
  }
}

// ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function approveCharge(chatId, messageId, chargeId, kv) {
  if (!isAdmin(chatId)) return;

  try {
    const chargeData = await kv.get(`wallet_charge_${chargeId}`, 'json');
    
    if (!chargeData) {
      await editMessage(chatId, messageId, 'âŒ Ø´Ø§Ø±Ú˜ ÛŒØ§ÙØª Ù†Ø´Ø¯!', {});
      return;
    }

    if (chargeData.status !== 'payment_submitted') {
      await editMessage(chatId, messageId, 'âŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø±Ú˜ Ù‚Ø§Ø¨Ù„ ØªØ£ÛŒÛŒØ¯ Ù†ÛŒØ³Øª!', {});
      return;
    }

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¨Ù„Øº Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
    const newBalance = await updateWalletBalance(chargeData.chatId, chargeData.amount, kv);
    if (newBalance === false) {
      await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ!', {});
      return;
    }

    // Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
    await recordWalletTransaction(chargeData.chatId, chargeData.amount, 'charge', `Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ - ${chargeId}`, kv);

    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø±Ú˜
    chargeData.status = 'completed';
    chargeData.completedAt = Date.now();
    await kv.put(`wallet_charge_${chargeId}`, JSON.stringify(chargeData));

    await kv.delete(`user_charge_${chargeData.chatId}`);

    // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
    const userNotification = `âœ… <b>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ’° Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜: ${formatPrice(chargeData.amount)}
ğŸ’³ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: ${formatPrice(newBalance)}

ğŸ‰ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ø´Ø§Ø±Ú˜ Ø´Ø¯!

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    await sendMessage(chargeData.chatId, userNotification, KEYBOARDS.backToWallet);

    const successText = `âœ… <b>Ø´Ø§Ø±Ú˜ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${chargeData.chatId}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ’³ Ù…Ø¨Ù„Øº Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;

    await editMessage(chatId, messageId, successText, {});

  } catch (error) {
    console.error('Error approving charge:', error);
    await editMessage(chatId, messageId, 
      `âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜: ${error.message}`,
      {}
    );
  }
}

// Ø±Ø¯ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
async function rejectCharge(chatId, messageId, chargeId, kv) {
  if (!isAdmin(chatId)) return;

  try {
    const chargeData = await kv.get(`wallet_charge_${chargeId}`, 'json');
    
    if (!chargeData) {
      await editMessage(chatId, messageId, 'âŒ Ø´Ø§Ø±Ú˜ ÛŒØ§ÙØª Ù†Ø´Ø¯!', {});
      return;
    }

    chargeData.status = 'rejected';
    chargeData.rejectedAt = Date.now();
    await kv.put(`wallet_charge_${chargeId}`, JSON.stringify(chargeData));

    await kv.delete(`user_charge_${chargeData.chatId}`);

    const rejectionText = `âŒ <b>Ø´Ø§Ø±Ú˜ ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ” Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:
â€¢ Ù…Ø¨Ù„Øº Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯Ù‡
â€¢ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§Ø´ØªØ¨Ø§Ù‡
â€¢ Ø±Ø³ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    const userKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ù…Ø¬Ø¯Ø¯', callback_data: 'wallet_charge' }],
          [{ text: 'ğŸ’¬ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
        ]
      }
    };

    await sendMessage(chargeData.chatId, rejectionText, userKeyboard);

    const successText = `âŒ <b>Ø´Ø§Ø±Ú˜ Ø±Ø¯ Ø´Ø¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${chargeData.chatId}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ“¤ Ù¾ÛŒØ§Ù… Ø±Ø¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`;

    await editMessage(chatId, messageId, successText, {});

  } catch (error) {
    console.error('Error rejecting charge:', error);
    await editMessage(chatId, messageId, 
      `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø´Ø§Ø±Ú˜: ${error.message}`,
      {}
    );
  }
}

// Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±
async function rejectPaymentByAdmin(chatId, messageId, orderId, kv) {
  if (!isAdmin(chatId)) return;

  try {
    const orderData = await kv.get(`order_${orderId}`, 'json');
    
    if (!orderData) {
      await editMessage(chatId, messageId, 'âŒ Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯!', {});
      return;
    }

    orderData.status = 'rejected';
    orderData.rejectedAt = Date.now();
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    await kv.delete(`user_order_${orderData.chatId}`);
    await kv.delete(`selected_plan_${orderData.chatId}`);

    const rejectionText = `âŒ <b>Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}
${orderData.type === 'renewal' ? `ğŸ”„ Ù†ÙˆØ¹: ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³\n` : ''}

ğŸ” Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:
â€¢ Ù…Ø¨Ù„Øº Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯Ù‡
â€¢ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§Ø´ØªØ¨Ø§Ù‡
â€¢ Ø±Ø³ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    const userKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯', callback_data: 'buy_service' }],
          [{ text: 'ğŸ’¬ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
        ]
      }
    };

    await sendMessage(orderData.chatId, rejectionText, userKeyboard);

    const successText = `âŒ <b>Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø¯ Ø´Ø¯!</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${orderData.chatId}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}

ğŸ“¤ Ù¾ÛŒØ§Ù… Ø±Ø¯ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.`;

    await editMessage(chatId, messageId, successText, {});

  } catch (error) {
    console.error('Error rejecting payment:', error);
    await editMessage(chatId, messageId, 
      `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª: ${error.message}`,
      {}
    );
  }
}

async function notifyUserRenewalComplete(orderData, serviceData) {
  try {
    const notificationText = `ğŸ‰ <b>ØªÙ…Ø¯ÛŒØ¯ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯!</b>

âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯

ğŸ“¦ <b>Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙ…Ø¯ÛŒØ¯:</b>
ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderData.id}</code>
ğŸ“‹ ØªÙ…Ø¯ÛŒØ¯: ${orderData.plan.name}
ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
â° Ø²Ù…Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ${orderData.plan.duration} Ø±ÙˆØ²
ğŸ“Š Ø­Ø¬Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡: ${orderData.plan.dataLimit ? orderData.plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
ğŸ“… Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: ${formatDate(serviceData.expireTimestamp)}

ğŸ’¡ Ø²Ù…Ø§Ù† Ùˆ Ø­Ø¬Ù… Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ Ù‚Ø¨Ù„ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }],
          [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
        ]
      }
    };

    await sendMessage(orderData.chatId, notificationText, keyboard);

  } catch (error) {
    console.error('Error notifying user about renewal:', error);
  }
}

// API ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
async function approvePaymentAPI(orderId, kv) {
  try {
    const orderData = await kv.get(`order_${orderId}`, 'json');
    
    if (!orderData) {
      return { success: false, error: 'Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯' };
    }

    if (orderData.status !== 'payment_submitted') {
      return { success: false, error: 'ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´ Ù‚Ø§Ø¨Ù„ ØªØ£ÛŒÛŒØ¯ Ù†ÛŒØ³Øª' };
    }

    let serviceResult;
    
    if (orderData.type === 'renewal') {
      serviceResult = await renewExistingService(orderData, kv);
    } else {
      serviceResult = await createServerService(orderData, kv);
    }
    
    if (!serviceResult.success) {
      return { success: false, error: serviceResult.error };
    }

    orderData.status = 'completed';
    orderData.completedAt = Date.now();
    orderData.serviceData = serviceResult.serviceData;
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    await kv.delete(`user_order_${orderData.chatId}`);
    await kv.delete(`selected_plan_${orderData.chatId}`);

    if (orderData.type === 'renewal') {
      await notifyUserRenewalComplete(orderData, serviceResult.serviceData);
    } else {
      await notifyUserServiceReady(orderData, serviceResult.serviceData);
    }

    return { success: true, message: 'Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯' };

  } catch (error) {
    console.error('Error approving payment API:', error);
    return { success: false, error: error.message };
  }
}

// API Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª  
async function rejectPaymentAPI(orderId, kv) {
  try {
    const orderData = await kv.get(`order_${orderId}`, 'json');
    
    if (!orderData) {
      return { success: false, error: 'Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯' };
    }

    orderData.status = 'rejected';
    orderData.rejectedAt = Date.now();
    await kv.put(`order_${orderId}`, JSON.stringify(orderData));

    await kv.delete(`user_order_${orderData.chatId}`);
    await kv.delete(`selected_plan_${orderData.chatId}`);

    const rejectionText = `âŒ <b>Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯</b>

ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderId}</code>
ğŸ“¦ Ù¾Ù„Ù†: ${orderData.plan.name}
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(orderData.plan.price)}
${orderData.type === 'renewal' ? `ğŸ”„ Ù†ÙˆØ¹: ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³\n` : ''}

ğŸ” Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:
â€¢ Ù…Ø¨Ù„Øº Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯Ù‡
â€¢ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§Ø´ØªØ¨Ø§Ù‡
â€¢ Ø±Ø³ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    const userKeyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ›’ Ø®Ø±ÛŒØ¯ Ù…Ø¬Ø¯Ø¯', callback_data: 'buy_service' }],
          [{ text: 'ğŸ’¬ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
        ]
      }
    };

    await sendMessage(orderData.chatId, rejectionText, userKeyboard);

    return { success: true, message: 'Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø¯ Ø´Ø¯' };

  } catch (error) {
    console.error('Error rejecting payment API:', error);
    return { success: false, error: error.message };
  }
}

// Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± - Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯Ø§
async function notifyUserServiceReady(orderData, serviceData) {
  try {
    // Ø§Ø±Ø³Ø§Ù„ Ú©Ø§Ù†ÙÛŒÚ¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø¯ÙˆÙ† Ø¯Ú©Ù…Ù‡
    if (serviceData.configUrl) {
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&format=png&data=${encodeURIComponent(serviceData.configUrl)}`;
      
      const configText = `ğŸ”— <b>Ú©Ø§Ù†ÙÛŒÚ¯ Ø³Ø±ÙˆÛŒØ³ Ø´Ù…Ø§</b>

ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>

ğŸ”— <b>Ù„ÛŒÙ†Ú© Ø§Ø´ØªØ±Ø§Ú©:</b>
<code>${serviceData.configUrl}</code>

ğŸ’¡ <b>Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>
â€¢ QR Ú©Ø¯ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯
â€¢ Ø¯Ø± Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† VPN ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯

ğŸ“± <b>Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù†â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:</b>
ğŸ¤– Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯: V2rayNG
ğŸ Ø¢ÛŒÙÙˆÙ†: Fair VPN ÛŒØ§ Shadowrocket
ğŸ’» ÙˆÛŒÙ†Ø¯ÙˆØ²: V2rayN
ğŸ–¥ï¸ Ù…Ú©: ClashX
ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ: /start`;

      await sendPhoto(orderData.chatId, qrUrl, configText);
    }

    // Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§
    const successText = `ğŸ‰ <b>Ø³Ø±ÙˆÛŒØ³ ${orderData.plan.name} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯!</b>

ğŸ“¦ <b>Ø¬Ø²Ø¦ÛŒØ§Øª Ø³Ø±ÙˆÛŒØ³:</b>
ğŸ†” Ø³ÙØ§Ø±Ø´: <code>${orderData.id}</code>
ğŸ‘¤ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ: <code>${serviceData.username}</code>
ğŸ“Š Ø­Ø¬Ù…: ${orderData.plan.dataLimit ? orderData.plan.dataLimit + ' Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}
â° Ù…Ø¯Øª: ${orderData.plan.duration} Ø±ÙˆØ²
ğŸ“… ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: ${formatDate(serviceData.expireTimestamp)}
ğŸ–¥ï¸ Ø³Ø±ÙˆØ±: ${orderData.serverName}

â° <b>Ø²Ù…Ø§Ù† Ø³Ø§Ø®Øª:</b> ${formatDateTime(Date.now())}

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', callback_data: 'my_services' }],
          [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
        ]
      }
    };

    await sendMessage(orderData.chatId, successText, keyboard);

  } catch (error) {
    console.error('Error notifying user:', error);
  }
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø± Ø¯Ø±Ø¢Ù…Ø¯
async function calculateRevenue(kv) {
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayTimestamp = today.getTime();

    const ordersResult = await kv.list('order_ORD_');
    let todayRevenue = 0;
    let todayOrders = 0;
    let totalRevenue = 0;

    for (const key of ordersResult.keys) {
      const order = await kv.get(key.name, 'json');
      if (order && order.status === 'completed') {
        totalRevenue += order.plan.price;
        
        if (order.completedAt >= todayTimestamp) {
          todayRevenue += order.plan.price;
          todayOrders++;
        }
      }
    }

    return {
      todayRevenue,
      todayOrders,
      totalRevenue
    };
  } catch (error) {
    console.error('Error calculating revenue:', error);
    return { todayRevenue: 0, todayOrders: 0, totalRevenue: 0 };
  }
}

// ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¨
function getAdminWebPanel() {
  return `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ARDISK VPN</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        * { 
            font-family: 'Vazirmatn', 'Tahoma', Arial, sans-serif !important;
        }
        .dark { background: #1a1a1a; color: #ffffff; }
        .tab-button.active {
            color: #3B82F6;
            border-color: #3B82F6;
        }
        .tab-button {
            color: #6B7280;
            border-color: transparent;
            transition: all 0.2s;
        }
        .tab-button:hover {
            color: #3B82F6;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .dark .modal-content {
            background-color: #374151;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-shield-alt text-2xl text-blue-600 ml-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ARDISK VPN</h1>
                </div>
                <div class="flex items-center space-x-4 space-x-reverse">
                    <span class="text-sm text-gray-600 dark:text-gray-300">Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ…</span>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt ml-2"></i>Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                        <i class="fas fa-shopping-cart text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="todayOrders">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                        <i class="fas fa-money-bill-wave text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="todayRevenue">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900">
                        <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="pendingPayments">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-orange-100 dark:bg-orange-900">
                        <i class="fas fa-wallet text-orange-600 dark:text-orange-400"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ø´Ø§Ø±Ú˜ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="pendingCharges">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900">
                        <i class="fas fa-tickets text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div class="mr-4">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²</p>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white" id="openTickets">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav class="-mb-px flex overflow-x-auto">
                    <button onclick="showTab('payments')" id="paymentsTab" class="tab-button active flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-credit-card ml-2"></i>Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§
                    </button>
                    <button onclick="showTab('charges')" id="chargesTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-wallet ml-2"></i>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
                    </button>
                    <button onclick="showTab('orders')" id="ordersTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-list ml-2"></i>Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
                    </button>
                    <button onclick="showTab('tickets')" id="ticketsTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-ticket-alt ml-2"></i>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
                    </button>
                    <button onclick="showTab('plans')" id="plansTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-clipboard-list ml-2"></i>Ù¾Ù„Ù†â€ŒÙ‡Ø§
                    </button>
                    <button onclick="showTab('servers')" id="serversTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-server ml-2"></i>Ø³Ø±ÙˆØ±Ù‡Ø§
                    </button>
                    <button onclick="showTab('users')" id="usersTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-users ml-2"></i>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                    </button>
                    <button onclick="showTab('settings')" id="settingsTab" class="tab-button flex-shrink-0 w-auto py-4 px-4 text-center border-b-2 font-medium text-sm">
                        <i class="fas fa-cog ml-2"></i>ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                    </button>
                </nav>
            </div>

            <!-- Payments Tab -->
            <div id="paymentsContent" class="tab-content p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</h2>
                    <button onclick="refreshPayments()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt ml-2"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
                <div id="pendingPaymentsList" class="space-y-4">
                    <!-- Pending payments will be loaded here -->
                </div>
            </div>

            <!-- Charges Tab -->
            <div id="chargesContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</h2>
                    <button onclick="refreshCharges()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt ml-2"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
                <div id="pendingChargesList" class="space-y-4">
                    <!-- Pending charges will be loaded here -->
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">ØªÙ…Ø§Ù… Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§</h2>
                    <button onclick="loadOrders()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt ml-2"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
                <div id="ordersList" class="space-y-4">
                    <!-- Orders will be loaded here -->
                </div>
            </div>

            <!-- Tickets Tab -->
            <div id="ticketsContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</h2>
                    <button onclick="loadTickets()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt ml-2"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
                <div id="ticketsList" class="space-y-4">
                    <!-- Tickets will be loaded here -->
                </div>
            </div>

            <!-- Plans Management Tab -->
            <div id="plansContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§</h2>
                    <button onclick="showAddPlanModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-plus ml-2"></i>Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù†
                    </button>
                </div>
                <div id="plansList" class="space-y-4">
                    <!-- Plans will be loaded here -->
                </div>
            </div>

            <!-- Servers Management Tab -->
            <div id="serversContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§</h2>
                    <button onclick="showAddServerModal()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        <i class="fas fa-plus ml-2"></i>Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ±
                    </button>
                </div>
                <div id="serversList" class="space-y-4">
                    <!-- Servers will be loaded here -->
                </div>
            </div>

            <!-- Users Tab -->
            <div id="usersContent" class="tab-content p-6 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø³ÛŒØ³ØªÙ…</h2>
                    <button onclick="loadUsers()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i class="fas fa-sync-alt ml-2"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                    </button>
                </div>
                <div id="usersList" class="space-y-4">
                    <!-- Users will be loaded here -->
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsContent" class="tab-content p-6 hidden">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª:</label>
                                <input type="text" value="${PAYMENT_INFO.cardNumber}" readonly class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-600">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ø¯Ø§Ø±Ù†Ø¯Ù‡:</label>
                                <input type="text" value="${PAYMENT_INFO.cardHolder}" readonly class="w-full p-2 border rounded-lg bg-gray-100 dark:bg-gray-600">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                        <h3 class="font-semibold mb-4">Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯ Ú©Ø§Ø±Ø¨Ø± Ù…Ø±Ø¬Ø¹</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø±Ø¬Ø¹:</label>
                                <input type="text" id="referenceUsername" placeholder="Ø¨Ø±Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ… Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯Ù‡Ø§" class="w-full p-2 border rounded-lg">
                            </div>
                            <button onclick="saveInboundSettings()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-save ml-2"></i>Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                            </button>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                Ø¯Ø± ØµÙˆØ±Øª ØªÙ†Ø¸ÛŒÙ…ØŒ Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ú©Ù¾ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Plan Modal -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù† Ø¬Ø¯ÛŒØ¯</h3>
            <form id="addPlanForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ù¾Ù„Ù†:</label>
                    <input type="text" id="planName" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†):</label>
                    <input type="number" id="planPrice" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø± (Ø±ÙˆØ²):</label>
                    <input type="number" id="planDuration" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø­Ø¬Ù… ØªØ±Ø§ÙÛŒÚ© (Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª) - 0 Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯:</label>
                    <input type="number" id="planDataLimit" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                    <textarea id="planDescription" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-save ml-2"></i>Ø°Ø®ÛŒØ±Ù‡
                    </button>
                    <button type="button" onclick="hideModal('addPlanModal')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Plan Modal -->
    <div id="editPlanModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ù„Ù†</h3>
            <form id="editPlanForm" class="space-y-4">
                <input type="hidden" id="editPlanId">
                <div>
                    <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ù¾Ù„Ù†:</label>
                    <input type="text" id="editPlanName" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù‚ÛŒÙ…Øª (ØªÙˆÙ…Ø§Ù†):</label>
                    <input type="number" id="editPlanPrice" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù…Ø¯Øª Ø§Ø¹ØªØ¨Ø§Ø± (Ø±ÙˆØ²):</label>
                    <input type="number" id="editPlanDuration" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø­Ø¬Ù… ØªØ±Ø§ÙÛŒÚ© (Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª) - 0 Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯:</label>
                    <input type="number" id="editPlanDataLimit" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                    <textarea id="editPlanDescription" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        <i class="fas fa-save ml-2"></i>Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                    </button>
                    <button type="button" onclick="hideModal('editPlanModal')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Server Modal -->
    <div id="addServerModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯</h3>
            <form id="addServerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ø³Ø±ÙˆØ±:</label>
                    <input type="text" id="serverName" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø¢Ø¯Ø±Ø³ Ù¾Ø§ÛŒÙ‡:</label>
                    <input type="url" id="serverBaseUrl" required placeholder="https://example.com:2053" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ø±Ø²Ø¨Ø§Ù†:</label>
                    <input type="text" id="serverUsername" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø±Ø²Ø¨Ø§Ù†:</label>
                    <input type="password" id="serverPassword" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Ù…ÙˆÙ‚Ø¹ÛŒØª:</label>
                    <input type="text" id="serverLocation" required class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
                    <textarea id="serverDescription" rows="3" class="w-full p-2 border rounded-lg"></textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="serverIsDefault" class="ml-2">
                    <label for="serverIsDefault" class="text-sm">Ø³Ø±ÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶</label>
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-save ml-2"></i>Ø°Ø®ÛŒØ±Ù‡
                    </button>
                    <button type="button" onclick="hideModal('addServerModal')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                        Ø§Ù†ØµØ±Ø§Ù
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Ticket Details Modal -->
    <div id="ticketDetailsModal" class="modal">
        <div class="modal-content">
            <h3 class="text-lg font-semibold mb-4">Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª</h3>
            <div id="ticketDetailsContent">
                <!-- Ticket details will be loaded here -->
            </div>
            <div class="flex space-x-2 space-x-reverse mt-4">
                <button onclick="hideModal('ticketDetailsModal')" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            showTab('payments');
        });

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'payments') {
                refreshPayments();
            } else if (tabName === 'charges') {
                refreshCharges();
            } else if (tabName === 'orders') {
                loadOrders();
            } else if (tabName === 'tickets') {
                loadTickets();
            } else if (tabName === 'plans') {
                loadPlans();
            } else if (tabName === 'servers') {
                loadServers();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showAddPlanModal() {
            document.getElementById('addPlanForm').reset();
            showModal('addPlanModal');
        }

        function showEditPlanModal(plan) {
            document.getElementById('editPlanId').value = plan.id;
            document.getElementById('editPlanName').value = plan.name;
            document.getElementById('editPlanPrice').value = plan.price;
            document.getElementById('editPlanDuration').value = plan.duration;
            document.getElementById('editPlanDataLimit').value = plan.dataLimit;
            document.getElementById('editPlanDescription').value = plan.description || '';
            showModal('editPlanModal');
        }

        function showAddServerModal() {
            document.getElementById('addServerForm').reset();
            showModal('addServerModal');
        }

        // API functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Auth': '${ADMIN_PASSWORD}'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            return await response.json();
        }

        // Load stats
        async function loadStats() {
            try {
                const stats = await apiCall('/api/admin/stats');
                if (stats.success) {
                    document.getElementById('todayOrders').textContent = stats.data.todayOrders;
                    document.getElementById('todayRevenue').textContent = stats.data.todayRevenue.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†';
                    document.getElementById('pendingPayments').textContent = stats.data.pendingPayments;
                    document.getElementById('pendingCharges').textContent = stats.data.pendingCharges || 0;
                    document.getElementById('openTickets').textContent = stats.data.openTickets;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load pending payments
        async function refreshPayments() {
            try {
                const data = await apiCall('/api/admin/pending-payments');
                const container = document.getElementById('pendingPaymentsList');
                
                if (data.payments && data.payments.length > 0) {
                    container.innerHTML = data.payments.map(payment => \`
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">\${payment.plan.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø³ÙØ§Ø±Ø´: \${payment.id}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±: <span class="font-mono">\${payment.chatId}</span></p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù…Ø¨Ù„Øº: \${payment.plan.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                                    \${payment.type === 'renewal' ? \`<p class="text-sm text-gray-600 dark:text-gray-400">Ù†ÙˆØ¹: ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³</p>\` : \`<p class="text-sm text-gray-600 dark:text-gray-400">Ø³Ø±ÙˆØ±: \${payment.serverName}</p>\`}
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø²Ù…Ø§Ù†: \${new Date(payment.paymentSubmittedAt).toLocaleString('fa-IR')}</p>
                                </div>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button onclick="approvePayment('\${payment.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        âœ… ØªØ£ÛŒÛŒØ¯
                                    </button>
                                    <button onclick="rejectPayment('\${payment.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        âŒ Ø±Ø¯
                                    </button>
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                }
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        // Load pending charges
        async function refreshCharges() {
            try {
                const data = await apiCall('/api/admin/pending-charges');
                const container = document.getElementById('pendingChargesList');
                
                if (data.charges && data.charges.length > 0) {
                    container.innerHTML = data.charges.map(charge => \`
                        <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø´Ø§Ø±Ú˜: \${charge.id}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±: <span class="font-mono">\${charge.chatId}</span></p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù…Ø¨Ù„Øº: \${charge.amount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø²Ù…Ø§Ù†: \${new Date(charge.paymentSubmittedAt).toLocaleString('fa-IR')}</p>
                                </div>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button onclick="approveCharge('\${charge.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                        âœ… ØªØ£ÛŒÛŒØ¯
                                    </button>
                                    <button onclick="rejectCharge('\${charge.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        âŒ Ø±Ø¯
                                    </button>
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ø´Ø§Ø±Ú˜ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
                }
            } catch (error) {
                console.error('Error loading charges:', error);
            }
        }

        // Load all orders
        async function loadOrders() {
            try {
                const data = await apiCall('/api/admin/orders');
                const container = document.getElementById('ordersList');
                
                if (data.orders && data.orders.length > 0) {
                    container.innerHTML = data.orders.map(order => {
                        const statusColors = {
                            'completed': 'bg-green-50 border-green-200 text-green-800',
                            'payment_submitted': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                            'waiting_payment': 'bg-blue-50 border-blue-200 text-blue-800',
                            'rejected': 'bg-red-50 border-red-200 text-red-800'
                        };
                        const statusTexts = {
                            'completed': 'ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡',
                            'payment_submitted': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯',
                            'waiting_payment': 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª', 
                            'rejected': 'Ø±Ø¯ Ø´Ø¯Ù‡'
                        };
                        const statusClass = statusColors[order.status] || 'bg-gray-50 border-gray-200 text-gray-800';
                        const statusText = statusTexts[order.status] || order.status;
                        
                        return \`
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold text-lg">\${order.plan.name}</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Ø³ÙØ§Ø±Ø´: \${order.id}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±: <span class="font-mono">\${order.chatId}</span></p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Ù…Ø¨Ù„Øº: \${order.plan.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                                        \${order.paymentMethod ? \`<p class="text-sm text-gray-600 dark:text-gray-400">Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª: \${order.paymentMethod === 'wallet' ? 'Ú©ÛŒÙ Ù¾ÙˆÙ„' : 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'}</p>\` : ''}
                                        \${order.type === 'renewal' ? \`<p class="text-sm text-gray-600 dark:text-gray-400">Ù†ÙˆØ¹: ØªÙ…Ø¯ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³</p>\` : ''}
                                        <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ§Ø±ÛŒØ®: \${new Date(order.createdAt).toLocaleString('fa-IR')}</p>
                                    </div>
                                    <div>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium \${statusClass}">
                                            \${statusText}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        \`;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ø³ÙØ§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Load tickets
        async function loadTickets() {
            try {
                const data = await apiCall('/api/admin/tickets');
                const container = document.getElementById('ticketsList');
                
                if (data.tickets && data.tickets.length > 0) {
                    container.innerHTML = data.tickets.map(ticket => {
                        const statusEmoji = ticket.status === 'open' ? 'ğŸŸ¢' : 'ğŸ”´';
                        const statusText = ticket.status === 'open' ? 'Ø¨Ø§Ø²' : 'Ø¨Ø³ØªÙ‡';
                        
                        return \`
                            <div class="bg-white dark:bg-gray-700 rounded-lg p-4 border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold text-lg">\${ticket.typeName}</h3>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">ØªÛŒÚ©Øª: \${ticket.id}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Ú©Ø§Ø±Ø¨Ø±: <span class="font-mono">\${ticket.chatId}</span></p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Ù…ÙˆØ¶ÙˆØ¹: \${ticket.subject}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ§Ø±ÛŒØ®: \${new Date(ticket.createdAt).toLocaleString('fa-IR')}</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">ÙˆØ¶Ø¹ÛŒØª: \${statusEmoji} \${statusText}</p>
                                    </div>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <button onclick="viewTicketDetails('\${ticket.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                            ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡
                                        </button>
                                        \${ticket.status === 'open' ? \`<button onclick="closeTicket('\${ticket.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                            ğŸ”’ Ø¨Ø³ØªÙ†
                                        </button>\` : ''}
                                    </div>
                                </div>
                            </div>
                        \`;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">ØªÛŒÚ©ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }
            } catch (error) {
                console.error('Error loading tickets:', error);
            }
        }

        // View ticket details
        async function viewTicketDetails(ticketId) {
            try {
                const data = await apiCall('/api/admin/tickets/' + ticketId);
                if (data.ticket) {
                    const ticket = data.ticket;
                    const statusEmoji = ticket.status === 'open' ? 'ğŸŸ¢' : 'ğŸ”´';
                    const statusText = ticket.status === 'open' ? 'Ø¨Ø§Ø²' : 'Ø¨Ø³ØªÙ‡';
                    
                    let messagesHtml = '';
                    ticket.messages.forEach(msg => {
                        const fromEmoji = msg.from === 'user' ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ’¼';
                        const fromText = msg.from === 'user' ? 'Ú©Ø§Ø±Ø¨Ø±' : 'Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ';
                        const time = new Date(msg.timestamp).toLocaleString('fa-IR');
                        
                        messagesHtml += \`
                            <div class="mb-4 p-3 \${msg.from === 'user' ? 'bg-blue-50' : 'bg-green-50'} rounded">
                                <div class="font-semibold">\${fromEmoji} \${fromText} - \${time}</div>
                                <div class="mt-2">\${msg.message}</div>
                            </div>
                        \`;
                    });
                    
                    document.getElementById('ticketDetailsContent').innerHTML = \`
                        <div>
                            <h4 class="font-semibold mb-2">Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÛŒÚ©Øª</h4>
                            <p><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> \${ticket.id}</p>
                            <p><strong>Ú©Ø§Ø±Ø¨Ø±:</strong> <span class="font-mono">\${ticket.chatId}</span></p>
                            <p><strong>Ù…ÙˆØ¶ÙˆØ¹:</strong> \${ticket.typeName}</p>
                            <p><strong>ØªØ§Ø±ÛŒØ®:</strong> \${new Date(ticket.createdAt).toLocaleString('fa-IR')}</p>
                            <p><strong>ÙˆØ¶Ø¹ÛŒØª:</strong> \${statusEmoji} \${statusText}</p>
                            
                            <h4 class="font-semibold mt-4 mb-2">Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§</h4>
                            \${messagesHtml}
                        </div>
                    \`;
                    
                    showModal('ticketDetailsModal');
                }
            } catch (error) {
                console.error('Error loading ticket details:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª');
            }
        }

        // Close ticket
        async function closeTicket(ticketId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø³ØªÙ† Ø§ÛŒÙ† ØªÛŒÚ©Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/tickets/' + ticketId + '/close', 'POST');
                    if (result.success) {
                        alert('ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯!');
                        loadTickets();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª');
                }
            }
        }

        // Load plans
        async function loadPlans() {
            try {
                const data = await apiCall('/api/admin/plans');
                const container = document.getElementById('plansList');
                
                if (data.plans && Object.keys(data.plans).length > 0) {
                    container.innerHTML = Object.values(data.plans).map(plan => \`
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">\${plan.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù‚ÛŒÙ…Øª: \${plan.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù…Ø¯Øª: \${plan.duration} Ø±ÙˆØ²</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø­Ø¬Ù…: \${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯Ø§Ø¨Ø§ÛŒØª' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ØªÙˆØ¶ÛŒØ­Ø§Øª: \${plan.description}</p>
                                </div>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button onclick="showEditPlanModal(\${JSON.stringify(plan).replace(/"/g, '&quot;')})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                        <i class="fas fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´
                                    </button>
                                    <button onclick="deletePlan('\${plan.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                                    </button>
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ù¾Ù„Ù†ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        // Load servers
        async function loadServers() {
            try {
                const data = await apiCall('/api/admin/servers');
                const container = document.getElementById('serversList');
                
                if (data.servers && Object.keys(data.servers).length > 0) {
                    container.innerHTML = Object.values(data.servers).map(server => \`
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">\${server.name} \${server.isDefault ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</span>' : ''}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø¢Ø¯Ø±Ø³: \${server.baseUrl}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù…ÙˆÙ‚Ø¹ÛŒØª: \${server.location}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ÙˆØ¶Ø¹ÛŒØª: \${server.status === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ØªÙˆØ¶ÛŒØ­Ø§Øª: \${server.description}</p>
                                </div>
                                <div class="flex space-x-2 space-x-reverse">
                                    <button onclick="testServer('\${server.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                        <i class="fas fa-check"></i> ØªØ³Øª
                                    </button>
                                    \${!server.isDefault ? \`<button onclick="deleteServer('\${server.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                                    </button>\` : ''}
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ø³Ø±ÙˆØ±ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
                }
            } catch (error) {
                console.error('Error loading servers:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const data = await apiCall('/api/admin/users');
                const container = document.getElementById('usersList');
                
                if (data.users && data.users.length > 0) {
                    container.innerHTML = data.users.map(user => \`
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold text-lg">Ú©Ø§Ø±Ø¨Ø±: <span class="font-mono">\${user.chatId}</span></h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ¹Ø¯Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§: \${user.servicesCount}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§: \${user.ordersCount}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">ØªØ¹Ø¯Ø§Ø¯ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: \${user.ticketsCount}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: \${user.walletBalance ? user.walletBalance.toLocaleString() + ' ØªÙˆÙ…Ø§Ù†' : '0 ØªÙˆÙ…Ø§Ù†'}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: \${user.lastActivity ? new Date(user.lastActivity).toLocaleString('fa-IR') : 'Ù†Ø§Ù…Ø´Ø®Øµ'}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Ú©Ù„ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§: \${user.totalPayments.toLocaleString()} ØªÙˆÙ…Ø§Ù†</p>
                                </div>
                                <div class="flex flex-col space-y-2">
                                    <span class="text-xs px-2 py-1 rounded \${user.servicesCount > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                        \${user.servicesCount > 0 ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    \`).join('');
                } else {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const data = await apiCall('/api/admin/inbound-settings');
                if (data.settings && data.settings.referenceUsername) {
                    document.getElementById('referenceUsername').value = data.settings.referenceUsername;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Save inbound settings
        async function saveInboundSettings() {
            try {
                const referenceUsername = document.getElementById('referenceUsername').value;
                const result = await apiCall('/api/admin/inbound-settings', 'POST', { referenceUsername });
                if (result.success) {
                    alert('ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ†Ø¨Ø§Ù†Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
                } else {
                    alert('Ø®Ø·Ø§: ' + result.error);
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª');
            }
        }

        // Add plan
        document.getElementById('addPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planData = {
                name: document.getElementById('planName').value,
                price: parseInt(document.getElementById('planPrice').value),
                duration: parseInt(document.getElementById('planDuration').value),
                dataLimit: parseInt(document.getElementById('planDataLimit').value),
                description: document.getElementById('planDescription').value
            };
            
            try {
                const result = await apiCall('/api/admin/plans', 'POST', planData);
                if (result.success) {
                    alert('Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');
                    hideModal('addPlanModal');
                    loadPlans();
                } else {
                    alert('Ø®Ø·Ø§: ' + result.error);
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù†');
            }
        });

        // Edit plan
        document.getElementById('editPlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planId = document.getElementById('editPlanId').value;
            const planData = {
                name: document.getElementById('editPlanName').value,
                price: parseInt(document.getElementById('editPlanPrice').value),
                duration: parseInt(document.getElementById('editPlanDuration').value),
                dataLimit: parseInt(document.getElementById('editPlanDataLimit').value),
                description: document.getElementById('editPlanDescription').value
            };
            
            try {
                const result = await apiCall('/api/admin/plans/' + planId, 'PUT', planData);
                if (result.success) {
                    alert('Ù¾Ù„Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯!');
                    hideModal('editPlanModal');
                    loadPlans();
                } else {
                    alert('Ø®Ø·Ø§: ' + result.error);
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ù„Ù†');
            }
        });

        // Add server
        document.getElementById('addServerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serverData = {
                name: document.getElementById('serverName').value,
                baseUrl: document.getElementById('serverBaseUrl').value,
                username: document.getElementById('serverUsername').value,
                password: document.getElementById('serverPassword').value,
                location: document.getElementById('serverLocation').value,
                description: document.getElementById('serverDescription').value,
                isDefault: document.getElementById('serverIsDefault').checked
            };
            
            try {
                const result = await apiCall('/api/admin/servers', 'POST', serverData);
                if (result.success) {
                    alert('Ø³Ø±ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!');
                    hideModal('addServerModal');
                    loadServers();
                } else {
                    alert('Ø®Ø·Ø§: ' + result.error);
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ±');
            }
        });

        // Delete plan
        async function deletePlan(planId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù¾Ù„Ù† Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/plans/' + planId, 'DELETE');
                    if (result.success) {
                        alert('Ù¾Ù„Ù† Ø­Ø°Ù Ø´Ø¯!');
                        loadPlans();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾Ù„Ù†');
                }
            }
        }

        // Delete server
        async function deleteServer(serverId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/servers/' + serverId, 'DELETE');
                    if (result.success) {
                        alert('Ø³Ø±ÙˆØ± Ø­Ø°Ù Ø´Ø¯!');
                        loadServers();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø³Ø±ÙˆØ±');
                }
            }
        }

        // Test server
        async function testServer(serverId) {
            try {
                const result = await apiCall('/api/admin/servers/' + serverId + '/test');
                if (result.success) {
                    alert('Ø³Ø±ÙˆØ± Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯! âœ…');
                } else {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±: ' + result.error);
                }
            } catch (error) {
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø³Ø±ÙˆØ±');
            }
        }

        // Approve payment
        async function approvePayment(orderId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/approve-payment', 'POST', { orderId });
                    if (result.success) {
                        alert('Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!');
                        refreshPayments();
                        loadStats();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª');
                }
            }
        }

        // Reject payment
        async function rejectPayment(orderId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±Ø¯ Ø§ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/reject-payment', 'POST', { orderId });
                    if (result.success) {
                        alert('Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø¯ Ø´Ø¯!');
                        refreshPayments();
                        loadStats();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª');
                }
            }
        }

        // Approve charge
        async function approveCharge(chargeId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ø§ÛŒÙ† Ø´Ø§Ø±Ú˜ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/approve-charge', 'POST', { chargeId });
                    if (result.success) {
                        alert('Ø´Ø§Ø±Ú˜ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!');
                        refreshCharges();
                        loadStats();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜');
                }
            }
        }

        // Reject charge
        async function rejectCharge(chargeId) {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø±Ø¯ Ø§ÛŒÙ† Ø´Ø§Ø±Ú˜ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                try {
                    const result = await apiCall('/api/admin/reject-charge', 'POST', { chargeId });
                    if (result.success) {
                        alert('Ø´Ø§Ø±Ú˜ Ø±Ø¯ Ø´Ø¯!');
                        refreshCharges();
                        loadStats();
                    } else {
                        alert('Ø®Ø·Ø§: ' + result.error);
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ Ø´Ø§Ø±Ú˜');
                }
            }
        }

        // Logout
        function logout() {
            if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø®Ø±ÙˆØ¬ Ú©Ù†ÛŒØ¯ØŸ')) {
                window.location.href = '/admin?logout=1';
            }
        }
    </script>
</body>
</html>`;
}

// ØªØ§Ø¨Ø¹ Ù„Ø§Ú¯ÛŒÙ† Ø§Ø¯Ù…ÛŒÙ†
function getAdminLogin() {
  return `<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap');
        * { 
            font-family: 'Vazirmatn', 'Tahoma', Arial, sans-serif !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-500 to-purple-600 min-h-screen flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <i class="fas fa-shield-alt text-4xl text-blue-600 mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-900">Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ARDISK VPN</h1>
            <p class="text-gray-600 mt-2">Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
        </div>
        
        <form onsubmit="handleLogin(event)" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù…Ø¯ÛŒØ±ÛŒØª</label>
                <input type="password" id="password" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
            </div>
            
            <button type="submit" 
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                <i class="fas fa-sign-in-alt ml-2"></i>
                ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„
            </button>
        </form>
        
        <div id="error" class="mt-4 text-red-600 text-sm text-center hidden"></div>
    </div>

    <script>
        function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error');
            
            if (password === '${ADMIN_PASSWORD}') {
                // Set session and redirect
                document.cookie = 'admin_session=${ADMIN_PASSWORD}; path=/; max-age=3600';
                window.location.href = '/admin';
            } else {
                errorDiv.textContent = 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!';
                errorDiv.classList.remove('hidden');
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
</body>
</html>`;
}

// ØªØ³Øª Ø³ÛŒØ³ØªÙ… VPN Ùˆ Cron Job
async function testVPNSystem(chatId, kv) {
  try {
    const testMessage = await sendMessage(chatId, 'ğŸ”„ <b>Ø´Ø±ÙˆØ¹ ØªØ³Øª Ø³ÛŒØ³ØªÙ… VPN...</b>\n\nâ³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...');
    const testMessageId = testMessage.result.message_id;
    
    let testResults = [];
    
    // 1. ØªØ³Øª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…
    testResults.push('ğŸ§ª <b>ØªØ³Øª Ø³ÛŒØ³ØªÙ… ARDISK VPN</b>\n');
    
    // 2. ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ KV
    try {
      await kv.get('test_key');
      testResults.push('âœ… KV Database: Ù…ØªØµÙ„');
    } catch (error) {
      testResults.push('âŒ KV Database: Ø®Ø·Ø§ - ' + error.message);
    }
    
    // 3. ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    const servicesResult = await kv.list('service_');
    testResults.push(`ğŸ“± ØªØ¹Ø¯Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§: ${servicesResult.keys.length} Ø¹Ø¯Ø¯`);
    
    let activeServices = 0;
    let expiredServices = 0;
    let nearExpiryServices = 0;
    let trafficWarningServices = 0;
    const now = Date.now();
    const oneDayMs = 24 * 60 * 60 * 1000;
    
    for (const key of servicesResult.keys.slice(0, 50)) {
      try {
        const service = await kv.get(key.name, 'json');
        if (service) {
          const timeUntilExpiry = service.expireTimestamp - now;
          const daysUntilExpiry = Math.ceil(timeUntilExpiry / oneDayMs);
          
          if (service.status === 'active') {
            activeServices++;
            if (daysUntilExpiry <= 1 && daysUntilExpiry > 0) {
              nearExpiryServices++;
            }
          } else {
            expiredServices++;
          }
          
          // Ú†Ú© ØªØ±Ø§ÙÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯
          if (service.dataLimit && service.dataLimit > 0) {
            trafficWarningServices++;
          }
        }
      } catch (e) {}
    }
    
    testResults.push(`ğŸŸ¢ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: ${activeServices}`);
    testResults.push(`ğŸ”´ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ: ${expiredServices}`);
    testResults.push(`âš ï¸ Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø§Ù†Ù‚Ø¶Ø§: ${nearExpiryServices}`);
    testResults.push(`ğŸ“Š Ø¯Ø§Ø±Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø­Ø¬Ù…: ${trafficWarningServices}`);
    
    // 4. ØªØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§
    const servers = await getServers(kv);
    testResults.push(`\nğŸ–¥ï¸ <b>ØªØ³Øª Ø³Ø±ÙˆØ±Ù‡Ø§:</b>`);
    testResults.push(`ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø³Ø±ÙˆØ±Ù‡Ø§: ${Object.keys(servers).length} Ø¹Ø¯Ø¯`);
    
    let connectedServers = 0;
    let failedServers = 0;
    
    for (const [serverId, server] of Object.entries(servers)) {
      try {
        const api = new MarzbanAPI(server.baseUrl);
        const loginResult = await api.login(server.username, server.password);
        
        if (loginResult.success) {
          connectedServers++;
          testResults.push(`âœ… ${server.name}: Ù…ØªØµÙ„`);
        } else {
          failedServers++;
          testResults.push(`âŒ ${server.name}: ${loginResult.error}`);
        }
      } catch (error) {
        failedServers++;
        testResults.push(`âŒ ${server.name}: Ø®Ø·Ø§ Ø§ØªØµØ§Ù„`);
      }
    }
    
    // 5. ØªØ³Øª Cron Job Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ
    testResults.push(`\nâ° <b>ØªØ³Øª Cron Job:</b>`);
    try {
      const cronTestStart = Date.now();
      await checkExpiringServices(kv);
      const cronTestEnd = Date.now();
      const cronDuration = cronTestEnd - cronTestStart;
      testResults.push(`âœ… Cron Job: Ø§Ø¬Ø±Ø§ Ø´Ø¯ (${cronDuration}ms)`);
    } catch (error) {
      testResults.push(`âŒ Cron Job: Ø®Ø·Ø§ - ${error.message}`);
    }
    
    // 6. ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ
    testResults.push(`\nğŸ“¢ <b>ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ:</b>`);
    const notificationsResult = await kv.list('notification_');
    testResults.push(`ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ notification Ù‡Ø§: ${notificationsResult.keys.length}`);
    
    // 7. Ø¢Ù…Ø§Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡
    const ordersResult = await kv.list('order_ORD_');
    const ticketsResult = await kv.list('ticket_');
    const chargesResult = await kv.list('wallet_charge_');
    
    testResults.push(`\nğŸ“Š <b>Ø¢Ù…Ø§Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡:</b>`);
    testResults.push(`ğŸ›’ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§: ${ordersResult.keys.length}`);
    testResults.push(`ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: ${ticketsResult.keys.length}`);
    testResults.push(`ğŸ’° Ø´Ø§Ø±Ú˜Ù‡Ø§: ${chargesResult.keys.length}`);
    
    // 8. Ø®Ù„Ø§ØµÙ‡ Ù†ØªØ§ÛŒØ¬
    testResults.push(`\nğŸ¯ <b>Ø®Ù„Ø§ØµÙ‡ ØªØ³Øª:</b>`);
    testResults.push(`âœ… Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ù…ØªØµÙ„: ${connectedServers}/${Object.keys(servers).length}`);
    testResults.push(`ğŸ“± Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: ${activeServices}`);
    testResults.push(`âš ï¸ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙˆØ¬Ù‡: ${nearExpiryServices + failedServers}`);
    
    // 9. ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…
    const systemHealth = (connectedServers === Object.keys(servers).length && failedServers === 0) ? 
                        'ğŸŸ¢ Ø¹Ø§Ù„ÛŒ' : failedServers > 0 ? 'ğŸ”´ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ø±Ø±Ø³ÛŒ' : 'ğŸŸ¡ Ù‚Ø§Ø¨Ù„ Ù‚Ø¨ÙˆÙ„';
    
    testResults.push(`\nğŸ¥ <b>ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…:</b> ${systemHealth}`);
    testResults.push(`ğŸ• <b>Ø²Ù…Ø§Ù† ØªØ³Øª:</b> ${formatDateTime(Date.now())}`);
    
    // Ø§Ø±Ø³Ø§Ù„ Ù†ØªØ§ÛŒØ¬
    const finalText = testResults.join('\n');
    
    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [
            { text: 'ğŸ”„ ØªØ³Øª Ù…Ø¬Ø¯Ø¯', callback_data: 'admin_retest_system' },
            { text: 'ğŸ“Š Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ', callback_data: 'admin_detailed_stats' }
          ],
          [
            { text: 'âš¡ Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ Cron', callback_data: 'admin_force_cron' }
          ],
          [
            { text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
          ]
        ]
      }
    };
    
    await editMessage(chatId, testMessageId, finalText, keyboard);
    
  } catch (error) {
    console.error('Error in system test:', error);
    await sendMessage(chatId, `âŒ <b>Ø®Ø·Ø§ Ø¯Ø± ØªØ³Øª Ø³ÛŒØ³ØªÙ…:</b>\n\n${error.message}`);
  }
}

// ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ
async function testNotificationSystem(chatId, kv) {
  try {
    const testText = `ğŸ§ª <b>ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ</b>

Ø§ÛŒÙ† ÛŒÚ© ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø³ÛŒØ³ØªÙ… Ø§Ø³Øª.

â° Ø²Ù…Ø§Ù†: ${formatDateTime(Date.now())}
ğŸ¤– ÙˆØ¶Ø¹ÛŒØª: Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª
ğŸ“¡ Ø§Ø±ØªØ¨Ø§Ø·: Ø¨Ø±Ù‚Ø±Ø§Ø±
ğŸ’¾ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: Ù…ØªØµÙ„

âœ… ØªØ³Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²!`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'âœ… ØªØ³Øª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯', callback_data: 'test_received' }]
        ]
      }
    };

    await sendMessage(chatId, testText, keyboard);
    
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
}

// Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ Cron Job
async function forceRunCronJob(chatId, messageId, kv) {
  try {
    await editMessage(chatId, messageId, 'â³ <b>Ø§Ø¬Ø±Ø§ÛŒ ÙÙˆØ±ÛŒ Cron Job...</b>\n\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...');
    
    const startTime = Date.now();
    await checkExpiringServices(kv);
    const endTime = Date.now();
    
    const duration = endTime - startTime;
    
    const successText = `âœ… <b>Cron Job Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¬Ø±Ø§ Ø´Ø¯!</b>

â±ï¸ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${duration}ms
ğŸ• Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§: ${formatDateTime(Date.now())}

ğŸ“Š Cron Job Ø´Ø§Ù…Ù„ Ù…ÙˆØ§Ø±Ø¯ Ø²ÛŒØ± Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¯:
â€¢ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
â€¢ Ù…ØµØ±Ù ØªØ±Ø§ÙÛŒÚ©
â€¢ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§

âœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ù‡ Ø¯Ø±Ø³ØªÛŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯!`;

    const keyboard = {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ø¬Ø¯Ø¯', callback_data: 'admin_force_cron' }],
          [{ text: 'ğŸ§ª ØªØ³Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…', callback_data: 'admin_full_test' }],
          [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
        ]
      }
    };

    await editMessage(chatId, messageId, successText, keyboard);
    
  } catch (error) {
    console.error('Error in force cron job:', error);
    await editMessage(chatId, messageId, 
      `âŒ <b>Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Cron Job:</b>\n\n${error.message}`,
      {
        reply_markup: {
          inline_keyboard: [
            [{ text: 'ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯', callback_data: 'admin_force_cron' }],
            [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
          ]
        }
      }
    );
  }
}

// ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø§Ø±Ø¨Ø±
async function clearUserPendingState(chatId, kv) {
  try {
    // Ù„ÛŒØ³ØªÛŒ Ø§Ø² Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØªÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ù¾Ø§Ú© Ø´ÙˆÙ†Ø¯
    const pendingKeys = [
      `pending_ticket_${chatId}`,
      `pending_user_reply_${chatId}`,
      `waiting_charge_amount_${chatId}`,
      `user_charge_${chatId}`,
      `user_order_${chatId}`,
      `selected_plan_${chatId}`,
      `renewal_plan_${chatId}`,
      `waiting_username_${chatId}`,
      // Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
      `pending_reply_${chatId}`
    ];

    // Ø­Ø°Ù Ù‡Ù…Ù‡ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙˆØ§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
    const deletionPromises = pendingKeys.map(key => kv.delete(key));
    await Promise.all(deletionPromises);
    
    console.log(`Cleared all pending states for user ${chatId}`);
    return true;
  } catch (error) {
    console.error(`Error clearing pending state for user ${chatId}:`, error);
    return false;
  }
}

// Worker Ø§ØµÙ„ÛŒ
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¨
    if (url.pathname.startsWith('/admin')) {
      if (request.method === 'GET') {
        // Ø¨Ø±Ø±Ø³ÛŒ Ù„Ø§Ú¯ Ø§ÙˆØª
        if (url.searchParams.get('logout')) {
          return new Response('', {
            status: 302,
            headers: {
              'Location': '/admin',
              'Set-Cookie': 'admin_session=; path=/; max-age=0'
            }
          });
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª
        const cookies = request.headers.get('Cookie') || '';
        const isAuthenticated = cookies.includes(`admin_session=${ADMIN_PASSWORD}`);

        if (!isAuthenticated) {
          return new Response(getAdminLogin(), {
            headers: { 'Content-Type': 'text/html; charset=utf-8' }
          });
        }

        return new Response(getAdminWebPanel(), {
          headers: { 'Content-Type': 'text/html; charset=utf-8' }
        });
      }
    }

    // Cron job Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
    if (url.pathname === '/cron/check-expiry') {
      const safeKV = new SafeKV(env?.KV_B);
      await checkExpiringServices(safeKV);
      return new Response('Expiry check completed', { status: 200 });
    }

    // API endpoints Ø¨Ø±Ø§ÛŒ Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
    if (url.pathname.startsWith('/api/admin/')) {
      const authHeader = request.headers.get('X-Admin-Auth');
      if (authHeader !== ADMIN_PASSWORD) {
        return new Response(JSON.stringify({ error: 'Unauthorized' }), {
          status: 401,
          headers: { 'Content-Type': 'application/json' }
        });
      }

      const safeKV = new SafeKV(env?.KV_B);

      // Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
      if (url.pathname === '/api/admin/stats') {
        try {
          const revenue = await calculateRevenue(safeKV);
          
          // Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
          const ordersResult = await safeKV.list('order_ORD_');
          let pendingPayments = 0;
          for (const key of ordersResult.keys) {
            const order = await safeKV.get(key.name, 'json');
            if (order && order.status === 'payment_submitted') {
              pendingPayments++;
            }
          }

          // Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
          const chargesResult = await safeKV.list('wallet_charge_');
          let pendingCharges = 0;
          for (const key of chargesResult.keys) {
            const charge = await safeKV.get(key.name, 'json');
            if (charge && charge.status === 'payment_submitted') {
              pendingCharges++;
            }
          }

          // ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²
          const ticketsResult = await safeKV.list('ticket_');
          let openTickets = 0;
          for (const key of ticketsResult.keys) {
            const ticket = await safeKV.get(key.name, 'json');
            if (ticket && ticket.status === 'open') {
              openTickets++;
            }
          }

          return new Response(JSON.stringify({
            success: true,
            data: {
              todayOrders: revenue.todayOrders,
              todayRevenue: revenue.todayRevenue,
              totalRevenue: revenue.totalRevenue,
              pendingPayments: pendingPayments,
              pendingCharges: pendingCharges,
              openTickets: openTickets
            }
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
      if (url.pathname === '/api/admin/pending-payments') {
        try {
          const ordersResult = await safeKV.list('order_ORD_');
          const pendingPayments = [];

          for (const key of ordersResult.keys) {
            const orderData = await safeKV.get(key.name, 'json');
            if (orderData && orderData.status === 'payment_submitted') {
              pendingPayments.push(orderData);
            }
          }

          return new Response(JSON.stringify({ 
            success: true, 
            payments: pendingPayments.sort((a, b) => b.paymentSubmittedAt - a.paymentSubmittedAt)
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±
      if (url.pathname === '/api/admin/pending-charges') {
        try {
          const chargesResult = await safeKV.list('wallet_charge_');
          const pendingCharges = [];

          for (const key of chargesResult.keys) {
            const chargeData = await safeKV.get(key.name, 'json');
            if (chargeData && chargeData.status === 'payment_submitted') {
              pendingCharges.push(chargeData);
            }
          }

          return new Response(JSON.stringify({ 
            success: true, 
            charges: pendingCharges.sort((a, b) => b.paymentSubmittedAt - a.paymentSubmittedAt)
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ù‡Ù…Ù‡ Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
      if (url.pathname === '/api/admin/orders') {
        try {
          const ordersResult = await safeKV.list('order_ORD_');
          const orders = [];

          for (const key of ordersResult.keys) {
            const orderData = await safeKV.get(key.name, 'json');
            if (orderData) {
              orders.push(orderData);
            }
          }

          return new Response(JSON.stringify({ 
            success: true, 
            orders: orders.sort((a, b) => b.createdAt - a.createdAt)
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
      if (url.pathname === '/api/admin/tickets') {
        try {
          const ticketsResult = await safeKV.list('ticket_');
          const tickets = [];

          for (const key of ticketsResult.keys) {
            const ticketData = await safeKV.get(key.name, 'json');
            if (ticketData) {
              tickets.push(ticketData);
            }
          }

          return new Response(JSON.stringify({ 
            success: true, 
            tickets: tickets.sort((a, b) => b.createdAt - a.createdAt)
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
      if (url.pathname === '/api/admin/users') {
        try {
          const users = new Map();
          
          // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
          const servicesResult = await safeKV.list('service_');
          for (const key of servicesResult.keys) {
            const service = await safeKV.get(key.name, 'json');
            if (service && service.chatId) {
              if (!users.has(service.chatId)) {
                users.set(service.chatId, {
                  chatId: service.chatId,
                  servicesCount: 0,
                  ordersCount: 0,
                  ticketsCount: 0,
                  totalPayments: 0,
                  walletBalance: 0,
                  lastActivity: 0
                });
              }
              users.get(service.chatId).servicesCount++;
              users.get(service.chatId).lastActivity = Math.max(
                users.get(service.chatId).lastActivity,
                service.createdAt
              );
            }
          }

          // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§
          const ordersResult = await safeKV.list('order_ORD_');
          for (const key of ordersResult.keys) {
            const order = await safeKV.get(key.name, 'json');
            if (order && order.chatId) {
              if (!users.has(order.chatId)) {
                users.set(order.chatId, {
                  chatId: order.chatId,
                  servicesCount: 0,
                  ordersCount: 0,
                  ticketsCount: 0,
                  totalPayments: 0,
                  walletBalance: 0,
                  lastActivity: 0
                });
              }
              users.get(order.chatId).ordersCount++;
              if (order.status === 'completed') {
                users.get(order.chatId).totalPayments += order.plan.price;
              }
              users.get(order.chatId).lastActivity = Math.max(
                users.get(order.chatId).lastActivity,
                order.createdAt
              );
            }
          }

          // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² ØªÛŒÚ©Øªâ€ŒÙ‡Ø§
          const ticketsResult = await safeKV.list('ticket_');
          for (const key of ticketsResult.keys) {
            const ticket = await safeKV.get(key.name, 'json');
            if (ticket && ticket.chatId) {
              if (!users.has(ticket.chatId)) {
                users.set(ticket.chatId, {
                  chatId: ticket.chatId,
                  servicesCount: 0,
                  ordersCount: 0,
                  ticketsCount: 0,
                  totalPayments: 0,
                  walletBalance: 0,
                  lastActivity: 0
                });
              }
              users.get(ticket.chatId).ticketsCount++;
              users.get(ticket.chatId).lastActivity = Math.max(
                users.get(ticket.chatId).lastActivity,
                ticket.createdAt
              );
            }
          }

          // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„
          for (const [chatId, user] of users) {
            const balance = await getWalletBalance(chatId, safeKV);
            user.walletBalance = balance;
          }

          const usersList = Array.from(users.values()).sort((a, b) => b.lastActivity - a.lastActivity);

          return new Response(JSON.stringify({ 
            success: true, 
            users: usersList
          }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª
      if (url.pathname.match(/^\/api\/admin\/tickets\/(.+)$/) && request.method === 'GET') {
        try {
          const ticketId = url.pathname.split('/').pop();
          const ticketsResult = await safeKV.list('ticket_');
          
          for (const key of ticketsResult.keys) {
            const ticket = await safeKV.get(key.name, 'json');
            if (ticket && ticket.id === ticketId) {
              return new Response(JSON.stringify({ success: true, ticket }), {
                headers: { 'Content-Type': 'application/json' }
              });
            }
          }

          return new Response(JSON.stringify({ success: false, error: 'ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
            status: 404,
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª
      if (url.pathname.match(/^\/api\/admin\/tickets\/(.+)\/close$/) && request.method === 'POST') {
        try {
          const ticketId = url.pathname.split('/')[4];
          const ticketsResult = await safeKV.list('ticket_');
          
          for (const key of ticketsResult.keys) {
            const ticket = await safeKV.get(key.name, 'json');
            if (ticket && ticket.id === ticketId) {
              ticket.status = 'closed';
              ticket.closedAt = Date.now();
              ticket.closedBy = 'admin';
              
              await safeKV.put(key.name, JSON.stringify(ticket));
              
              // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
              const userNotification = `ğŸ”’ <b>ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯</b>

ğŸ†” ØªÛŒÚ©Øª: <code>${ticket.id}</code>
ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticket.typeName}

âœ… ØªÛŒÚ©Øª Ø´Ù…Ø§ ØªÙˆØ³Ø· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø³ØªÙ‡ Ø´Ø¯
ğŸ“… ${formatDateTime(Date.now())}

ğŸ’¬ Ø¨Ø±Ø§ÛŒ Ù…Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÛŒÚ©Øª Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯`;

              await sendMessage(ticket.chatId, userNotification, KEYBOARDS.backToSupport);
              
              return new Response(JSON.stringify({ success: true, message: 'ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯' }), {
                headers: { 'Content-Type': 'application/json' }
              });
            }
          }

          return new Response(JSON.stringify({ success: false, error: 'ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
            status: 404,
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // API Plans Management
      if (url.pathname === '/api/admin/plans') {
        if (request.method === 'GET') {
          try {
            const plans = await getPlans(safeKV);
            return new Response(JSON.stringify({ success: true, plans }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } else if (request.method === 'POST') {
          try {
            const planData = await request.json();
            const plans = await getPlans(safeKV);
            const planId = generatePlanId();
            
            plans[planId] = {
              id: planId,
              ...planData
            };
            
            await savePlans(safeKV, plans);
            
            return new Response(JSON.stringify({ success: true, message: 'Ù¾Ù„Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ success: false, error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        }
      }

      // Edit Plan
      if (url.pathname.match(/^\/api\/admin\/plans\/(.+)$/) && request.method === 'PUT') {
        try {
          const planId = url.pathname.split('/').pop();
          const planData = await request.json();
          const plans = await getPlans(safeKV);
          
          if (plans[planId]) {
            plans[planId] = {
              id: planId,
              ...planData
            };
            await savePlans(safeKV, plans);
            
            return new Response(JSON.stringify({ success: true, message: 'Ù¾Ù„Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            return new Response(JSON.stringify({ success: false, error: 'Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
              status: 404,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Delete Plan
      if (url.pathname.match(/^\/api\/admin\/plans\/(.+)$/) && request.method === 'DELETE') {
        try {
          const planId = url.pathname.split('/').pop();
          const plans = await getPlans(safeKV);
          
          if (plans[planId]) {
            delete plans[planId];
            await savePlans(safeKV, plans);
            
            return new Response(JSON.stringify({ success: true, message: 'Ù¾Ù„Ù† Ø­Ø°Ù Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            return new Response(JSON.stringify({ success: false, error: 'Ù¾Ù„Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
              status: 404,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // API Servers Management
      if (url.pathname === '/api/admin/servers') {
        if (request.method === 'GET') {
          try {
            const servers = await getServers(safeKV);
            return new Response(JSON.stringify({ success: true, servers }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } else if (request.method === 'POST') {
          try {
            const serverData = await request.json();
            const servers = await getServers(safeKV);
            const serverId = generateServerId();
            
            // Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø¬Ø¯ÛŒØ¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ø³ØªØŒ Ø³Ø§ÛŒØ± Ø³Ø±ÙˆØ±Ù‡Ø§ Ø±Ø§ ØºÛŒØ±Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ú©Ù†
            if (serverData.isDefault) {
              Object.values(servers).forEach(server => {
                server.isDefault = false;
              });
            }
            
            servers[serverId] = {
              id: serverId,
              status: 'active',
              ...serverData
            };
            
            await saveServers(safeKV, servers);
            
            return new Response(JSON.stringify({ success: true, message: 'Ø³Ø±ÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ success: false, error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        }
      }

      // Delete Server
      if (url.pathname.match(/^\/api\/admin\/servers\/(.+)$/) && request.method === 'DELETE') {
        try {
          const serverId = url.pathname.split('/').pop();
          const servers = await getServers(safeKV);
          
          if (servers[serverId] && !servers[serverId].isDefault) {
            delete servers[serverId];
            await saveServers(safeKV, servers);
            
            return new Response(JSON.stringify({ success: true, message: 'Ø³Ø±ÙˆØ± Ø­Ø°Ù Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            return new Response(JSON.stringify({ success: false, error: 'Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø³Ø±ÙˆØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø­Ø°Ù Ú©Ø±Ø¯' }), {
              status: 400,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Test Server
      if (url.pathname.match(/^\/api\/admin\/servers\/(.+)\/test$/) && request.method === 'GET') {
        try {
          const serverId = url.pathname.split('/')[4];
          const servers = await getServers(safeKV);
          const server = servers[serverId];
          
          if (!server) {
            return new Response(JSON.stringify({ success: false, error: 'Ø³Ø±ÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
              status: 404,
              headers: { 'Content-Type': 'application/json' }
            });
          }

          const api = new MarzbanAPI(server.baseUrl);
          const loginResult = await api.login(server.username, server.password);
          
          if (loginResult.success) {
            return new Response(JSON.stringify({ success: true, message: 'Ø§ØªØµØ§Ù„ Ù…ÙˆÙÙ‚' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } else {
            return new Response(JSON.stringify({ success: false, error: loginResult.error }), {
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // API Inbound Settings
      if (url.pathname === '/api/admin/inbound-settings') {
        if (request.method === 'GET') {
          try {
            const settings = await getInboundSettings(safeKV);
            return new Response(JSON.stringify({ success: true, settings }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        } else if (request.method === 'POST') {
          try {
            const { referenceUsername } = await request.json();
            const settings = { referenceUsername };
            
            await saveInboundSettings(safeKV, settings);
            
            return new Response(JSON.stringify({ success: true, message: 'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯' }), {
              headers: { 'Content-Type': 'application/json' }
            });
          } catch (error) {
            return new Response(JSON.stringify({ success: false, error: error.message }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }
        }
      }

      // ØªØ£ÛŒÛŒØ¯ Ù¾Ø±Ø¯Ø§Ø®Øª
      if (url.pathname === '/api/admin/approve-payment' && request.method === 'POST') {
        try {
          const { orderId } = await request.json();
          const result = await approvePaymentAPI(orderId, safeKV);
          
          return new Response(JSON.stringify(result), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ø±Ø¯ Ù¾Ø±Ø¯Ø§Ø®Øª
      if (url.pathname === '/api/admin/reject-payment' && request.method === 'POST') {
        try {
          const { orderId } = await request.json();
          const result = await rejectPaymentAPI(orderId, safeKV);
          
          return new Response(JSON.stringify(result), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
      if (url.pathname === '/api/admin/approve-charge' && request.method === 'POST') {
        try {
          const { chargeId } = await request.json();
          
          const chargeData = await safeKV.get(`wallet_charge_${chargeId}`, 'json');
          
          if (!chargeData) {
            return new Response(JSON.stringify({ success: false, error: 'Ø´Ø§Ø±Ú˜ ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
              status: 404,
              headers: { 'Content-Type': 'application/json' }
            });
          }

          if (chargeData.status !== 'payment_submitted') {
            return new Response(JSON.stringify({ success: false, error: 'ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø±Ú˜ Ù‚Ø§Ø¨Ù„ ØªØ£ÛŒÛŒØ¯ Ù†ÛŒØ³Øª' }), {
              status: 400,
              headers: { 'Content-Type': 'application/json' }
            });
          }

          // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¨Ù„Øº Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
          const newBalance = await updateWalletBalance(chargeData.chatId, chargeData.amount, safeKV);
          if (newBalance === false) {
            return new Response(JSON.stringify({ success: false, error: 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…ÙˆØ¬ÙˆØ¯ÛŒ' }), {
              status: 500,
              headers: { 'Content-Type': 'application/json' }
            });
          }

          // Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´
          await recordWalletTransaction(chargeData.chatId, chargeData.amount, 'charge', `Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ - ${chargeId}`, safeKV);

          // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø´Ø§Ø±Ú˜
          chargeData.status = 'completed';
          chargeData.completedAt = Date.now();
          await safeKV.put(`wallet_charge_${chargeId}`, JSON.stringify(chargeData));

          await safeKV.delete(`user_charge_${chargeData.chatId}`);

          // Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
          const userNotification = `âœ… <b>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ’° Ù…Ø¨Ù„Øº Ø´Ø§Ø±Ú˜: ${formatPrice(chargeData.amount)}
ğŸ’³ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: ${formatPrice(newBalance)}

ğŸ‰ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø´Ù…Ø§ Ø´Ø§Ø±Ú˜ Ø´Ø¯!

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

          await sendMessage(chargeData.chatId, userNotification, KEYBOARDS.backToWallet);

          return new Response(JSON.stringify({ success: true, message: 'Ø´Ø§Ø±Ú˜ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯' }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }

      // Ø±Ø¯ Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
      if (url.pathname === '/api/admin/reject-charge' && request.method === 'POST') {
        try {
          const { chargeId } = await request.json();
          
          const chargeData = await safeKV.get(`wallet_charge_${chargeId}`, 'json');
          
          if (!chargeData) {
            return new Response(JSON.stringify({ success: false, error: 'Ø´Ø§Ø±Ú˜ ÛŒØ§ÙØª Ù†Ø´Ø¯' }), {
              status: 404,
              headers: { 'Content-Type': 'application/json' }
            });
          }

          chargeData.status = 'rejected';
          chargeData.rejectedAt = Date.now();
          await safeKV.put(`wallet_charge_${chargeId}`, JSON.stringify(chargeData));

          await safeKV.delete(`user_charge_${chargeData.chatId}`);

          const rejectionText = `âŒ <b>Ø´Ø§Ø±Ú˜ ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯</b>

ğŸ†” Ø´Ø§Ø±Ú˜: <code>${chargeId}</code>
ğŸ’° Ù…Ø¨Ù„Øº: ${formatPrice(chargeData.amount)}

ğŸ” Ø¯Ù„Ø§ÛŒÙ„ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ:
â€¢ Ù…Ø¨Ù„Øº Ú©Ø§Ù…Ù„ Ù†Ø¨ÙˆØ¯Ù‡
â€¢ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø§Ø´ØªØ¨Ø§Ù‡
â€¢ Ø±Ø³ÛŒØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±

ğŸ’¬ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}`;

          const userKeyboard = {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ’³ Ø´Ø§Ø±Ú˜ Ù…Ø¬Ø¯Ø¯', callback_data: 'wallet_charge' }],
                [{ text: 'ğŸ’¬ ØªÙ…Ø§Ø³ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ', url: `https://t.me/${PAYMENT_INFO.supportUsername}` }]
              ]
            }
          };

          await sendMessage(chargeData.chatId, rejectionText, userKeyboard);

          return new Response(JSON.stringify({ success: true, message: 'Ø´Ø§Ø±Ú˜ Ø±Ø¯ Ø´Ø¯' }), {
            headers: { 'Content-Type': 'application/json' }
          });
        } catch (error) {
          return new Response(JSON.stringify({ success: false, error: error.message }), {
            status: 500,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }
    }

    if (request.method === 'GET') {
      return new Response(`
ğŸŒŸ ARDISK VPN Sales Bot
        
âœ… Status: Online
ğŸ›’ Sales System: Active
ğŸ’³ Payment Processing: Ready
ğŸ’° Wallet System: Active
ğŸ–¥ï¸ Multi-Server Support: Active
âš™ï¸ Admin Panel: Available
ğŸŒ Web Panel: /admin
ğŸ• Cron Job: /cron/check-expiry
        
ğŸ“ Support: @${PAYMENT_INFO.supportUsername}
ğŸ” Admin Password: Protected
      `, {
        headers: { 'Content-Type': 'text/plain; charset=utf-8' }
      });
    }
    
    if (request.method !== 'POST') {
      return new Response('Method not allowed', { status: 405 });
    }
    
    try {
      const safeKV = new SafeKV(env?.KV_B);
      if (Math.random() < 0.1) {
        safeKV.cleanup();
      }
      const update = await request.json();
      
      console.log('Sales Bot - Received update:', JSON.stringify(update));
      
      // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…
      if (update.message) {
        const chatId = update.message.chat.id;
        const text = update.message.text;

        // --- START: CODE MODIFICATION ---
        // Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø§ÛŒØ¯ ØªÙ…Ø§Ù… ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø§ Ù„ØºÙˆ Ú©Ù†Ù†Ø¯
        if (text === '/start' || text === '/menu') {
          await clearUserPendingState(chatId, safeKV);
          await showMainMenu(chatId, null, safeKV);
          return new Response('OK', { status: 200 }); // Ø®Ø±ÙˆØ¬ Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨ÛŒØ´ØªØ±
        }

          // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ±:
        if (text === '/cleancache' && isAdmin(chatId)) {
          safeKV.clearAll();
          await sendMessage(chatId, 'âœ… Cache Ù¾Ø§Ú© Ø´Ø¯!');
          return new Response('OK', { status: 200 });
        }
        
        if (text === '/testvpnen' && isAdmin(chatId)) {
          await testVPNSystem(chatId, safeKV);
          return new Response('OK', { status: 200 });
        }
        if (text === '/debugkv' && isAdmin(chatId)) {
          await debugKVServices(chatId, safeKV);
          return new Response('OK', { status: 200 });
        }
        // --- END: CODE MODIFICATION ---

        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± (Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ)
        const pendingTicket = await safeKV.get(`pending_ticket_${chatId}`, 'json');
        const pendingReply = await safeKV.get(`pending_reply_${chatId}`, 'json');
        const pendingUserReply = await safeKV.get(`pending_user_reply_${chatId}`, 'json');
        const userOrder = await safeKV.get(`user_order_${chatId}`);
        const userCharge = await safeKV.get(`user_charge_${chatId}`);
        const waitingChargeAmount = await safeKV.get(`waiting_charge_amount_${chatId}`, 'json');
        const waitingUsername = await safeKV.get(`waiting_username_${chatId}`, 'json');
        
        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø±Ø³ÛŒØ¯Ù‡Ø§ Ùˆ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ (Ø§ÙˆÙ„ÙˆÛŒØª Ø¯Ø§Ø±Ø¯)
        if (userOrder && (update.message.photo || update.message.document)) {
          console.log('Processing receipt upload for order:', userOrder);
          await processReceiptUpload(chatId, update.message, safeKV);
        }
        else if (userCharge && (update.message.photo || update.message.document)) {
          console.log('Processing charge receipt upload for charge:', userCharge);
          await processChargeReceiptUpload(chatId, update.message, safeKV);
        }
        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
        else if (text) {
          if (pendingReply && isAdmin(chatId)) {
            await processAdminReply(chatId, text, safeKV);
          } else if (pendingUserReply) {
            await processUserTicketReply(chatId, text, safeKV);
          } else if (pendingTicket) {
            await processTicketMessage(chatId, text, safeKV);
          } else if (waitingChargeAmount) {
            await processChargeAmount(chatId, text, safeKV);
          } else if (waitingUsername) {
            await processUsernameSearch(chatId, text, safeKV);
          } else {
            // Ø§Ú¯Ø± Ù‡ÛŒÚ† ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ¸Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ù†Ø´Ø§Ù† Ø¨Ø¯Ù‡
            await showMainMenu(chatId, null, safeKV);
          }
        }
        // Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø´Ø±Ø·ÛŒ Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø¨ÙˆØ¯
        else {
          console.log('No handler found for this message type');
          await showMainMenu(chatId, null, safeKV);
        }
      }
      
      // Ù¾Ø±Ø¯Ø§Ø²Ø´ callback query
      if (update.callback_query) {
        const chatId = update.callback_query.message.chat.id;
        const messageId = update.callback_query.message.message_id;
        const data = update.callback_query.data;
        
        console.log('Callback data received:', data);
        
        // Ù¾Ø§Ø³Ø® Ø¨Ù‡ callback query Ø¨Ø±Ø§ÛŒ Ø­Ø°Ù Ø­Ø§Ù„Øª Ù„ÙˆØ¯ÛŒÙ†Ú¯ Ø¯Ú©Ù…Ù‡
        try {
          await fetch(`${TELEGRAM_API}/answerCallbackQuery`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ callback_query_id: update.callback_query.id })
          });
        } catch (e) {
          console.error('Failed to answer callback query:', e);
        }
        
        // --- START: CODE MODIFICATION ---
        // Ù„ØºÙˆ ÙˆØ¶Ø¹ÛŒØª Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ ÛŒØ§ Ø´Ø±ÙˆØ¹ Ø¹Ù…Ù„ÛŒØ§Øª Ø¬Ø¯ÛŒØ¯
        const navigationActions = [
            'start', 'support_menu', 'wallet_menu', 'buy_service', 
            'my_services', 'admin_panel', 'cancel_order', 'cancel_charge'
        ];
        if (navigationActions.includes(data)) {
            await clearUserPendingState(chatId, safeKV);
        }
        // --- END: CODE MODIFICATION ---

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±Ø§Øª - Ù†Ø³Ø®Ù‡ Ú©Ø§Ù…Ù„ Ø´Ø¯Ù‡
        if (data === 'start') {
          await showMainMenu(chatId, messageId, safeKV);
        }
        else if (data === 'user_account') {
          await showUserAccount(chatId, messageId, safeKV);
        }
        else if (data === 'wallet_menu') {
          await showWalletMenu(chatId, messageId, safeKV);
        }
        else if (data === 'wallet_balance') {
          await showWalletBalance(chatId, messageId, safeKV);
        }
        else if (data === 'wallet_charge') {
          await showWalletCharge(chatId, messageId, safeKV);
        }
        else if (data === 'upload_charge_receipt') {
          await handleUploadChargeReceipt(chatId, messageId, safeKV);
        }
        else if (data === 'cancel_charge') {
          await editMessage(chatId, messageId, 'âŒ Ø´Ø§Ø±Ú˜ Ù„ØºÙˆ Ø´Ø¯.', KEYBOARDS.backToWallet);
        }
        else if (data === 'support_menu') {
          await showSupportMenu(chatId, messageId, safeKV);
        }
        else if (data === 'buy_service') {
          await showBuyService(chatId, messageId, safeKV);
        }
        else if (data === 'my_services') {
          await showMyServices(chatId, messageId, safeKV, 1);
        }
        else if (data === 'find_my_service') {
          await showFindMyService(chatId, messageId, safeKV);
        }
        else if (data === 'connection_guide') {
          await showConnectionGuide(chatId, messageId);
        }
        else if (data === 'create_ticket') {
          await showCreateTicket(chatId, messageId, safeKV);
        }
        else if (data === 'my_tickets') {
          await showMyTickets(chatId, messageId, safeKV);
        }
        // Ø¯Ø± Ù‚Ø³Ù…Øª callback query handlers Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯:
else if (data === 'debug_clear_service_cache' && isAdmin(chatId)) {
  safeKV.clearServiceCache();
  await editMessage(chatId, messageId, 'âœ… Service cache Ù¾Ø§Ú© Ø´Ø¯!', {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ“± ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§', callback_data: 'my_services' }],
        [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
      ]
    }
  });
}
else if (data === 'debug_clear_all_cache' && isAdmin(chatId)) {
  safeKV.clearAll();
  await editMessage(chatId, messageId, 'âœ… Ù‡Ù…Ù‡ cache Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯!', {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ“± ØªØ³Øª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§', callback_data: 'my_services' }],
        [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
      ]
    }
  });
}
        else if (data.startsWith('ticket_type_')) {
          const ticketType = data.replace('ticket_type_', '');
          await selectTicketType(chatId, messageId, ticketType, safeKV);
        }
        else if (data.startsWith('view_ticket_')) {
          const ticketId = data.replace('view_ticket_', '');
          await showTicketDetails(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('reply_ticket_user_')) {
          const ticketId = data.replace('reply_ticket_user_', '');
          await userReplyTicket(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('renew_with_plan|')) {
          const parts = data.split('|');
          const serviceId = parts[1];
          const planId = parts[2];
          await processRenewalWithPlan(chatId, messageId, serviceId, planId, safeKV);
        }
        else if (data.startsWith('renew_wallet|')) {
          const parts = data.split('|');
          const serviceId = parts[1];
          const planId = parts[2];
          await renewWithWallet(chatId, messageId, serviceId, planId, safeKV);
        }
        else if (data === 'faq') {
          await showFAQ(chatId, messageId);
        }
        else if (data.startsWith('renew_card|')) {
          const parts = data.split('|');
          const serviceId = parts[1];
          const planId = parts[2];
          await renewWithCard(chatId, messageId, serviceId, planId, safeKV);
        }
        else if (data.startsWith('close_ticket_user_')) {
          const ticketId = data.replace('close_ticket_user_', '');
          await closeTicketByUser(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('reply_ticket_') && isAdmin(chatId)) {
          const ticketId = data.replace('reply_ticket_', '');
          await adminReplyTicket(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('close_ticket_') && isAdmin(chatId)) {
          const ticketId = data.replace('close_ticket_', '');
          await closeTicketByAdmin(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('select_plan_')) {
          const planId = data.replace('select_plan_', '');
          await showPlanDetails(chatId, messageId, planId, safeKV);
        }
        else if (data === 'proceed_payment') {
          await showPaymentMethod(chatId, messageId, safeKV);
        }
        else if (data === 'pay_with_wallet') {
          await payWithWallet(chatId, messageId, safeKV);
        }
        else if (data === 'pay_with_card') {
          await showCardPaymentStep(chatId, messageId, safeKV);
        }
        else if (data === 'upload_receipt') {
          await handleUploadReceipt(chatId, messageId, safeKV);
        }
        else if (data.startsWith('manage_service_')) {
          const serviceId = data.replace('manage_service_', '');
          console.log('Managing service with extracted ID:', serviceId);
          await showServiceManagement(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('renew_service_')) {
          const serviceId = data.replace('renew_service_', '');
          console.log('Renewing service with extracted ID:', serviceId);
          await showServiceRenewal(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('service_status_')) {
          const serviceId = data.replace('service_status_', '');
          console.log('Showing status for service ID:', serviceId);
          await showServiceStatus(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('traffic_usage_')) {
          const serviceId = data.replace('traffic_usage_', '');
          console.log('Showing traffic for service ID:', serviceId);
          await showServiceStatus(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('toggle_service_')) {
          const serviceId = data.replace('toggle_service_', '');
          console.log('Toggling service with ID:', serviceId);
          await toggleServiceStatus(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('reset_link_')) {
          const serviceId = data.replace('reset_link_', '');
          console.log('Reset link confirmation for service ID:', serviceId);
          await showResetLinkConfirmation(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('confirm_reset_')) {
          const serviceId = data.replace('confirm_reset_', '');
          console.log('Confirming reset link for service ID:', serviceId);
          await processResetLink(chatId, messageId, serviceId, safeKV);
        }
        else if (data.startsWith('approve_payment_') && isAdmin(chatId)) {
          const orderId = data.replace('approve_payment_', '');
          await approvePayment(chatId, messageId, orderId, safeKV);
        }
        else if (data.startsWith('services_page_')) {
          const page = parseInt(data.replace('services_page_', ''));
          await showMyServices(chatId, messageId, safeKV, page);
        }
        else if (data === 'current_page') {
          // Ø§ÛŒÙ† Ø¯Ú©Ù…Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŒ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³Øª
        }
        else if (data.startsWith('reject_payment_') && isAdmin(chatId)) {
          const orderId = data.replace('reject_payment_', '');
          await rejectPaymentByAdmin(chatId, messageId, orderId, safeKV);
        }
        else if (data.startsWith('approve_charge_') && isAdmin(chatId)) {
          const chargeId = data.replace('approve_charge_', '');
          await approveCharge(chatId, messageId, chargeId, safeKV);
        }
        else if (data.startsWith('reject_charge_') && isAdmin(chatId)) {
          const chargeId = data.replace('reject_charge_', '');
          await rejectCharge(chatId, messageId, chargeId, safeKV);
        }
        // Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ù¾Ù„Ù† Ø¨Ù‡ Ø¨Ø§Ù„Ø§
else if (data.startsWith('move_plan_up_') && isAdmin(chatId)) {
  const planId = data.replace('move_plan_up_', '');
  const result = await reorderPlans(planId, 'up', safeKV);
  
  if (result.success) {
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ ØµÙØ­Ù‡
    const plans = await getPlans(safeKV);
    const sortedPlans = getSortedPlans(plans);
    
    let plansText = `ğŸ“¦ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§</b>

ğŸ“‹ <b>Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:</b> ${Object.keys(plans).length} Ø¹Ø¯Ø¯

`;

    const plansKeyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    sortedPlans.forEach((plan, index) => {
      plansText += `${index + 1}. <b>${plan.name}</b>
ğŸ’° Ù‚ÛŒÙ…Øª: ${formatPrice(plan.price)}
â° Ù…Ø¯Øª: ${plan.duration} Ø±ÙˆØ²
ğŸ“Š Ø­Ø¬Ù…: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}

`;

      const moveButtons = [];
      if (index > 0) {
        moveButtons.push({ text: 'â¬†ï¸', callback_data: `move_plan_up_${plan.id}` });
      }
      if (index < sortedPlans.length - 1) {
        moveButtons.push({ text: 'â¬‡ï¸', callback_data: `move_plan_down_${plan.id}` });
      }
      
      plansKeyboard.reply_markup.inline_keyboard.push([
        ...moveButtons,
        { text: `âœï¸ ${plan.name}`, callback_data: `edit_plan_${plan.id}` }
      ]);
    });

    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù†', callback_data: 'admin_add_plan' }
    ]);
    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'ğŸ§ª ØªØ³Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§', callback_data: 'admin_test_plans' }
    ]);
    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
    ]);

    await editMessage(chatId, messageId, plansText, plansKeyboard);
  } else {
    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
    await editMessage(chatId, messageId, `âŒ Ø®Ø·Ø§: ${result.error}`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: 'admin_plans' }]
        ]
      }
    });
  }
}

// Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ Ù¾Ù„Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†  
else if (data.startsWith('move_plan_down_') && isAdmin(chatId)) {
  const planId = data.replace('move_plan_down_', '');
  const result = await reorderPlans(planId, 'down', safeKV);
  
  if (result.success) {
    // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÙˆØ±ÛŒ ØµÙØ­Ù‡ (Ù‡Ù…Ø§Ù† Ú©Ø¯ Ø¨Ø§Ù„Ø§)
    const plans = await getPlans(safeKV);
    const sortedPlans = getSortedPlans(plans);
    
    let plansText = `ğŸ“¦ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§</b>

ğŸ“‹ <b>Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:</b> ${Object.keys(plans).length} Ø¹Ø¯Ø¯

`;

    const plansKeyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    sortedPlans.forEach((plan, index) => {
      plansText += `${index + 1}. <b>${plan.name}</b>
ğŸ’° Ù‚ÛŒÙ…Øª: ${formatPrice(plan.price)}
â° Ù…Ø¯Øª: ${plan.duration} Ø±ÙˆØ²
ğŸ“Š Ø­Ø¬Ù…: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}

`;

      const moveButtons = [];
      if (index > 0) {
        moveButtons.push({ text: 'â¬†ï¸', callback_data: `move_plan_up_${plan.id}` });
      }
      if (index < sortedPlans.length - 1) {
        moveButtons.push({ text: 'â¬‡ï¸', callback_data: `move_plan_down_${plan.id}` });
      }
      
      plansKeyboard.reply_markup.inline_keyboard.push([
        ...moveButtons,
        { text: `âœï¸ ${plan.name}`, callback_data: `edit_plan_${plan.id}` }
      ]);
    });

    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù†', callback_data: 'admin_add_plan' }
    ]);
    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
    ]);

    await editMessage(chatId, messageId, plansText, plansKeyboard);
  } else {
    await editMessage(chatId, messageId, `âŒ Ø®Ø·Ø§: ${result.error}`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: 'admin_plans' }]
        ]
      }
    });
  }
}
        else if (data === 'admin_panel' && isAdmin(chatId)) {
          const adminText = `âš™ï¸ <b>Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ARDISK VPN</b>

        ğŸ”§ <b>Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ…</b>

        Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:`;

          const adminKeyboard = {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ“Š Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…', callback_data: 'admin_stats' },
                  { text: 'ğŸ’³ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§', callback_data: 'admin_payments' }
                ],
                [
                  { text: 'ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', callback_data: 'admin_tickets' },
                  { text: 'ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', callback_data: 'admin_users' }
                ],
                [
                  { text: 'ğŸ“¦ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§', callback_data: 'admin_plans' },
                  { text: 'ğŸ–¥ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§', callback_data: 'admin_servers' }
                ],
                [
                  { text: 'âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', callback_data: 'admin_settings' }
                ],
                [
                  { text: 'ğŸ”™ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }
                ]
              ]
            }
          };

          await editMessage(chatId, messageId, adminText, adminKeyboard);
        }
        else if (data === 'admin_stats' && isAdmin(chatId)) {
          try {
            await editMessage(chatId, messageId, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±...', {});
            
            const revenue = await calculateRevenue(safeKV);
            
            const ordersResult = await safeKV.list('order_ORD_');
            let pendingPayments = 0;
            let totalUsers = new Set();
            
            for (const key of ordersResult.keys.slice(0, 200)) {
              try {
                const order = await safeKV.get(key.name, 'json');
                if (order) {
                  totalUsers.add(order.chatId);
                  if (order.status === 'payment_submitted') {
                    pendingPayments++;
                  }
                }
              } catch (e) {}
            }
            
            const servicesResult = await safeKV.list('service_');
            let activeServices = 0;
            let expiredServices = 0;
            const now = Date.now();
            
            for (const key of servicesResult.keys.slice(0, 100)) {
              try {
                const service = await safeKV.get(key.name, 'json');
                if (service) {
                  if (service.expireTimestamp > now) {
                    activeServices++;
                  } else {
                    expiredServices++;
                  }
                }
              } catch (e) {}
            }
            
            const ticketsResult = await safeKV.list('ticket_');
            let openTickets = 0;
            for (const key of ticketsResult.keys.slice(0, 50)) {
              try {
                const ticket = await safeKV.get(key.name, 'json');
                if (ticket && ticket.status === 'open') {
                  openTickets++;
                }
              } catch (e) {}
            }

            const statsText = `ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</b>

        ğŸ’° <b>Ø¯Ø±Ø¢Ù…Ø¯:</b>
        â€¢ Ø§Ù…Ø±ÙˆØ²: ${formatPrice(revenue.todayRevenue)}
        â€¢ Ú©Ù„: ${formatPrice(revenue.totalRevenue)}

        ğŸ›’ <b>Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§:</b>
        â€¢ Ø§Ù…Ø±ÙˆØ²: ${revenue.todayOrders} Ø¹Ø¯Ø¯
        â€¢ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: ${pendingPayments} Ø¹Ø¯Ø¯

        ğŸ‘¥ <b>Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</b>
        â€¢ Ú©Ù„: ${totalUsers.size} Ù†ÙØ±

        ğŸ“± <b>Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:</b>
        â€¢ ÙØ¹Ø§Ù„: ${activeServices} Ø¹Ø¯Ø¯
        â€¢ Ù…Ù†Ù‚Ø¶ÛŒ: ${expiredServices} Ø¹Ø¯Ø¯

        ğŸ« <b>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§:</b>
        â€¢ Ø¨Ø§Ø²: ${openTickets} Ø¹Ø¯Ø¯

        ğŸ• <b>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:</b> ${formatDateTime(Date.now())}`;

            const statsKeyboard = {
              reply_markup: {
                inline_keyboard: [
                  [
                    { text: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', callback_data: 'admin_stats' }
                  ],
                  [
                    { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
                  ]
                ]
              }
            };

            await editMessage(chatId, messageId, statsText, statsKeyboard);
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
                ]
              }
            });
          }
        }
        else if (data === 'admin_payments' && isAdmin(chatId)) {
          try {
            await editMessage(chatId, messageId, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§...', {});
            
            const ordersResult = await safeKV.list('order_ORD_');
            const pendingPayments = [];
            const chargesResult = await safeKV.list('wallet_charge_');
            const pendingCharges = [];

            for (const key of ordersResult.keys.slice(0, 50)) {
              try {
                const order = await safeKV.get(key.name, 'json');
                if (order && order.status === 'payment_submitted') {
                  pendingPayments.push(order);
                }
              } catch (e) {}
            }

            for (const key of chargesResult.keys.slice(0, 20)) {
              try {
                const charge = await safeKV.get(key.name, 'json');
                if (charge && charge.status === 'payment_submitted') {
                  pendingCharges.push(charge);
                }
              } catch (e) {}
            }

            let paymentsText = `ğŸ’³ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§</b>

        ğŸ”´ <b>Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯:</b> ${pendingPayments.length + pendingCharges.length} Ù…ÙˆØ±Ø¯

        `;

            const paymentsKeyboard = {
              reply_markup: {
                inline_keyboard: []
              }
            };

            if (pendingPayments.length > 0) {
              paymentsText += `\nğŸ›’ <b>Ø³ÙØ§Ø±Ø´â€ŒÙ‡Ø§ (${pendingPayments.length}):</b>\n`;
              
              pendingPayments.slice(0, 8).forEach((payment, index) => {
                paymentsText += `${index + 1}. ${payment.plan.name} - ${formatPrice(payment.plan.price)}\n`;
                paymentsKeyboard.reply_markup.inline_keyboard.push([{
                  text: `âœ… ØªØ£ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´ ${index + 1}`,
                  callback_data: `admin_approve_${payment.id}`
                }, {
                  text: `âŒ Ø±Ø¯ ${index + 1}`,
                  callback_data: `admin_reject_${payment.id}`
                }]);
              });
            }

            if (pendingCharges.length > 0) {
              paymentsText += `\nğŸ’° <b>Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„ (${pendingCharges.length}):</b>\n`;
              
              pendingCharges.slice(0, 5).forEach((charge, index) => {
                paymentsText += `${index + 1}. Ø´Ø§Ø±Ú˜ ${formatPrice(charge.amount)}\n`;
                paymentsKeyboard.reply_markup.inline_keyboard.push([{
                  text: `âœ… ØªØ£ÛŒÛŒØ¯ Ø´Ø§Ø±Ú˜ ${index + 1}`,
                  callback_data: `admin_approve_charge_${charge.id}`
                }, {
                  text: `âŒ Ø±Ø¯ Ø´Ø§Ø±Ú˜ ${index + 1}`,
                  callback_data: `admin_reject_charge_${charge.id}`
                }]);
              });
            }

            if (pendingPayments.length === 0 && pendingCharges.length === 0) {
              paymentsText += 'âœ… Ù‡ÛŒÚ† Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!';
            }

            paymentsKeyboard.reply_markup.inline_keyboard.push([
              { text: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', callback_data: 'admin_payments' }
            ]);
            paymentsKeyboard.reply_markup.inline_keyboard.push([
              { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
            ]);

            await editMessage(chatId, messageId, paymentsText, paymentsKeyboard);
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
                ]
              }
            });
          }
        }
        else if (data === 'admin_tickets' && isAdmin(chatId)) {
          try {
            await editMessage(chatId, messageId, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§...', {});
            
            const ticketsResult = await safeKV.list('ticket_');
            const openTickets = [];
            const recentClosed = [];

            for (const key of ticketsResult.keys.slice(0, 50)) {
              try {
                const ticket = await safeKV.get(key.name, 'json');
                if (ticket) {
                  if (ticket.status === 'open') {
                    openTickets.push(ticket);
                  } else if (ticket.closedAt && Date.now() - ticket.closedAt < 7 * 24 * 60 * 60 * 1000) {
                    recentClosed.push(ticket);
                  }
                }
              } catch (e) {}
            }

            let ticketsText = `ğŸ« <b>Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§</b>

        ğŸŸ¢ <b>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²:</b> ${openTickets.length} Ø¹Ø¯Ø¯
        ğŸ”´ <b>Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ (7 Ø±ÙˆØ² Ø§Ø®ÛŒØ±):</b> ${recentClosed.length} Ø¹Ø¯Ø¯

        `;

            const ticketsKeyboard = {
              reply_markup: {
                inline_keyboard: []
              }
            };

            if (openTickets.length > 0) {
              ticketsText += '\nğŸŸ¢ <b>ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²:</b>\n';
              
              openTickets.slice(0, 8).forEach((ticket, index) => {
                ticketsText += `${index + 1}. ${ticket.typeName} - Ú©Ø§Ø±Ø¨Ø±: ${ticket.chatId}\n`;
                ticketsKeyboard.reply_markup.inline_keyboard.push([{
                  text: `ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øª ${index + 1}`,
                  callback_data: `admin_view_ticket_${ticket.id}`
                }]);
              });
            } else {
              ticketsText += 'âœ… Ù‡ÛŒÚ† ØªÛŒÚ©Øª Ø¨Ø§Ø²ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!';
            }

            ticketsKeyboard.reply_markup.inline_keyboard.push([
              { text: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', callback_data: 'admin_tickets' }
            ]);
            ticketsKeyboard.reply_markup.inline_keyboard.push([
              { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
            ]);

            await editMessage(chatId, messageId, ticketsText, ticketsKeyboard);
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
                ]
              }
            });
          }
        }
        else if (data === 'admin_users' && isAdmin(chatId)) {
          try {
            await editMessage(chatId, messageId, 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...', {});
            
            const users = new Map();
            
            const servicesResult = await safeKV.list('service_');
            for (const key of servicesResult.keys.slice(0, 100)) {
              try {
                const service = await safeKV.get(key.name, 'json');
                if (service && service.chatId) {
                  if (!users.has(service.chatId)) {
                    users.set(service.chatId, {
                      chatId: service.chatId,
                      services: 0,
                      orders: 0,
                      totalPaid: 0,
                      lastActivity: 0
                    });
                  }
                  users.get(service.chatId).services++;
                  users.get(service.chatId).lastActivity = Math.max(
                    users.get(service.chatId).lastActivity,
                    service.createdAt
                  );
                }
              } catch (e) {}
            }
            
            const ordersResult = await safeKV.list('order_ORD_');
            for (const key of ordersResult.keys.slice(0, 200)) {
              try {
                const order = await safeKV.get(key.name, 'json');
                if (order && order.chatId) {
                  if (!users.has(order.chatId)) {
                    users.set(order.chatId, {
                      chatId: order.chatId,
                      services: 0,
                      orders: 0,
                      totalPaid: 0,
                      lastActivity: 0
                    });
                  }
                  users.get(order.chatId).orders++;
                  if (order.status === 'completed') {
                    users.get(order.chatId).totalPaid += order.plan.price;
                  }
                  users.get(order.chatId).lastActivity = Math.max(
                    users.get(order.chatId).lastActivity,
                    order.createdAt
                  );
                }
              } catch (e) {}
            }

            const topUsers = Array.from(users.values())
              .sort((a, b) => b.totalPaid - a.totalPaid)
              .slice(0, 15);

            let usersText = `ğŸ‘¥ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</b>

        ğŸ“Š <b>Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</b> ${users.size} Ù†ÙØ±

        ğŸ’ <b>Ø¨Ø±ØªØ±ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:</b>

        `;

            topUsers.forEach((user, index) => {
              usersText += `${index + 1}. Ú©Ø§Ø±Ø¨Ø±: <code>${user.chatId}</code>
        ğŸ’° Ù¾Ø±Ø¯Ø§Ø®Øª: ${formatPrice(user.totalPaid)}
        ğŸ“± Ø³Ø±ÙˆÛŒØ³: ${user.services} | ğŸ›’ Ø³ÙØ§Ø±Ø´: ${user.orders}

        `;
            });

            const usersKeyboard = {
              reply_markup: {
                inline_keyboard: [
                  [
                    { text: 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', callback_data: 'admin_users' }
                  ],
                  [
                    { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
                  ]
                ]
              }
            };

            await editMessage(chatId, messageId, usersText, usersKeyboard);
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
                ]
              }
            });
          }
        }
        // Ø¯Ø± Ù‚Ø³Ù…Øª callback query handlers Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ú©Ù†:
else if (data === 'admin_plans' && isAdmin(chatId)) {
  try {
    const plans = await getPlans(safeKV);
    const sortedPlans = getSortedPlans(plans);
    
    let plansText = `ğŸ“¦ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù„Ù†â€ŒÙ‡Ø§</b>

ğŸ“‹ <b>Ù¾Ù„Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„:</b> ${Object.keys(plans).length} Ø¹Ø¯Ø¯

`;

    const plansKeyboard = {
      reply_markup: {
        inline_keyboard: []
      }
    };

    sortedPlans.forEach((plan, index) => {
      plansText += `${index + 1}. <b>${plan.name}</b>
ğŸ’° Ù‚ÛŒÙ…Øª: ${formatPrice(plan.price)}
â° Ù…Ø¯Øª: ${plan.duration} Ø±ÙˆØ²
ğŸ“Š Ø­Ø¬Ù…: ${plan.dataLimit ? plan.dataLimit + ' Ú¯ÛŒÚ¯' : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯'}

`;

      // Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ
      const moveButtons = [];
      if (index > 0) {
        moveButtons.push({ text: 'â¬†ï¸', callback_data: `move_plan_up_${plan.id}` });
      }
      if (index < sortedPlans.length - 1) {
        moveButtons.push({ text: 'â¬‡ï¸', callback_data: `move_plan_down_${plan.id}` });
      }
      
      plansKeyboard.reply_markup.inline_keyboard.push([
        ...moveButtons,
        { text: `âœï¸ ${plan.name}`, callback_data: `edit_plan_${plan.id}` }
      ]);
    });

    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'â• Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ù„Ù†', callback_data: 'admin_add_plan' }
    ]);
    plansKeyboard.reply_markup.inline_keyboard.push([
      { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
    ]);

    await editMessage(chatId, messageId, plansText, plansKeyboard);
  } catch (error) {
    await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù¾Ù„Ù†â€ŒÙ‡Ø§', {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
        ]
      }
    });
  }
}

else if (data === 'admin_test_plans' && isAdmin(chatId)) {
  await initializePlanOrders(safeKV);
  const plans = await getPlans(safeKV);
  
  let testText = `ğŸ§ª <b>ØªØ³Øª Ù¾Ù„Ù†â€ŒÙ‡Ø§</b>

`;
  
  Object.values(plans).forEach(plan => {
    testText += `ğŸ“‹ ${plan.name} - Order: ${plan.order || 'Ù†Ø¯Ø§Ø±Ø¯'}\n`;
  });
  
  const testKeyboard = {
    reply_markup: {
      inline_keyboard: [
        [{ text: 'ğŸ”§ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Order', callback_data: 'init_plan_orders' }],
        [{ text: 'ğŸ“¦ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù¾Ù„Ù†â€ŒÙ‡Ø§', callback_data: 'admin_plans' }]
      ]
    }
  };
  
  await editMessage(chatId, messageId, testText, testKeyboard);
}

// Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø³ØªÛŒ
else if (data === 'init_plan_orders' && isAdmin(chatId)) {
  const result = await initializePlanOrders(safeKV);
  
  if (result.success) {
    await editMessage(chatId, messageId, 'âœ… Order Ù¾Ù„Ù†â€ŒÙ‡Ø§ Ø§ÙˆÙ„ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯!', {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ“¦ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ù„Ù†â€ŒÙ‡Ø§', callback_data: 'admin_plans' }]
        ]
      }
    });
  } else {
    await editMessage(chatId, messageId, `âŒ Ø®Ø·Ø§: ${result.error}`, {
      reply_markup: {
        inline_keyboard: [
          [{ text: 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', callback_data: 'admin_plans' }]
        ]
      }
    });
  }
}

        else if (data === 'admin_servers' && isAdmin(chatId)) {
          try {
            const servers = await getServers(safeKV);
            
            let serversText = `ğŸ–¥ï¸ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ø³Ø±ÙˆØ±Ù‡Ø§</b>

        ğŸ–¥ï¸ <b>Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„:</b> ${Object.keys(servers).length} Ø¹Ø¯Ø¯

        `;

            Object.values(servers).forEach((server, index) => {
              serversText += `${index + 1}. <b>${server.name}</b> ${server.isDefault ? 'â­' : ''}
        ğŸŒ Ù…ÙˆÙ‚Ø¹ÛŒØª: ${server.location}
        ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ${server.status === 'active' ? 'ÙØ¹Ø§Ù„ âœ…' : 'ØºÛŒØ±ÙØ¹Ø§Ù„ âŒ'}

        `;
            });

            const serversKeyboard = {
              reply_markup: {
                inline_keyboard: [
                  [
                    { text: 'â• Ø§ÙØ²ÙˆØ¯Ù† Ø³Ø±ÙˆØ±', callback_data: 'admin_add_server' }
                  ],
                  [
                    { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
                  ]
                ]
              }
            };

            await editMessage(chatId, messageId, serversText, serversKeyboard);
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø³Ø±ÙˆØ±Ù‡Ø§', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }]
                ]
              }
            });
          }
        }
        else if (data === 'admin_settings' && isAdmin(chatId)) {
          const settingsText = `âš™ï¸ <b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</b>

        ğŸ”§ <b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ:</b>

        ğŸ’³ <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±Ø¯Ø§Ø®Øª:</b>
        â€¢ Ú©Ø§Ø±Øª: <code>${PAYMENT_INFO.cardNumber}</code>
        â€¢ Ù†Ø§Ù…: ${PAYMENT_INFO.cardHolder}
        â€¢ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ: @${PAYMENT_INFO.supportUsername}

        ğŸ¯ <b>Ø¹Ù…Ù„ÛŒØ§Øª:</b>`;

          const settingsKeyboard = {
            reply_markup: {
              inline_keyboard: [
                [
                  { text: 'ğŸ”„ Ø±ÛŒØ³Øª Ú©Ø´', callback_data: 'admin_clear_cache' }
                ],
                [
                  { text: 'ğŸ“Š Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ', callback_data: 'admin_backup' }
                ],
                [
                  { text: 'ğŸ”™ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª', callback_data: 'admin_panel' }
                ]
              ]
            }
          };

          await editMessage(chatId, messageId, settingsText, settingsKeyboard);
        }
        else if (data.startsWith('admin_approve_') && isAdmin(chatId)) {
          const orderId = data.replace('admin_approve_', '');
          await approvePayment(chatId, messageId, orderId, safeKV);
        }
        else if (data.startsWith('admin_reject_') && isAdmin(chatId)) {
          const orderId = data.replace('admin_reject_', '');
          await rejectPaymentByAdmin(chatId, messageId, orderId, safeKV);
        }
        else if (data.startsWith('admin_approve_charge_') && isAdmin(chatId)) {
          const chargeId = data.replace('admin_approve_charge_', '');
          await approveCharge(chatId, messageId, chargeId, safeKV);
        }
        else if (data === 'admin_clear_cache' && isAdmin(chatId)) {
          try {
            safeKV.clearAll();
            
            await editMessage(chatId, messageId, 'âœ… <b>Cache Ù¾Ø§Ú© Ø´Ø¯!</b>\n\nğŸ”„ Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯\nâš¡ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØª', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', callback_data: 'admin_settings' }]
                ]
              }
            });
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† cache!', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', callback_data: 'admin_settings' }]
                ]
              }
            });
          }
        }
        else if (data.startsWith('admin_reject_charge_') && isAdmin(chatId)) {
          const chargeId = data.replace('admin_reject_charge_', '');
          await rejectCharge(chatId, messageId, chargeId, safeKV);
        }
        else if (data.startsWith('admin_view_ticket_') && isAdmin(chatId)) {
          const ticketId = data.replace('admin_view_ticket_', '');
          
          try {
            const ticketsResult = await safeKV.list('ticket_');
            let ticketData = null;
            
            for (const key of ticketsResult.keys) {
              const ticket = await safeKV.get(key.name, 'json');
              if (ticket && ticket.id === ticketId) {
                ticketData = ticket;
                break;
              }
            }

            if (ticketData) {
              let ticketText = `ğŸ« <b>Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª</b>

        ğŸ†” Ø´Ù…Ø§Ø±Ù‡: <code>${ticketData.id}</code>
        ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: <code>${ticketData.chatId}</code>
        ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: ${ticketData.typeName}
        ğŸ“… ØªØ§Ø±ÛŒØ®: ${formatDate(ticketData.createdAt)}
        ğŸ”¸ ÙˆØ¶Ø¹ÛŒØª: ${ticketData.status === 'open' ? 'ğŸŸ¢ Ø¨Ø§Ø²' : 'ğŸ”´ Ø¨Ø³ØªÙ‡'}

        ğŸ“„ <b>Ù¾ÛŒØ§Ù… Ø§ØµÙ„ÛŒ:</b>
        ${ticketData.message}

        ğŸ’¬ <b>Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§:</b> ${ticketData.messages.length} Ø¹Ø¯Ø¯`;

              const ticketKeyboard = {
                reply_markup: {
                  inline_keyboard: [
                    [
                      { text: 'ğŸ’¬ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù†', callback_data: `admin_reply_ticket_${ticketId}` },
                      { text: 'ğŸ”’ Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª', callback_data: `admin_close_ticket_${ticketId}` }
                    ],
                    [
                      { text: 'ğŸ”™ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', callback_data: 'admin_tickets' }
                    ]
                  ]
                }
              };

              await editMessage(chatId, messageId, ticketText, ticketKeyboard);
            } else {
              await editMessage(chatId, messageId, 'âŒ ØªÛŒÚ©Øª ÛŒØ§ÙØª Ù†Ø´Ø¯!', {
                reply_markup: {
                  inline_keyboard: [
                    [{ text: 'ğŸ”™ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', callback_data: 'admin_tickets' }]
                  ]
                }
              });
            }
          } catch (error) {
            await editMessage(chatId, messageId, 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ©Øª', {
              reply_markup: {
                inline_keyboard: [
                  [{ text: 'ğŸ”™ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§', callback_data: 'admin_tickets' }]
                ]
              }
            });
          }
        }
        else if (data.startsWith('admin_close_ticket_') && isAdmin(chatId)) {
          const ticketId = data.replace('admin_close_ticket_', '');
          await closeTicketByAdmin(chatId, messageId, ticketId, safeKV);
        }
        else if (data.startsWith('get_config_')) {
          const serviceId = data.replace('get_config_', '');
          console.log('Getting config for service ID:', serviceId);
          await showServiceManagement(chatId, messageId, serviceId, safeKV, true);
        }
        else if (data === 'cancel_order') {
          await editMessage(chatId, messageId, 'âŒ Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯.', KEYBOARDS.backToMain);
        }
        else if (data === 'admin_retest_system' && isAdmin(chatId)) {
          await testVPNSystem(chatId, safeKV);
        }
        else if (data === 'admin_force_cron' && isAdmin(chatId)) {
          await forceRunCronJob(chatId, messageId, safeKV);
        }
        else if (data === 'admin_full_test' && isAdmin(chatId)) {
          await testVPNSystem(chatId, safeKV);
        }
        else if (data === 'test_received' && isAdmin(chatId)) {
          await editMessage(chatId, messageId, 'âœ… ØªØ³Øª Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!', {
            reply_markup: {
              inline_keyboard: [
                [{ text: 'ğŸ  Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ', callback_data: 'start' }]
              ]
            }
          });
        }
      }
      
      return new Response('OK', { status: 200 });
      
    } catch (error) {
      console.error('Sales Bot Worker Error:', error);
      // Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ØŒ ÛŒÚ© Ù¾Ø§Ø³Ø® Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†ÛŒØ¯ ØªØ§ Ø§Ø² ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø´ÙˆØ¯
      return new Response('Error processed', { status: 200 });
    }
  },

  // Cron Job Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ - Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡
  async scheduled(controller, env, ctx) {
    const safeKV = new SafeKV(env?.KV_B);
    
    // Ø§Ø¬Ø±Ø§ÛŒ cron job Ù‡Ø± 10 Ø¯Ù‚ÛŒÙ‚Ù‡
    if (controller.cron === "*/10 * * * *") {
      try {
        console.log('Starting scheduled expiry check...');
        await checkExpiringServices(safeKV);
        console.log('Scheduled expiry check finished.');
      } catch (error) {
        console.error('Error during scheduled task:', error);
      }
    }
  }
};
